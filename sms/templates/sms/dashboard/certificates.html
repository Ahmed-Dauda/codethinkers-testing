{% extends 'sms/dashboard/base.html' %}
{% load hitcount_tags %}

{% block title %} Print your Certificate {% endblock %}

{% block content %} 

<div class="container py-5">
  
  <!-- Contact Button -->
  <div class="text-end mb-4">
    <a href="https://wa.me/23409031568177" class="btn btn-success shadow-sm">
      📞 Contact Us
    </a>
  </div>

  <!-- Certificate Count -->
  <div class="card shadow-lg border-0 rounded-3 mb-5">
    <div class="card-body text-center">
      <h2 class="fw-bold text-primary">
        {{ hitcount.total_hits }} Certificates Printed
      </h2>
    </div>
  </div>

  <!-- Results Table -->
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-body">
      {% if results %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Names</th>
                <th>Email</th>
                <th>Exam Name</th>
                <th>Max Score</th>
              </tr>
            </thead>
            <tbody>
              {% for t in results %}
                <tr>
                  <td>{{ t.student.first_name }} {{ t.student.last_name }}</td>
                  <td>{{ t.student.user }}</td>
                  <td>{{ t.exam }}</td>
                  <td>{{ t.marks }}</td>

                  {% for course in courses %}
                    {% if course == t.exam %}
                      {% if t.marks >= course.pass_mark %}
                        
                        <!-- Success Message -->
                        <td colspan="4" class="text-center">
                          <div class="alert alert-success mt-3">
                            🎉 Congratulations, 
                            <strong>{{ request.user.profile.first_name }}</strong>!
                            You’ve successfully passed the exam.
                          </div>

                          <!-- Payment Form -->
                          <form id="paymentForm" action="" method="POST" class="d-inline">
                            <input value="{{ request.user.email }}" type="hidden" id="email-address" required />
                            {% if course.course_name.cert_price %}
                              <input value="{{ course.course_name.cert_price|safe }}" type="hidden" id="amount" required />
                            {% else %}
                              <input value="{{ course.course_name.price|safe }}" type="hidden" id="amount" required />
                            {% endif %}

                            {% if related_payments.exists or course_payments.exists or school_name %}
                              <a href="{% url 'student:pdf_id_view' course.id %}" class="btn btn-outline-primary shadow-sm mt-2">
                                📄 Print Certificate
                              </a>
                            {% elif qcourse.course_name.cert_price == None and qcourse.course_name.price == None or school_name %}
                              <a href="{% url 'student:pdf_id_view' course.id %}" class="btn btn-outline-primary shadow-sm mt-2">
                                📄 Print Certificate
                              </a>
                            {% else %}
                              {% if course.course_name.cert_price %}
                                <button class="btn btn-primary shadow-sm mt-2" type="submit" id="purchasebtn" onclick="payWithPaystack()">
                                  💳 Pay ₦{{course.course_name.cert_price|safe}} to Print Certificate
                                </button>
                              {% else %}
                                <button class="btn btn-primary shadow-sm mt-2" type="submit" id="purchasebtn" onclick="payWithPaystack()">
                                  💳 Pay ₦{{course.course_name.price|safe}} to Print Certificate
                                </button>
                              {% endif %}
                            {% endif %}
                          </form>
                        </td>

                      {% else %}
                        <!-- Fail Message -->
                        <td colspan="4" class="text-center">
                          <div class="alert alert-danger mt-3">
                            ❌ Pass mark is <strong>{{ course.pass_mark }}</strong>. You’re close! Try again.
                          </div>
                          <a href="{% url 'student:take-exam' %}" class="btn btn-warning shadow-sm">
                            🔁 Retake Exam
                          </a>
                        </td>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-warning text-center p-4">
          <p class="mb-2">⚠️ No exam record found</p>
          <a href="{% url 'student:take-exam' %}" class="btn btn-primary shadow-sm">
            📝 Take Exam
          </a>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- Paystack Script -->
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
const paymentForm = document.getElementById('paymentForm');
paymentForm.addEventListener("submit", payWithPaystack, false);

function payWithPaystack(e) {
  e.preventDefault();

  let handler = PaystackPop.setup({
    key: '{{paystack_public_key}}',
    email: document.getElementById("email-address").value,
    amount: document.getElementById("amount").value * 100,
    ref: ''+Math.floor((Math.random() * 1000000000) + 1),
    onClose: function(){ alert('Payment window closed.'); },
    callback: function (response) {
      window.location.href = "{% url 'student:view_result' %}";
    }
  });

  handler.openIframe();
}
</script>

{% endblock %}
