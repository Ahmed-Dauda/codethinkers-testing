{% extends 'sms/dashboard/base.html' %}

{% load hitcount_tags %}

{% block title %} Print your Certificate {% endblock %}

  {% block content %} 


<button class="btn "><a href="https://wa.me/23409031568177"> Contact Us  </a>  </button>

<div class="table-responsive container text-center card-body">
  <h2 class="">{{ hitcount.total_hits }} Certificates printed on this course</2> <br> <br>
  <table class="table" id=""> 
    {% for course in courses %}
    {% if course == t.exam %}
        {% if t.marks >= course.pass_mark %}
   
    {% else %}
    <div><a href="{% url 'student:take-exam' %}">Take Exam</a></div><br>
       {% endif %}
    {% endif %}
    {% endfor %}
    <thead>
      <tr>
        <th>Names</th>
        <th>Email</th>
   
        <th>Exam Name</th>
        <th>Max Score</th>

       
      </tr>
    </thead>
   
 <tbody>
    <tr>
      
        {% for t in results %}
            <td>{{ t.student.first_name }} {{ t.student.last_name }}</td>
            <td>{{ t.student.user }}</td>
            <td>{{ t.exam }}</td>
            <td>{{ t.marks }}</td>

            {% for course in courses %}
                {% if course == t.exam %}
                    {% if t.marks >= course.pass_mark %}
                             
    <p style="color: green;">You passed the exam. Congratulations, {{ request.user.profile.first_name }}!</p>
                        <form id="paymentForm" action="" method="post">
                            <div class="form-group">
                                <input value='{{ request.user }}' type="hidden" id="email-address" required />
                            </div>
                            <div class="form-group">
                                <input value="{{ course.cert_price|safe }}" type="hidden" id="amount" required />
                            </div>
                            <div class="form-submit">
                            </div>
                

                

            {% if not related_payments.exists %}
            <button class="btn btn-primary" type="submit"  id="purchasebtn" onclick="payWithPaystack()"> Pay #{{ course.cert_price|safe }} Now to Print Certificate</button>
            {% else %}

            
            <a href="{% url 'student:pdf' course.id %}"> PRINT {{ course }} CERTIFICATE</a><br>

            {% endif %}

                  
                        </form>
                        <script src="https://js.paystack.co/v1/inline.js"></script>
                    {% for payment in related_payments %}
                     
              
                    {% if payment.content_type == "certificates" and  payment.email == request.user %}
                    {% for ccourse in payment.courses.all %}
                    <li>yyyy{{ payment.email }}</li>  g {{ request.user }}
               

                    {% if payment.amount == course.course_name.price  and ccourse.title == course.course_name.title  %}
                        <p>{{ hitcount.total_hits }} Certificates printed on this course</p>
                        <a href="{% url 'student:pdf' course.id %}"> PRINT {{ course }} CERTIFICATE</a><br>
                    {% else %}
                       
                       
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    {% endfor %}

                    {% else %}
                        <h4 style="color: red">Passed mark: {{ course.pass_mark }}. You are close to getting your Certificate. Please try again</h4>
                    {% endif %}
                {% endif %}
            {% endfor %}

        {% endfor %}
    </tr>
</tbody>

  <hr>
</table>


</div>

<!-- End of Main Content -->



<script>

  

const paymentForm = document.getElementById('paymentForm');
paymentForm.addEventListener("submit", payWithPaystack, false);

function payWithPaystack(e) {
  e.preventDefault();

  let handler = PaystackPop.setup({
    key: '{{paystack_public_key}}', // Replace with your public key
    email: document.getElementById("email-address").value,
    amount: document.getElementById("amount").value * 100,
    ref: ''+Math.floor((Math.random() * 1000000000) + 1), // generates a pseudo-unique reference. Please replace with a reference you generated. Or remove the line entirely so our API will generate one for you
    // label: "Optional string that replaces customer email"
    onClose: function(){
      alert('Window closed.');
    },
    
         callback: function (response) {
          // If transaction successful, do this
          var referenceid = response.reference;
          window.location.href = "{% url 'student:view_result' %}"

          // Set the referenceid value to the ref hidden input field
          // $("#ref").val(referenceid);

          // Make an http request to cart process
          // $.ajax({
          //   type: "GET",
          //   url: "/student/verify/" + referenceid,
          //   beforeSend: function () {
          //     console.log("Sending request");
          //     $(".alert").text("Sending request");
          //   },
          //   success: function (response) {
          //     if (response[3].status == "success") {
          //       // Once transaction completed, redirect to complete page
          //       $(".alert").removeClass("alert-warning");
          //       $(".alert").addClass("alert-success");
          //       $(".alert").text("Transaction verified");
          //       console.log("Transaction verified");
          //       $("form").trigger("reset");
          //     } else {
          //       $(".alert").text("Transaction reference not found");
          //     }
          //   }
          // });
        },
        onClose: function () {
          // Do stuff
        }
      });
  
  handler.openIframe();
}



</script>


{% endblock %} 
 