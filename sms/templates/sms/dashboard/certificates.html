{% extends 'sms/dashboard/base.html' %}
{% load hitcount_tags %}

{% block title %} Print your Certificate {% endblock %}

{% block content %}

<div class="container my-4">

    <div class="text-right mb-3">
        <a href="https://wa.me/23409031568177" class="btn btn-success">Contact Us</a>
    </div>

    <div class="card p-3 mb-4 text-center">
        <h2>{{ hitcount.total_hits }} Certificates Printed</h2>
    </div>

    {% if results %}
        <div class="table-responsive card p-3">
            <table class="table table-hover table-bordered text-center">
                <thead class="thead-dark">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Exam Name</th>
                        <th>Score</th>
                        <th>Certificate</th>
                    </tr>
                </thead>
                <tbody>
                {% for t in results %}
                    <tr>
                        <td>{{ t.student.first_name }} {{ t.student.last_name }}</td>
                        <td>{{ t.student.user.email }}</td>
                        <td>{{ t.exam }}</td>
                        <td>{{ t.marks }}</td>
                        <td>
                            {% for course in courses %}
                                {% if course == t.exam %}
                                    {% if t.marks >= course.pass_mark %}
                                        <p class="text-success mb-2">Congratulations! You've passed.</p>

                                        {% if related_payments.exists or course_payments.exists or school_name %}
                                            <a href="{% url 'student:pdf_id_view' course.id %}" class="btn btn-primary btn-sm">Print Certificate</a>
                                        {% else %}
                                            {% with amount=course.course_name.cert_price|default:course.course_name.price %}
                                            <button class="btn btn-warning btn-sm" type="button"
                                                onclick="payWithPaystack('{{ request.user.email }}', {{ amount }})">
                                                Pay #{{ amount }} & Print
                                            </button>
                                            {% endwith %}
                                        {% endif %}

                                    {% else %}
                                        <p class="text-danger">Passed mark is {{ course.pass_mark }}. Please try again.</p>
                                        <a href="{% url 'student:take-exam' %}" class="btn btn-outline-primary btn-sm">Retake Exam</a>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-danger text-center">
            No exam records found.
            <br>
            <a href="{% url 'student:take-exam' %}" class="btn btn-primary mt-2">Take Exam</a>
        </div>
    {% endif %}

</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
function payWithPaystack(email, amount) {
    let handler = PaystackPop.setup({
        key: '{{ paystack_public_key }}',
        email: email,
        amount: amount * 100, // Convert to kobo
        ref: '' + Math.floor(Math.random() * 1000000000 + 1),
        callback: function(response) {
            window.location.href = "{% url 'student:view_result' %}";
        },
        onClose: function() {
            alert('Payment cancelled.');
        }
    });
    handler.openIframe();
}
</script>

{% endblock %}
