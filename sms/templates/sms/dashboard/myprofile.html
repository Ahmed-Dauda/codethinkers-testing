{% extends 'sms/dashboard/base.html' %}
{% load hitcount_tags %}

{% block title %}My Profile{% endblock %}

{% block content %}

<div class="portlet light bordered card-body">

  <!-- User Profile Info -->
  {% for profile in user_profile %}
  <div class="row list-separated profile-stat">

    <!-- Profile Image & Basic Info -->
    <div class="col-md-4 col-sm-4 col-xs-6 text-center">
      {% if profile.pro_img %}
        <img src="{{ profile.pro_img.url }}" width="100" height="100" class="rounded-circle mb-2" alt="Profile Image">
      {% else %}
        <img src="/static/sms/images/newlogo3.jpg" width="100" height="100" class="rounded-circle mb-2" alt="Default Image">
      {% endif %}
      <hr>
      <p class="font-weight-bold">Names: {{ profile.first_name }} {{ profile.last_name }}</p>
      <p>Last Profile Update: {{ profile.updated|timesince }}</p>
      <p>Sex: {{ profile.gender }}</p>
      <p>Username: {{ profile.username }}</p>
    </div>

    <!-- Contact & Links -->
    <div class="col-md-4 col-sm-4 col-xs-6">
      <p>Email: {{ profile.user }}</p>
      <p>Country: {{ profile.countries }}</p>
      <a class="btn btn-primary mb-2" href="https://wa.me/23409031568177">Customer Support</a>
      
      {% if request.user.is_superuser %}
        <div class="mt-2">
          <a class="btn btn-danger mb-1 d-block" href="{% url 'users:schoolstudentview' %}">School Student View</a>
          <a class="btn btn-secondary d-block" href="{% url 'users:quick_dashboard' %}">Dashboard</a>
        </div>
      {% endif %}
    </div>

    <!-- Additional Info -->
    <div class="col-md-4 col-sm-4 col-xs-6">
      <p>Date Created: {{ profile.created }} ({{ profile.created|timesince }})</p>
      <p>Biography: {{ profile.bio }}</p>
      <hr style="color: rgb(16, 2, 37);">
      <a href="{{ profile.get_absolute_url }}" class="btn btn-outline-primary">Edit Profile</a>
    </div>

  </div>
  {% endfor %}

  <hr>

  <!-- School Name -->
  {% if school_name %}
    <p class="text-danger">School Name: {{ school_name }}</p>
  {% endif %}

  <!-- Navigation -->
  <div class="text-center mb-3">
    <a href="{% url 'sms:homepage' %}">Go to Homepage</a>
  </div>

  <!-- Completed Courses -->
  <h3 class="text-center mb-3">Completed Courses</h3>

  {% for course in courses %}
    {% for course_max_marks in max_marks_per_course %}
      {% if course|lower == course_max_marks.exam__course_name__title|lower %}
        {% if course_max_marks.max_marks >= course.pass_mark %}
          {% if course.course_name.cert_price == None and course.course_name.price == None or school_name %}
            <div class="d-flex align-items-center font-weight-bold mb-1">
              {{ course }}
              <a class="ml-2 btn btn-sm btn-success" href="{% url 'student:pdf_id_view' course.id %}">Download</a>
            </div>
            <p>&#10004; Great Work! You have passed all requirements and can view your course certificate now.</p>
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  <!-- Certificate Payments -->
  {% for certificate_payment in certificate_payments %}
    {% for certificate_pay in certificate_payment.courses.all %}
      <div class="d-flex align-items-center font-weight-bold mb-1">
        {{ certificate_pay }}
        <a class="ml-2 btn btn-sm btn-success" href="{% url 'student:pdf_id_view' certificate_pay.id %}">Download</a>
      </div>
      <p>&#10004; Great Work! You have passed all requirements and can view your course certificate now.</p>
    {% endfor %}
  {% endfor %}

  <hr>

  <!-- Referral Section -->
  <h1 class="text-danger">Referral Details</h1>
  {% if referrer_mentor == 0 %}
    <h3><a href="{% url 'users:become_referrer' %}">Become a Referrer, Click Here</a></h3>
  {% else %}
    <div class="mb-3">
      <p>Your Referral Link:</p>
      <input type="text" id="referralLink" value="{{ request.scheme }}://{{ request.get_host }}{% url 'users:referral_signup' referrer_code=referrer_code %}" readonly>
      <button onclick="copyToClipboard()" class="btn btn-secondary btn-sm">Copy</button>
    </div>

    {% for percentage in percentage_referer %}
      <p class="text-success text-center">Note: Your earning is {{ percentage.referer_per }}% of the certificates purchased</p>
    {% endfor %}

    <!-- Referrer Information Table -->
    <p class="text-danger">Referrer Information</p>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="thead-dark">
          <tr>
            <th>Referral Code</th>
            <th>Purchases</th>
            <th>Total Earnings (#)</th>
            <th>Account Name</th>
            <th>Account Number</th>
            <th>Bank</th>
            <th>Phone Number</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ referrer_mentor.referrer_code }}</td>
            <td>{{ referrer_mentor.f_code_count }}</td>
            <td>{{ total_amount }}</td>
            <td>{{ account_name }}</td>
            <td>{{ account_number }}</td>
            <td>{{ bank }}</td>
            <td>{{ phone_no }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Referred Students Table -->
    <p class="text-danger">Referred Students and Courses</p>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="thead-dark">
          <tr>
            <th>Names</th>
            <th>Amount (#)</th>
            <th>Courses</th>
            <th>Date of Payment</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in referrer_mentor.related_payments %}
            <tr>
              <td>{{ payment.first_name }} {{ payment.last_name }}</td>
              <td>{{ payment.amount }}</td>
              <td>{{ payment.content_type }}</td>
              <td>{{ payment.date_created }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="text-center">No payments found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% endif %}

</div>

<script>
function copyToClipboard() {
    var copyText = document.getElementById("referralLink");
    copyText.select();
    document.execCommand("copy");
    alert("Copied the referral link: " + copyText.value);
}
</script>

{% endblock %}
