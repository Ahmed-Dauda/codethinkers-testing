{% extends 'sms/dashboard/base.html' %}

{% block title %}Add Topics Assessment{% endblock %}

{% block content %}
<div class="container my-5">

    <h2 class="fw-bold mb-3">Add Topics Assessment</h2>
    <p class="text-muted mb-4">Fill out the form to add a new topic assessment. You can search categories and topics by typing keywords.</p>

    <!-- Django messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="card form-card p-4">

        <form method="POST" novalidate class="mb-5">
            {% csrf_token %}

            <!-- Category Field -->
            <div class="mb-3">
                <label for="category" class="fw-semibold mb-1">Category</label>
                <select name="category" id="category" class="form-select select2" required>
                    <option value="">Select a category...</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}"
                            {% if cat.id|stringformat:"s" == form.category.value|stringformat:"s" %}
                                selected
                            {% endif %}>
                            {{ cat }}
                        </option>
                    {% endfor %}
                </select>
                {% if form.category.errors %}
                    <div class="text-danger small">{{ form.category.errors }}</div>
                {% endif %}
            </div>

            <!-- Topic Field -->
            <div class="mb-3">
                <label for="course_name" class="fw-semibold mb-1">Topic</label>
                <select name="course_name" id="course_name" class="form-select select2" required
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        title="Type any part of the topic to search">
                    <option value="">Search and select topic...</option>
                    {% for c in topics %}
                        <option value="{{ c.id }}"
                            {% if c.id|stringformat:"s" == form.course_name.value|stringformat:"s" %}
                                selected
                            {% endif %}>
                            {{ c.title }}
                        </option>
                    {% endfor %}
                </select>
                {% if form.course_name.errors %}
                    <div class="text-danger small">{{ form.course_name.errors }}</div>
                {% endif %}
            </div>

            <!-- Other Fields -->
            {% for field in form %}
                {% if field.name not in 'category course_name' %}
                    <div class="mb-3">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-danger small">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <button type="submit" class="btn btn-primary">Save Assessment</button>
        </form>

        <!-- Existing Assessments Table -->
        <h4 class="mb-3 mt-4">Existing Topic Assessments</h4>
        <a href="{% url 'quiz:generate_ai_questions' %}" class="btn btn-outline-dark mb-3">
            âœ¨ Add Topics Assessment with AI
        </a>

        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Topic</th>
                        <th>Question No.</th>
                        <th>Total Marks</th>
                        <th>Pass Mark</th>
                        <th>Created</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assessment in assessments %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ assessment.course_name.title }}</td>
                            <td>{{ assessment.question_number }}</td>
                            <td>{{ assessment.total_marks }}</td>
                            <td>{{ assessment.pass_mark }}</td>
                            <td>{{ assessment.created|date:"M d, Y" }}</td>
                            <td>
                                <form method="POST" action="{% url 'instructor:delete_topics_assessment' assessment.id %}" 
                                      onsubmit="return confirm('Are you sure you want to delete this assessment?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">No topic assessments added yet.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 with full-text search
    $('.select2').select2({
        placeholder: "Type to search...",
        width: '100%',
        allowClear: true,
        matcher: function(params, data) {
            if ($.trim(params.term) === '') return data;
            if (data.text.toLowerCase().includes(params.term.toLowerCase())) return data;
            return null;
        }
    });

    // Enable Bootstrap tooltip
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
