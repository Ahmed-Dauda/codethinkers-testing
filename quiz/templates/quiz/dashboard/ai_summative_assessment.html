<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
  .form-section {
    max-width: 700px;
    margin: auto;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 0 10px #ddd;
  }

  .form-section h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    font-weight: bold;
    display: block;
    margin-bottom: 6px;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .form-group textarea {
    resize: vertical;
  }

  .question-block {
    background: #fff;
    border: 1px solid #ccc;
    border-left: 4px solid #007BFF;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
  }

  button {
    background-color: #007BFF;
    color: white;
    border: none;
    padding: 12px 25px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background-color: #0056b3;
  }

  .message {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
  }
</style>

<div class="form-section">
  <h2>ü§ñ Generate Final Exam with AI</h2>


  <form method="POST">
    {% csrf_token %}
    <div class="form-group">
      <label for="course">Select Course:</label>
      <select name="course" id="course" required>
        {% for c in courses %}
          <option value="{{ c.id }}" {% if c.id|stringformat:"s" == request.POST.course %}selected{% endif %}>
            {{ c.title }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <div class="form-group">
  <label for="objectives">Learning Objectives:</label>
  <textarea 
      name="objectives" 
      id="objectives" 
      rows="4" 
      placeholder="Example:
- Define variables
- Perform basic arithmetic
- Use print() function
- Identify syntax errors"
      required>{{ request.POST.objectives }}</textarea>
</div>

      <label for="num_questions">Number of Questions:</label>
      <input type="number" name="num_questions" id="num_questions" value="{{ request.POST.num_questions|default:10 }}" min="1" max="20" required>
    </div>

    <div class="form-group">
      <label for="marks">Marks per Question:</label>
      <input type="number" name="marks" id="marks" value="{{ request.POST.marks|default:1 }}" min="1" max="1" required>
    </div>

    <!-- Difficulty Level Dropdown -->
    <div class="form-group">
      <label for="difficulty">Difficulty Level:</label>
      <select id="difficulty" name="difficulty">
        <option value="very_easy" {% if request.POST.difficulty == 'very_easy' %}selected{% endif %}>Very Easy</option>
        <option value="easy" {% if request.POST.difficulty == 'easy' %}selected{% endif %}>Easy</option>
        <option value="medium" {% if request.POST.difficulty == 'medium' %}selected{% endif %}>Medium</option>
        <option value="hard" {% if request.POST.difficulty == 'hard' %}selected{% endif %}>Hard</option>
        <option value="very_hard" {% if request.POST.difficulty == 'very_hard' %}selected{% endif %}>Very Hard</option>
      </select>
    </div>

    <div class="form-group" style="text-align:center;">
      <button type="submit">‚öôÔ∏è Generate AI Questions</button>
    </div>
  </form>
</div>

<!-- AI Loading Progress -->
<div id="ai-loader" style="display:none; margin-bottom:20px;">
  <div style="background:#eee; border-radius:20px; overflow:hidden; height:20px;">
    <div id="ai-progress-bar" 
         style="width:0%; height:100%; background:#007BFF; transition: width 0.3s;">
    </div>
  </div>
  <p style="text-align:center; margin-top:8px; font-weight:bold;">
    ü§ñ Generating AI Questions... Please wait.
  </p>
</div>

{% if preview_questions %}
  <div class="form-section" style="margin-top: 40px;">
    <h3>‚úèÔ∏è Review and Edit Questions Before Saving</h3>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="confirm_save" value="1">
      <input type="hidden" name="course_id" value="{{ course_id }}">
      <input type="hidden" name="marks" value="{{ marks }}">
      <input type="hidden" name="total_questions" value="{{ preview_questions|length }}">
      <input type="hidden" name="difficulty" value="{{ request.POST.difficulty }}">

      {% for q in preview_questions %}
        <div class="question-block">
          <div class="form-group">
            <label>Question {{ forloop.counter }}</label>
            <textarea name="question_{{ forloop.counter }}" rows="2">{{ q.question }}</textarea>
          </div>

          <div class="form-group">
            <label>Option A:</label>
            <input type="text" name="option1_{{ forloop.counter }}" value="{{ q.option1 }}">
          </div>

          <div class="form-group">
            <label>Option B:</label>
            <input type="text" name="option2_{{ forloop.counter }}" value="{{ q.option2 }}">
          </div>

          <div class="form-group">
            <label>Option C:</label>
            <input type="text" name="option3_{{ forloop.counter }}" value="{{ q.option3 }}">
          </div>

          <div class="form-group">
            <label>Option D:</label>
            <input type="text" name="option4_{{ forloop.counter }}" value="{{ q.option4 }}">
          </div>

          <div class="form-group">
            <label>Correct Answer:</label>
            <select name="answer_{{ forloop.counter }}">
              <option value="Option1" {% if q.answer == 'Option1' %}selected{% endif %}>A</option>
              <option value="Option2" {% if q.answer == 'Option2' %}selected{% endif %}>B</option>
              <option value="Option3" {% if q.answer == 'Option3' %}selected{% endif %}>C</option>
              <option value="Option4" {% if q.answer == 'Option4' %}selected{% endif %}>D</option>
            </select>
          </div>
        </div>
      {% endfor %}

      <div class="form-group" style="text-align:center;">
        <button type="submit">‚úÖ Confirm & Save All</button>
      </div>
    </form>
  </div>
{% endif %}

{% if messages %}
  <div class="message">
    {% for message in messages %}
      <p style="color: {% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}black{% endif %};">
        {{ message }}
      </p>
    {% endfor %}
  </div>
{% endif %}

<!-- jQuery + Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function() {
    $('#course').select2({
      placeholder: 'Search or select a course...',
      width: '100%'
    });
    $('#difficulty').select2({
      placeholder: 'Select difficulty level...',
      width: '100%'
    });
  });
</script>
<script>
  const form = document.querySelector("form");
  const loader = document.getElementById("ai-loader");
  const progressBar = document.getElementById("ai-progress-bar");

  form.addEventListener("submit", function () {

    loader.style.display = "block";

    let progress = 0;

    const interval = setInterval(() => {
      if (progress < 90) {
        progress += Math.random() * 10;  // Smooth realistic movement
        progressBar.style.width = progress + "%";
      }
    }, 400);

  });
</script>
