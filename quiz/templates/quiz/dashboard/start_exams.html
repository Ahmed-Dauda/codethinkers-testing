{% extends 'sms/dashboard/base.html' %}

{% load mathfilters %}
{% load hitcount_tags %}
{% load cloudinary %}
{% load embed_video_tags %}

{% block title %} Courses list view page {% endblock %}

{% block content %}

<!-- Styles -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.1/css/dataTables.dataTables.css">
<link rel="stylesheet" href="/static/sms/prism.css">

<style>
  .quiz { width: 100%; display: flex; cursor: pointer; border: 1px solid #ccc; }
  .quiz>* { margin: 10px; overflow-x: hidden; }
  .quiz input[type="radio"] { transform: scale(1.5); margin-right: 10px; }

  .back-button {
    display: inline-block; padding: 10px 20px; background-color: #f9f9f9;
    border: 1px solid #ccc; border-radius: 5px; text-decoration: none; color: #333; font-size: 16px;
  }
  .back-button:hover { background-color: #e0e0e0; }

  .pagination-box {
    display: inline-block; width: 100px; height: 30px; border: 1px solid #ccc;
    text-align: center; line-height: 30px; margin-right: 5px; cursor: pointer;
  }
  .clicked { background-color: rgb(211, 247, 211); }

  /* Full-page overlay loader */
  #overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 9999;
    text-align: center;
    color: #fff;
  }
  #overlay .spinner-border {
    margin-top: 20%;
    width: 4rem;
    height: 4rem;
  }

  #overlay .progress {
    width: 50%;
    margin: 20px auto 0 auto;
    height: 25px;
  }
</style>

<!-- Back button -->
<a class="back-button" href="{% url 'sms:topicslistview' course.course_name.courses.id %}" style="font-size: 24px;">
  <span class="bi bi-arrow-left"></span>
</a>

<!-- Quiz Results -->
<div class="card mt-3">
  <div class="card-header">
    <h2>Quiz Results</h2>
    {% for t in results %}
      <div class="container">
        <span>Score: ({{ t.marks|mul:100|div:q_count }}/100%)</span>
        {% if t.marks >= course.pass_mark %}
          <p style="color: green;">Congratulations! You passed <span class="bi bi-emoji-smile"></span></p>
        {% else %}
          <p style="color: red;">Unfortunately, you did not pass. Keep practicing! <span class="bi bi-emoji-sad"></span></p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<hr>
<!-- Progress -->
<div class="container">
  <div class="progress mt-4">
    <div class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0% Complete</div>
  </div>
  <div id="paginationBoxes"></div>
</div>

<hr>
<!-- Quiz Form -->
<div class="container mt-4">
  <form id="quizForm" action="{% url 'quiz:calculate_marks_assessment' %}" method="POST">
    {% csrf_token %}

    <h4 class="mb-3">{{ course.course_name }} Quiz</h4>
    <h5 class="mb-4">Number of Questions: {{ q_count }}</h5>

    <table class="table table-bordered question-table">
      <tbody>
        {% for q in page_obj %}
        <tr>
          <td>
            {% if q.img_quiz %}
            <div class="text-center mb-3">
              <img src="{{ q.img_quiz.url }}" class="img-fluid" style="max-height:250px;" alt="Quiz Image">
            </div>
            {% endif %}

            <label class="d-block mb-2" style="font-size:18px;">{{ q.question|safe }}</label>
            <h6 class="text-end">[marks {{ q.marks }}]</h6>

            {% if q.option1 %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="{{ q.id }}" id="option1-{{ q.id }}" value="Option1" required>
              <label class="form-check-label" for="option1-{{ q.id }}">{{ q.option1|safe }}</label>
            </div>
            {% endif %}

            {% if q.option2 %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="{{ q.id }}" id="option2-{{ q.id }}" value="Option2" required>
              <label class="form-check-label" for="option2-{{ q.id }}">{{ q.option2|safe }}</label>
            </div>
            {% endif %}

            {% if q.option3 %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="{{ q.id }}" id="option3-{{ q.id }}" value="Option3" required>
              <label class="form-check-label" for="option3-{{ q.id }}">{{ q.option3|safe }}</label>
            </div>
            {% endif %}

            {% if q.option4 %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" name="{{ q.id }}" id="option4-{{ q.id }}" value="Option4" required>
              <label class="form-check-label" for="option4-{{ q.id }}">{{ q.option4|safe }}</label>
            </div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button id="submitBtn" class="btn btn-primary mt-3" type="submit">Submit Quiz</button>
  </form>
</div>

<!-- Loader overlay with animated progress -->
<div id="overlay">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p>Submitting quiz, please wait...</p>
  <div class="progress">
    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar"
         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.10.5/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
  $('#example').DataTable({ paging: false, ordering: false });

  // Quiz progress bar update while answering
  function updateProgress() {
    var answered = $('input[type=radio]:checked').length;
    var total = {{ q_count }};
    var progress = (answered / total) * 100;
    $('.progress-bar').css('width', progress + '%').attr('aria-valuenow', progress).text(Math.round(progress) + '% Complete');
  }

  $('input[type=radio]').on('change', updateProgress);
  updateProgress();

  // Show overlay and animate submission progress
  $('#quizForm').on('submit', function(e) {
    $('#overlay').show();
    $('#submitBtn').prop('disabled', true);

    var progressBar = $('#overlay .progress-bar');
    var width = 0;
    var interval = setInterval(function() {
      if (width >= 100) {
        clearInterval(interval);
      } else {
        width += 1;  // increment 1% every 50ms (approx 5s total)
        progressBar.css('width', width + '%').attr('aria-valuenow', width).text(width + '%');
      }
    }, 50);
  });
});
</script>

{% endblock %}
