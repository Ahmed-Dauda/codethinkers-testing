{% extends "webprojects/base_editor.html" %}
{% load file_filters %}

{% block title %}{{ file.name }} | {{ file.project.name }}  {% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Segoe UI', sans-serif;
    background-color: #1e1e1e;
    color: #ccc;
  }

  .editor-layout {
    display: flex;
    height: calc(100vh - 48px);
    transition: all 0.3s ease;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    background: #1e1e1e;
    border-bottom: 1px solid #444;
    justify-content: flex-start;
  }

  .toolbar button,
  .toolbar select {
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    font-size: 0.95em;
    background: #333;
    color: #eee;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .toolbar button:hover,
  .toolbar select:hover {
    background: #444;
  }

  .sidebar {
    width: 450px;
    background-color: #252526;
    padding: 10px;
    border-right: 1px solid #444;
    overflow-y: auto;
    transition: all 0.3s ease;
  }

  .folder-toggle {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    color: #ccc;
    margin: 10px 0 5px;
    transition: color 0.3s ease;
  }

  .folder-toggle:hover {
    color: #fff;
  }

  .file-group {
    margin-left: 10px;
    display: none;
    transition: all 0.3s ease;
  }

  .folder-toggle.open + .file-group {
    display: block;
  }

  .file-item {
    margin: 4px 0;
  }

  .file-item a {
    color: #bbb;
    text-decoration: none;
    font-size: 0.9em;
    display: block;
    padding: 2px 0;
    transition: color 0.2s ease;
  }

  .file-item a:hover {
    color: #fff;
  }

  .editor-panel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #container {
    flex-grow: 1;
    border-top: 1px solid #444;
    border-bottom: 1px solid #444;
    min-height: 100px;
  }

  #outputPanel {
    height: 0px;
    background: #1e1e1e;
    color: #dcdcdc;
    padding: 0px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
    border-top: 1px solid #444;
  }

  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
  }

  ::-webkit-scrollbar-track {
    background: #2c2c2c;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .editor-layout {
      flex-direction: column;
    }

    /* .sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #444;
      max-height: 200px;
      overflow-y: auto;
    } */

    .toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .editor-panel {
      height: auto;
    }

    #outputPanel {
      height: 140px;
    }
  }

  @media (max-width: 480px) {
    .toolbar button,
    .toolbar select {
      width: 100%;
      font-size: 0.9em;
    }

    .folder-toggle {
      font-size: 0.9em;
    }

    .file-item a {
      font-size: 0.85em;
    }
  }

  /* Spinner animation */
  .spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 3px solid #ccc;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Sidebar collapse toggle for mobile */
  .editor-layout.collapsed .sidebar {
    display: none;
  }

  .editor-layout.collapsed .editor-panel {
    width: 100% !important;
  }
#toastMessage {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 600px;
  background: #333;
  color: #fff;
  padding: 12px 16px;
  font-size: 0.95em;
  display: none;
  opacity: 0;
  z-index: 9999;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: opacity 0.3s ease;
}

</style>
<style>
@keyframes xpPulse {
  0%   { transform:scale(1);    box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  50%  { transform:scale(1.05); box-shadow: 0 4px 20px rgba(243,156,18,0.6); }
  100% { transform:scale(1);    box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
}
.xp-pulse {
  animation: xpPulse 0.4s ease;
}
</style>
<style>
/* Folder toggle header */
.folder-toggle {
    background-color: #2b2b2b;
    color: #fff;
    padding: 10px 15px;
    margin-top: 10px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    transition: background 0.3s;
}

.folder-toggle:hover {
    background-color: #444;
}

/* File group container */
.file-group {
    padding-left: 20px;
    margin-bottom: 10px;
    display: none; /* Hidden by default, toggle with JS */
}

/* Individual file item */
.file-item {
    padding: 6px 10px;
    margin-bottom: 4px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #f5f5f5;
    transition: background 0.3s;
}

.file-item a {
    text-decoration: none;
    color: #333;
    flex-grow: 1;
}

.file-item a:hover {
    text-decoration: underline;
    color: #007bff;
}

/* Buttons */
.btn {
    padding: 2px 6px;
    font-size: 0.8rem;
    border-radius: 4px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-sm {
    font-size: 0.75rem;
    padding: 2px 5px;
}

.btn-primary {
    background-color: #007bff;
    color: #fff;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-danger {
    background-color: #dc3545;
    color: #fff;
}

.btn-danger:hover {
    background-color: #b02a37;
}

/* Highlight selected file */
.file-item a[style*="font-weight:bold"] {
    background-color: #007bff;
    color: #fff !important;
    padding: 4px 8px;
    border-radius: 4px;
}

/* Image file color */
.file-item a[onclick*="showImageModal"] {
    color: #4fa;
    font-weight: bold;
}

.topic-item {
    padding: 6px 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 2px solid transparent;
    background-color: white;
    transition: all 0.3s ease;
}

.topic-item.active {
    border: 2px solid #3498db !important;
    background-color: #e8f4f8 !important;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
}

.topic-item button {
    transition: all 0.2s;
}

.topic-item button:hover {
    transform: scale(1.05);
}
  .topic-toggle {
    font-weight: 600;
    color: #fefbfb;
    text-decoration: none;
    cursor: pointer;
  }

  .toggle-icon {
    transition: transform 0.3s ease;
    font-weight: bold;
  }

  .topic-desc {
    overflow: auto;
    background-color: #1e1e1e;
    color: #d4d4d4;
    margin-top: 6px;
    padding: 8px;
    border-radius: 6px;
    max-height: 300px;
    font-size: 0.9rem;
  }
  .resize-handle {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  width: 5px;
  cursor: col-resize;
  background: transparent;
  z-index: 10;
  transition: background 0.2s;
}

.resize-handle:hover {
  background: #4fa !important;
}

.resize-handle::after {
  content: '';
  position: absolute;
  right: -2px;
  top: 50%;
  transform: translateY(-50%);
  width: 1px;
  height: 40px;
  background: rgba(255,255,255,0.1);
}
</style>

<!-- roller -->
 <style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>

{% endblock %}

{% block header %}
<style>
  .navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 12px 16px;
    background: #1a1a1a;
    position: relative;
  }

  .nav-links {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .nav-links a,
  .nav-links button {
    color: white;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    font-size: 14px;
  }

  .nav-links a:hover,
  .nav-links button:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .project-info {
    margin: 0;
    color: white;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
    padding: 8px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    z-index: 1001;
  }

  .hamburger span {
    width: 24px;
    height: 2px;
    background: white;
    transition: all 0.3s;
  }

  .hamburger.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  .hamburger.active span:nth-child(2) {
    opacity: 0;
  }

  .hamburger.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
  }

  @media (max-width: 768px) {
    .hamburger {
      display: flex;
    }

    .nav-links {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 280px;
      max-width: 80vw;
      background: #2d3748;
      flex-direction: column;
      align-items: stretch;
      padding: 80px 20px 20px;
      gap: 12px;
      transition: right 0.3s ease;
      z-index: 1000;
      box-shadow: -4px 0 10px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    }

    .nav-links.active {
      right: 0;
    }

    .nav-links a,
    .nav-links button {
      width: 100%;
      justify-content: flex-start;
      font-size: 16px;
      padding: 12px 16px;
    }

    .project-info {
      font-size: 12px;
      max-width: calc(100% - 60px);
      flex-wrap: wrap;
    }

    /* Overlay backdrop */
    .nav-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .nav-overlay.active {
      display: block;
      opacity: 1;
    }
  }
  .btn-run {
    background: #2ecc71 !important;
    border-color: #27ae60 !important;
  }

  .btn-run:hover {
    background: #27ae60 !important;
  }

</style>
<style>
/* Error line highlighting */
.error-line-highlight {
  background: rgba(255, 0, 0, 0.1) !important;
  border-left: 3px solid #f5576c !important;
}

.error-line-glyph {
  background: #f5576c !important;
  width: 5px !important;
  margin-left: 3px;
}

.error-line-decoration {
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 6 3' enable-background='new 0 0 6 3' height='3' width='6'%3E%3Cg fill='%23f5576c'%3E%3Cpolygon points='5.5,0 2.5,3 1.1,3 4.1,0'/%3E%3Cpolygon points='4,0 6,2 6,0.6 5.4,0'/%3E%3Cpolygon points='0,2 1,3 2.4,3 0,0.6'/%3E%3C/g%3E%3C/svg%3E") repeat-x bottom left !important;
}

/* Pulse animation for error line */
.error-line-highlight {
  background: rgba(255, 0, 0, 0.15) !important; /* ‚úÖ Static, no animation */
}
</style>


<div class="navbar">
  <p class="project-info">
    <span>üìÅ</span>
    <strong>{{ file.project.name }}</strong>
    <span>‚Äî</span>
    <span>üìù {{ file.name }}</span>
  </p>

  <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <div class="nav-links" id="navLinks">
    <a href="{% url 'webprojects:create_project' %}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Create Project
    </a>
    
    <a href="{% url 'student:take-exam' %}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 11l3 3L22 4"/>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
      </svg>
      Take Exam
    </a>
    

    <button id="toggleAI" onclick="toggleAITools()" class="btn-ai-tools">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
      </svg>
      Show AI Tools
    </button>

    <button id="toggleAI" onclick="toggleAITools()" class="btn-ai-tools">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
      </svg>
    <a class="btn btn-primary" href="{% url 'account_logout' %}">Logout</a>
    </button>

   <button  id="runBtnCode" onclick="runCode()" class="btn-run">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 5v14l11-7z"/>
      </svg>
      Run Code
    </button>

    <button onclick="toggleTheme()" id="themeToggleBtn">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="5"/>
    <line x1="12" y1="1" x2="12" y2="3"/>
    <line x1="12" y1="21" x2="12" y2="23"/>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
    <line x1="1" y1="12" x2="3" y2="12"/>
    <line x1="21" y1="12" x2="23" y2="12"/>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
  </svg>
  <span id="themeToggleText">Light Mode</span>
</button>

<span>‚ö° <strong id="xpTotal">0</strong> XP</span>
<span>üî• <strong id="xpStreak">0</strong> day streak</span>
    
</div>

  </div>

  <div class="nav-overlay" id="navOverlay"></div>
</div>

<script>
  const hamburger = document.getElementById('hamburgerBtn');
  const navLinks = document.getElementById('navLinks');
  const navOverlay = document.getElementById('navOverlay');

  function toggleMenu() {
    hamburger.classList.toggle('active');
    navLinks.classList.toggle('active');
    navOverlay.classList.toggle('active');
    document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
  }

  hamburger.addEventListener('click', toggleMenu);

  // Close menu when clicking overlay
  navOverlay.addEventListener('click', toggleMenu);

  // Close menu when clicking a link
  navLinks.querySelectorAll('a, button').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        toggleMenu();
      }
    });
  });

  // Close menu when window is resized to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768 && navLinks.classList.contains('active')) {
      toggleMenu();
    }
  });
</script>


{% endblock %}


{% block sidebar %}

<div id="dropZone" style="border: 2px dashed #555; padding: 10px; text-align: center; color: #aaa;">
  Drop File Here or 
  <label for="fileInput" style="color: #4fa; cursor:pointer;">Browse</label>
  <input type="file" id="fileInput" 
         accept=".png,.jpg,.jpeg,.gif,.xls,.xlsx,.csv" 
         style="display:none;">
</div>
<small style="color: #888;">Images and Excel files will be added to your files</small>

<!-- Global Upload Spinner -->
<!-- üîÑ Upload Loader -->
<div id="upload-loader" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  z-index:9999;
  justify-content:center;
  align-items:center;
">
  <div style="
    width:50px; height:50px;
    border:5px solid #f3f3f3;
    border-top:5px solid #3498db;
    border-radius:50%;
    animation: spin 1s linear infinite;
  "></div>
</div>


<div style="margin-bottom: 20px;">
  <input type="text" id="newFileName" placeholder="üìù New file name (e.g., app1.py,index.html)" style="width: 100%; padding: 5px; margin-bottom: 5px; font-size: 0.9em;">
  <button onclick="createNewFile()" style="width: 100%; background: #3498db; color: white; padding: 6px 10px; border: none; border-radius: 4px;">‚ûï Create File</button>
</div>

<hr>


<h2 class="mb-3">Modules</h2>

<!-- Overall progress bar ‚Äî filled by JS -->
<div id="modules-overall-progress" style="margin-bottom:10px; display:none;">
  <div style="display:flex; justify-content:space-between;
              font-size:12px; color:#666; margin-bottom:4px;">
    <span id="modules-done-label">0 / 0 topics completed</span>
    <span id="modules-pct-label">0%</span>
  </div>
  <div style="background:#e0e0e0; border-radius:20px; height:8px; overflow:hidden;">
    <div id="modules-pb-fill" style="
      background:linear-gradient(90deg,#3498db,#27ae60);
      width:0%; height:100%; border-radius:20px;
      transition:width 0.6s ease;
    "></div>
  </div>
</div>

<div class="topics-container">
  {% for topic in topics %}

  {# Every topic starts IDENTICAL ‚Äî no Django conditionals in style/text #}
  <div
    class="topic-item"
    id="topic-item-{{ topic.id }}"
    data-topic-id="{{ topic.id }}"
    style="
      background-color: white;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      position: relative;
    "
  >
    <a href="javascript:void(0);"
       class="topic-toggle d-flex justify-content-between align-items-center"
       onclick="toggleDesc('topic-{{ topic.id }}', this, '{{ topic.language|default:"python" }}')">

      <span class="d-flex align-items-center gap-2">
        <!-- Icon: JS sets this to ‚úÖ üìç or ‚óã -->
        <span
          id="topic-icon-{{ topic.id }}"
          style="font-size:15px; min-width:20px; display:inline-block; transition:all 0.2s;"
        >‚óã</span>
        <strong class="fs-6 text-secondary">{{ forloop.counter }}. {{ topic.title }}</strong>
      </span>

      <span class="d-flex align-items-center gap-2">
        <!-- Badge: JS shows/hides and sets text/colour -->
        <span
          id="topic-badge-{{ topic.id }}"
          style="
            display: none;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
            white-space: nowrap;
            transition: all 0.3s;
          "
        ></span>
        <span class="toggle-icon">‚ûï</span>
      </span>
    </a>

    <!-- Button: JS sets text, colour, cursor -->
    <button
      class="topic-study-btn"
      id="topic-btn-{{ topic.id }}"
      data-topic-id="{{ topic.id }}"
      onclick="event.stopPropagation(); handleStudyClick({{ topic.id }}, this)"
      style="
        margin: 5px 0 0;
        padding: 4px 10px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        font-weight: normal;
        width: 100%;
        text-align: left;
        transition: all 0.2s;
      "
    >üìö Study This Topic</button>

    <pre id="topic-{{ topic.id }}"
         class="topic-desc language-{{ topic.language|default:'python' }}"
         style="display:none; margin:0; padding:0;">
      <code class="language-{{ topic.language|default:'python' }}" style="user-select:none;">
{{ topic.desc|safe }}
      </code>
    </pre>
  </div>

  {% empty %}
    <p class="text-muted">No content found for this course.</p>
  {% endfor %}
</div>


<script>

function applyTopicStates(data) {
  const currentId = parseInt(data.current_topic_id, 10) || 0;

  // ‚îÄ‚îÄ MERGE incoming ids with the optimistic cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // _tickSidebarItem() writes to window._completedTopicIds BEFORE
  // any fetch completes. If we blindly replace it with data from
  // the server response, a stale response (that arrived before the
  // DB committed) wipes out the tick the student just earned.
  // Solution: always take the UNION of both sets.
const incoming     = new Set((data.completed_topic_ids || []).map(Number));

  // Only merge cache if we are on the same course ‚Äî never carry over from another course
  const sameCourse   = !data.course_id || !window._currentCourseId || 
                       (Number(data.course_id) === Number(window._currentCourseId));
  const cached       = sameCourse 
                       ? new Set((window._completedTopicIds || []).map(Number))
                       : new Set();
  const completedSet = new Set([...incoming, ...cached]);

  const allItems = document.querySelectorAll('.topic-item[data-topic-id]');
  const total    = data.total_count || allItems.length;

  // Persist merged result
  window._completedTopicIds = Array.from(completedSet);
  window._currentTopicId    = currentId;
  window._totalTopicCount   = total;

  allItems.forEach(item => {
    const id    = parseInt(item.dataset.topicId, 10);
    const btn   = document.getElementById('topic-btn-'   + id);
    const icon  = document.getElementById('topic-icon-'  + id);
    const badge = document.getElementById('topic-badge-' + id);
    if (!btn) return;

    if (completedSet.has(id)) {
      // ‚îÄ‚îÄ ‚úÖ COMPLETED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      item.style.border          = '2px solid #27ae60';
      item.style.backgroundColor = '#f0fff4';
      btn.textContent            = '‚úÖ Completed';
      btn.style.background       = '#27ae60';
      btn.style.fontWeight       = 'bold';
      btn.style.cursor           = 'pointer';
      if (icon) icon.textContent = '‚úÖ';
      if (badge) {
        badge.style.display    = 'inline-block';
        badge.textContent      = 'Done';
        badge.style.background = '#d4edda';
        badge.style.color      = '#155724';
        badge.style.border     = '1px solid #c3e6cb';
      }

    } else if (id === currentId) {
      // ‚îÄ‚îÄ üìç IN PROGRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      item.style.border          = '2px solid #3498db';
      item.style.backgroundColor = '#e8f4f8';
      btn.textContent            = 'üìç Currently Studying';
      btn.style.background       = '#2980b9';
      btn.style.fontWeight       = 'bold';
      btn.style.cursor           = 'default';
      if (icon) icon.textContent = 'üìç';
      if (badge) {
        badge.style.display    = 'inline-block';
        badge.textContent      = 'In Progress';
        badge.style.background = '#cce5ff';
        badge.style.color      = '#004085';
        badge.style.border     = '1px solid #b8daff';
      }

    } else {
      // ‚îÄ‚îÄ ‚óã NOT STARTED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      item.style.border          = '2px solid transparent';
      item.style.backgroundColor = 'white';
      btn.textContent            = 'üìö Study This Topic';
      btn.style.background       = '#3498db';
      btn.style.fontWeight       = 'normal';
      btn.style.cursor           = 'pointer';
      if (icon)  icon.textContent  = '‚óã';
      if (badge) badge.style.display = 'none';
    }
  });

  // Update the mini progress bar above the topic list
  _renderSidebarProgress(completedSet.size, total, data.overall_pct);
}

function _renderSidebarProgress(done, total, pct) {
  const wrap  = document.getElementById('modules-overall-progress');
  const fill  = document.getElementById('modules-pb-fill');
  const label = document.getElementById('modules-done-label');
  const pctEl = document.getElementById('modules-pct-label');
  if (!wrap || !total) return;

  const p = (pct !== undefined) ? pct : Math.round((done / total) * 100);

  wrap.style.display = 'block';
  if (fill)  fill.style.width   = p + '%';
  if (label) label.textContent  = done + ' / ' + total + ' topics completed';
  if (pctEl) pctEl.textContent  = p + '%';

  if (fill) {
    fill.style.background =
      p === 100 ? 'linear-gradient(90deg,#27ae60,#2ecc71)' :
      p >= 50   ? 'linear-gradient(90deg,#f39c12,#2ecc71)' :
                  'linear-gradient(90deg,#3498db,#27ae60)';
  }
}


function handleStudyClick(topicId, btn) {
  window._justClickedStudy = true;
  setTimeout(() => { window._justClickedStudy = false; }, 800);

  setTimeout(() => {
    window._currentTopicId = topicId;
    localStorage.setItem('currentTopicId', topicId);
    currentlyStudyingTopicId = topicId;

    applyTopicStates({
      current_topic_id:    topicId,
      completed_topic_ids: window._completedTopicIds || [],
      total_count:         window._totalTopicCount   || 0,
    });

    setCurrentTopic(topicId, btn);
  }, 0);
}

// ‚îÄ‚îÄ Backend save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


async function setCurrentTopic(topicId, buttonElement) {
  currentlyStudyingTopicId = topicId;
  localStorage.setItem('currentTopicId', topicId);

  try {
    const res  = await fetch(`/webprojects/project/{{ file.project.id }}/set-topic/${topicId}/`, {
      method:  'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    const data = await res.json();
    if (data.status === 'success') {
      showToast('üìç ' + (data.topic_title || data.message || 'Topic selected'));
    } else {
      showToast('‚ùå Failed to set topic');
    }
  } catch {
    // Silently fail ‚Äî local state already updated
  }
}

document.addEventListener('DOMContentLoaded', function () {
  window._totalTopicCount = document.querySelectorAll(
    '.topic-item[data-topic-id]'
  ).length;

  // DB is the ONLY source of truth ‚Äî baked in at render time by Django
  const seedCompleted = {{ completed_topic_ids|safe }};
  const seedCurrent   = {{ current_topic_id|default:"null" }};

  // Hard reset ‚Äî ignore everything from localStorage or memory
  window._completedTopicIds = seedCompleted.map(Number);
  window._currentTopicId    = seedCurrent;
  currentlyStudyingTopicId  = seedCurrent;

  // Wipe all localStorage topic state
  localStorage.removeItem('currentTopicId');
  localStorage.removeItem('completedTopicIds');
  localStorage.removeItem('_completedTopicIds');

  applyTopicStates({
    current_topic_id:    seedCurrent,
    completed_topic_ids: seedCompleted,
    total_count:         window._totalTopicCount,
  });
});
</script>
{% comment %} Seed JS with server data so ticks show instantly on load {% endcomment %}
<script>
// Scope completed topics to THIS course only
const _thisCourseId = {{ course_id|default:"null" }};
window._currentCourseId   = _thisCourseId;
window._completedTopicIds = _thisCourseId ? {{ completed_topic_ids|safe }} : [];
window._currentTopicId    = {{ current_topic_id|default:"null" }};
window._totalTopicCount   = {{ topics|length }};

// Wipe any stale localStorage completed cache from other courses
const _storedCourseId = localStorage.getItem('currentCourseId');
if (_storedCourseId && _storedCourseId != _thisCourseId) {
  // Different course ‚Äî clear stale data
  localStorage.removeItem('completedTopicIds');
  localStorage.removeItem('_completedTopicIds');
  localStorage.removeItem('currentTopicId');
  console.log('[Course] Cleared stale data from course', _storedCourseId);
}
localStorage.setItem('currentCourseId', _thisCourseId);
localStorage.removeItem('completedTopicIds');
localStorage.removeItem('_completedTopicIds');

</script>

<script>


// Small "X/Y completed" line under the Modules heading
function _updateOverallBadge(done, total) {
  let el = document.getElementById('modules-overall-badge');
  if (!el) {
    el = document.createElement('p');
    el.id = 'modules-overall-badge';
    el.style.cssText = 'font-size:12px;color:#888;margin:-6px 0 8px;padding:0;';
    const h2 = document.querySelector('.topics-container');
    if (h2 && h2.parentNode) h2.parentNode.insertBefore(el, h2);
  }
  if (!total) { el.textContent = ''; return; }
  const pct = Math.round((done / total) * 100);
  
  el.innerHTML =
    `<span style="color:#27ae60;font-weight:600;">${done}</span>` +
    `<span style="color:#aaa;">/${total} topics completed</span>` +
    ` <span style="
        display:inline-block;
        background:linear-gradient(90deg,#3498db ${pct}%,#e0e0e0 ${pct}%);
        border-radius:10px; height:6px; width:80px;
        vertical-align:middle; margin-left:6px;
      "></span>` +
    ` <span style="color:#3498db;font-size:11px;">${pct}%</span>`;
}


// ‚îÄ‚îÄ Single declaration ‚Äî used by handleStudyClick and setCurrentTopic ‚îÄ‚îÄ
let currentlyStudyingTopicId = null;
// Check what's stored
console.log("window._currentTopicId:", window._currentTopicId);
console.log("localStorage:", localStorage.getItem('currentTopicId'));


// Always use DB seed data for completed topics, only use localStorage for current topic
// Always use DB seed data ‚Äî never restore from localStorage
const saved = localStorage.getItem('currentTopicId');
const currentId = window._currentTopicId || null; // ‚Üê ignore localStorage
if (currentId) {
  currentlyStudyingTopicId = currentId;
  setTimeout(() => {
    applyTopicStates({
      current_topic_id:    currentId,
      completed_topic_ids: window._completedTopicIds || [],
      total_count:         window._totalTopicCount
    });
  }, 100);
}
// ‚îÄ‚îÄ Page load restore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// document.addEventListener('DOMContentLoaded', function () {
//   // Count topics for the progress line
//   window._totalTopicCount = document.querySelectorAll('.topic-item[data-topic-id]').length;

//   const saved = localStorage.getItem('currentTopicId');
//   if (saved) {
//     currentlyStudyingTopicId = parseInt(saved, 10);
//     setTimeout(() => {
//       applyTopicStates({
//         current_topic_id:    currentlyStudyingTopicId,
//         completed_topic_ids: window._completedTopicIds || [],
//         total_count:         window._totalTopicCount
//       });
//     }, 100);
//   }
// });

</script>
<!-- ===== Style ===== -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>

<!-- ===== Script ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-html.min.js"></script>


{% for ext in exts %}
  {% with files|dictsort:"name" as sorted_files %}
    <div class="folder-toggle" data-ext="{{ ext }}">
      üìÅ {{ ext|upper }} Files <span>‚Æü</span>
    </div>
    <div class="file-group">
      {% for f in sorted_files %}
        {% if f.name|has_ext:ext %}
          {% with f.name|lower as fname %}
            <div class="file-item">

              {% if fname|slice:"-4:" == ".png" or fname|slice:"-4:" == ".jpg" or fname|slice:"-5:" == ".jpeg" or fname|slice:"-4:" == ".gif" %}
                <!-- üëá Image File: Open Modal -->
                <a href="javascript:void(0);" onclick="showImageModal('{{ f.image.url }}')" style="color:#4fa;">üñºÔ∏è {{ f.name }}</a>

              {% else %}
                <!-- üëá Normal File: Go to Editor -->
                <!-- <a class="ajax-link" href="{% url 'webprojects:file_detail' f.project.id f.id %}" {% if f.id == file.id %}style="font-weight:bold;color:#fff;"{% endif %}>üìù {{ f.name }}</a> -->
                 <!-- NEW WAY (AJAX - no reload): -->
  <a href="javascript:void(0);" 
     onclick="loadFile({{ f.project.id }}, {{ f.id }}, '{{ f.name|escapejs }}')"
     class="file-link"
     data-file-id="{{ f.id }}"
     {% if f.id == file.id %}style="font-weight:bold;color:#3498db;"{% endif %}>
    üìù {{ f.name }}
  </a>

                {% if ".html" in f.name|lower %}
                  <a href="{% url 'webprojects:share_preview' f.project.id f.id %}" target="_blank" style="color: green;">publish</a>
                {% endif %}

                {% if f.is_excel %}
                  <!-- üëá Excel/CSV Preview Button -->
                  <a href="{% url 'webprojects:file_preview' f.project.id f.id %}" class="btn btn-sm ">View</a>
                {% endif %}

              {% endif %}

              <!-- üëá Delete Button for all files -->
              <form method="POST" action="{% url 'webprojects:file_delete' f.project.id f.id %}" class="delete-file-form d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
              </form>

            </div>
          {% endwith %}
        {% endif %}
      {% endfor %}
    </div>
  {% endwith %}
{% endfor %}
<style>
.file-link {
  transition: all 0.2s ease;
  position: relative;
}

.file-link:hover {
  color: #3498db !important;
  padding-left: 5px;
}

.file-link.loading::after {
  content: "‚è≥";
  position: absolute;
  right: 0px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<!-- üñºÔ∏è Image Popup Modal -->
<div id="imagePopupModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000;">
  <span onclick="closeImageModal()" style="position:absolute; top:20px; right:30px; font-size:32px; color:white; cursor:pointer;">&times;</span>
  <div style="display:flex; align-items:center; justify-content:center; height:100%;">
    <img id="popupImage" src="" alt="Preview" style="max-width:90%; max-height:90%; border: 2px solid #555; border-radius: 8px;" />
  </div>
</div>

{% endblock %}



{% block content %}


<script>
  const HINT_URL        = "{% url 'webprojects:get_contextual_hint' %}";
  const PROGRESS_URL  = "{% url 'webprojects:get_student_progress' %}";
  const MARK_DONE_URL   = "{% url 'webprojects:mark_topic_complete' %}";
  const CSRF_TOK        = "{{ csrf_token }}";
  const CURRENT_FILE_ID = {{ file.id }};
  const COURSE_ID = {{ course_id|default:"null" }};
</script>

<div style="display: none;" class="preview-section"> 
  <h4>Preview</h4>
  <iframe id="preview" style="width:100%; height:400px; border:1px solid #ccc;"></iframe>
</div>

<!-- end -->


<div id="aiToolbar" class="toolbar">
  
  <span id="aiLoading" style="display:none;">‚è≥</span>
  <!-- <button id="aiBtn" onclick="getAISuggestion()">üí° AI Suggest</button> -->

  
  <!-- üëá ADD SPEECH TOGGLE -->
<button id="speechToggleBtn" onclick="window.toggleSpeech()" style="background: #27ae60; color: white;">
  üîä Speech on
</button>
<button onclick="getManualHint()" style="background: #3498db; color: white;">
  üí° Get AI Hint
</button>

<button onclick="getRelevantExamples()" id="examplesBtn" style="background: #3498db; color: white;">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="3" width="7" height="7"></rect>
    <rect x="14" y="3" width="7" height="7"></rect>
    <rect x="14" y="14" width="7" height="7"></rect>
    <rect x="3" y="14" width="7" height="7"></rect>
  </svg>
  Show Examples üìö
</button>
  <button id="toggleAIBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="9" cy="10" r="1" fill="currentColor"/>
        <circle cx="15" cy="10" r="1" fill="currentColor"/>
        <path d="M8 15s1.5 2 4 2 4-2 4-2"/>
      </svg>
      AI Assistant
    </button>
  <select id="aiAction">
    <!-- <option value="complete">üîß Complete</option> -->
    <option value="explain">üí¨ Explain</option>
    <option value="optimize">‚ö° Optimize</option>
    <option value="comment">üìù Add Comments</option>
    <option value="fix">üêû Fix Bugs</option>
  </select>
  <button id="runBtn" onclick="runAIAction()">üöÄ Run AI Action</button>
</div>


<script>
  // Monitor code changes
editor.onDidChangeModelContent(() => {
  analyzeCodeAndProvideGuidance();
});

async function analyzeCodeAndProvideGuidance() {
  const context = {
    currentCode: editor.getValue(),
    currentModule: getCurrentModule(),
    studentProgress: getProgress(),
    lastError: getLastError()
  };
  
  // Call Claude API
  const guidance = await getAIGuidance(context);
  
  // Speak it out

}
</script>
<!-- delete js  -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteForms = document.querySelectorAll('.delete-file-form');

    deleteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();  // prevent normal form submission

            if (!confirm("Are you sure you want to delete this file?")) return;

            const url = form.getAttribute('action');
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove file item from DOM
                    form.closest('.file-item').remove();
                } else {
                    alert(data.message || 'Failed to delete file.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting file.');
            });
        });
    });
});
</script>




<script>
  function toggleAITools() {
    const aiToolbar = document.getElementById("aiToolbar");
    const toggleBtn = document.getElementById("toggleAI");

    if (aiToolbar.style.display === "none" || aiToolbar.style.display === "") {
      aiToolbar.style.display = "flex";
      toggleBtn.textContent = "‚ùå Hide AI Tools";
    } else {
      aiToolbar.style.display = "none";
      toggleBtn.textContent = "üîß Show AI Tools";
    }
  }

  // Auto-hide toolbar on small screens
  document.addEventListener("DOMContentLoaded", function () {
    if (window.innerWidth <= 768) {
      document.getElementById("aiToolbar").style.display = "none";
    }
  });
</script>
 
<div class="editor-panel" style="display: flex; flex-direction: column; height: 10%;">
  <!-- Code Editor -->
  <div id="container" style="flex-grow: 1; min-height: 10px;"></div>

  <!-- Resize handle for code editor -->
  <div id="resizeHandle" style="height: 6px; cursor: row-resize; background: #444;"></div>
</div>

<!-- ============= SMART AI TUTOR PANEL (IMPROVED VISIBILITY) ============= -->
<div id="smartHintPanel" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 400px;
  max-height: 300px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  border: 2px solid #e74c3c;
  padding: 15px;
  color: #333;
  display: none;
  z-index: 9998;
  animation: slideInUp 0.3s ease;
  overflow-y: auto;
">
  <!-- Header -->
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #eee;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <span id="hintIcon" style="font-size: 28px;">üí°</span>
      <strong id="hintTitle" style="font-size: 17px; color: #2c3e50;">AI Tutor</strong>
    </div>
    <button onclick="closeSmartHint()" style="
      background: #e74c3c;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    " onmouseover="this.style.background='#c0392b'" 
       onmouseout="this.style.background='#e74c3c'">&times;</button>
  </div>
  
  <!-- Hint Content -->
  <div id="hintContent" style="
    font-size: 15px;
    line-height: 1.7;
    color: #2c3e50;
    margin-bottom: 10px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #3498db;
  ">
    Loading...
  </div>
  
  <!-- Topic Context -->
  <div id="hintTopic" style="
    padding: 10px;
    background: #e8f4f8;
    border-radius: 6px;
    font-size: 13px;
    color: #34495e;
    display: none;
    margin-top: 10px;
  ">
    <!-- Topic appears here -->
  </div>
</div>

<style>
@keyframes slideInUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Error state - Red border */
#smartHintPanel.hint-error {
  border-color: #e74c3c !important;
  box-shadow: 0 8px 32px rgba(231, 76, 60, 0.3) !important;
}

#smartHintPanel.hint-error #hintContent {
  background: #fee !important;
  border-left-color: #e74c3c !important;
}

/* Success state - Green border */
#smartHintPanel.hint-success {
  border-color: #27ae60 !important;
  box-shadow: 0 8px 32px rgba(39, 174, 96, 0.3) !important;
}

#smartHintPanel.hint-success #hintContent {
  background: #efffef !important;
  border-left-color: #27ae60 !important;
}

/* Next step state - Blue border */
#smartHintPanel.hint-next-step {
  border-color: #3498db !important;
  box-shadow: 0 8px 32px rgba(52, 152, 219, 0.3) !important;
}

#smartHintPanel.hint-next-step #hintContent {
  background: #eff8ff !important;
  border-left-color: #3498db !important;
}

#smartHintPanel::-webkit-scrollbar {
  width: 6px;
}

#smartHintPanel::-webkit-scrollbar-thumb {
  background: #bdc3c7;
  border-radius: 3px;
}

#smartHintPanel::-webkit-scrollbar-track {
  background: #ecf0f1;
}
</style>
<!-- ============= END SMART AI TUTOR PANEL ============= -->
<style>
@keyframes slideInUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.hint-error {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
}

.hint-success {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
}

.hint-next-step {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
}
</style>

 <div id="aiopenclose" style="display:none;">
<!-- Floating AI Panel -->
<div id="floatingAI" style="
  position: fixed;
  top: 100px;
  right: 30px;
  width: 400px;
  height: 300px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  z-index: 9999;
">

  <!-- Drag handle -->

  <div id="dragHandle" style="cursor: grab; padding: 8px; background: #f1f1f1; border-bottom: 1px solid #ccc;">üñêÔ∏è Drag Me</div>

  <!-- Tab Headers -->
  <div style="display:flex; border-bottom:2px solid #eee; background:#f9f9f9;">
    <button 
      id="appBuilderTab" 
      class="ai-tab" 
      style="flex:1; padding:12px 20px; border:none; background:none; cursor:pointer; border-bottom:3px solid #007bff; font-weight:bold; font-size:15px; color:#007bff; transition:all 0.2s;"
    >
      üèóÔ∏è Build Project
    </button>
    <button 
      id="fileEditorTab" 
      class="ai-tab" 
      style="flex:1; padding:12px 20px; border:none; background:none; cursor:pointer; border-bottom:3px solid transparent; font-size:15px; color:#666; transition:all 0.2s;"
    >
      üìù Edit Current File
    </button>
  </div>

  <!-- App Builder Panel -->
  <div id="appBuilderPanel" style="padding:10px; flex:1; display:flex; flex-direction:column;">
    <div style="display:flex; gap:10px; margin-bottom:6px;">
      <input
        type="text"
        id="aiPrompt"
        placeholder="Ask AI to generate a project (e.g., 'Create a bouncing ball game')"
        style="flex:1; padding:10px 12px; font-size:15px; border:1px solid #ccc; border-radius:4px;"
      />
      <button
        id="runAIPrompt"
        style="padding:10px 18px; background:#007bff; color:#fff; font-size:15px; border:none; border-radius:6px; cursor:pointer; transition:background 0.2s, transform 0.1s; white-space:nowrap;"
        onmouseover="this.style.background='#0056b3'"
        onmouseout="this.style.background='#007bff'"
        onmousedown="this.style.transform='scale(0.96)'"
        onmouseup="this.style.transform='scale(1)'"
      >
        Run AI
      </button>
    </div>
    
    <pre id="appBuilderOutput" 
     style="background:#f5f5f5; padding:10px; border-radius:4px; margin-top:10px; height:200px; overflow-y:auto; white-space:pre-wrap; display:none;">
</pre>

  </div>

  <!-- File Editor Panel -->
  <div id="fileEditorPanel" style="padding:10px; flex:1; display:none; flex-direction:column;">
    <div style="display:flex; gap:10px; margin-bottom:6px;">
      <input 
        id="fileChatPrompt" 
        placeholder="Describe changes to apply to current file..." 
        style="flex:1; padding:10px 12px; font-size:15px; border:1px solid #ccc; border-radius:4px;"
      />
      <button 
        id="applyBtn" 
        style="padding:10px 18px; background:#28a745; color:white; font-size:15px; border:none; border-radius:6px; cursor:pointer; transition:background 0.2s, transform 0.1s; white-space:nowrap;"
        onmouseover="this.style.background='#218838'"
        onmouseout="this.style.background='#28a745'"
        onmousedown="this.style.transform='scale(0.96)'"
        onmouseup="this.style.transform='scale(1)'"
      >
        Apply Changes
      </button>
    </div>
    <pre id="fileChatOutput" style="background:#f5f5f5; flex:1; overflow-y:auto; padding:10px; border-radius:4px; white-space:pre-wrap;"></pre>
  </div>

  <!-- Resize handle for floating AI panel -->
  <div id="resizeHandleAI" style="height:6px; cursor: row-resize; background:#ccc;"></div>
</div>
</div>

<!-- Examples Panel (Semi-Transparent, Draggable) -->
<div id="examplesPanel" style="
  display: none;
  position: fixed;
  top: 80px;
  right: 30px;
  width: 420px;
  max-height: 550px;
  background: rgba(52, 152, 219, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.2);
  overflow: hidden;
  z-index: 9999;
  animation: slideIn 0.3s ease;
">
  <!-- Draggable Header -->
  <div id="examplesDragHandle" style="
    padding: 12px 15px;
    background: rgba(0,0,0,0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    cursor: move;
    user-select: none;
  ">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 20px;">üìö</span>
      <strong style="color: white; font-size: 14px;">Examples</strong>
      <span style="font-size: 10px; opacity: 0.6; color: white;">(drag)</span>
    </div>
    
    <!-- Opacity Control -->
    <div style="display: flex; align-items: center; gap: 10px;">
      <label style="font-size: 11px; color: white; opacity: 0.8;">Opacity:</label>
      <input 
        type="range" 
        id="opacitySlider" 
        min="50" 
        max="100" 
        value="95" 
        style="width: 80px; cursor: pointer;"
        oninput="adjustPanelOpacity(this.value)"
      />
      <button onclick="closeExamplesPanel()" style="
        background: transparent;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
        margin-left: 5px;
      " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
    </div>
  </div>
  
  <!-- Content -->
  <div id="examplesContent" style="
    padding: 15px;
    color: white;
    max-height: 450px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.5;
  ">
    <!-- Examples will be inserted here -->
  </div>
  
  <!-- Resize Handle -->
  <div id="examplesResizeHandle" style="
    position: absolute;
    bottom: 0;
    right: 0;
    width: 15px;
    height: 15px;
    cursor: nwse-resize;
    background: rgba(255,255,255,0.2);
    border-radius: 12px 0 12px 0;
  ">
    <span style="
      position: absolute;
      bottom: 1px;
      right: 2px;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      line-height: 1;
    ">‚ã∞</span>
  </div>
</div>


<script>
// ============= RELEVANT EXAMPLES =============
let currentExamples = [];

async function getRelevantExamples() {
  const code = editor.getValue();
  const selection = editor.getSelection();
  const cursorLine = selection.startLineNumber;
  const selectedText = editor.getModel().getValueInRange(selection);
  
  // Show panel with loading state
  const examplesPanel = document.getElementById('examplesPanel');
  const examplesOverlay = document.getElementById('examplesOverlay');
  const examplesContent = document.getElementById('examplesContent');
  
  // Show overlay and panel
  if (examplesOverlay) examplesOverlay.style.display = 'block';
  examplesPanel.style.display = 'block';
  
  examplesContent.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div class="spinner" style="margin: 0 auto 15px;"></div>
      <p style="color: rgba(255,255,255,0.8);">üîç Finding relevant examples...</p>
    </div>
  `;
  
  try {
    const response = await fetch("{% url 'webprojects:get_code_examples' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        code: code,
        cursor_line: cursorLine,
        selected_text: selectedText,
        file_id: {{ file.id }}
      })
    });
    
    const data = await response.json();
    
    if (data.status === "success" && data.examples) {
      currentExamples = data.examples;
      displayExamples(data.examples);
    } else {
      examplesContent.innerHTML = `
        <div style="text-align: center; padding: 30px;">
          <span style="font-size: 48px;">‚ùå</span>
          <p style="margin-top: 15px;">No examples found</p>
          <small style="opacity: 0.7;">${escapeHTML(data.message || '')}</small>
        </div>
      `;
    }
  } catch (error) {
    examplesContent.innerHTML = `
      <div style="text-align: center; padding: 30px;">
        <span style="font-size: 48px;">‚ö†Ô∏è</span>
        <p style="margin-top: 15px;">Connection error</p>
        <small style="opacity: 0.7;">${escapeHTML(error.message)}</small>
      </div>
    `;
  }
}

function displayExamples(examples) {
  const examplesContent = document.getElementById('examplesContent');
  
  if (!examples || examples.length === 0) {
    examplesContent.innerHTML = `
      <div style="text-align: center; padding: 30px;">
        <span style="font-size: 48px;">üìù</span>
        <p style="margin-top: 15px; color: rgba(255,255,255,0.9);">
          No examples found yet. Keep coding!
        </p>
      </div>
    `;
    return;
  }
  
  examplesContent.innerHTML = '';
  
  examples.forEach((example, index) => {
    const exampleDiv = document.createElement('div');
    exampleDiv.className = 'code-example-item';
    exampleDiv.style.cssText = `
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-left: 4px solid #3498db;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    `;
    
    exampleDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div>
          <span style="
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
          ">${example.category || 'Example'}</span>
        </div>
        <span style="font-size: 24px;">${getCategoryEmoji(example.category)}</span>
      </div>
      
      <h4 style="color: white; margin: 10px 0; font-size: 16px;">
        ${example.title}
      </h4>
      
      <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 12px; line-height: 1.5;">
        ${example.explanation}
      </p>
      
      <pre style="
        background: rgba(0,0,0,0.4);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.5;
        border: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 10px;
      "><code>${escapeHTML(example.code)}</code></pre>
    `;
    
    // Hover effect
    exampleDiv.addEventListener('mouseenter', () => {
      exampleDiv.style.background = 'rgba(52, 152, 219, 0.2)';
      exampleDiv.style.transform = 'translateX(5px)';
    });
    
    exampleDiv.addEventListener('mouseleave', () => {
      exampleDiv.style.background = 'rgba(0,0,0,0.3)';
      exampleDiv.style.transform = 'translateX(0)';
    });
    
    examplesContent.appendChild(exampleDiv);
  });
}

function getCategoryEmoji(category) {
  const emojis = {
    'input': '‚å®Ô∏è',
    'loops': 'üîÑ',
    'conditionals': 'üîÄ',
    'functions': '‚öôÔ∏è',
    'lists': 'üìã',
    'strings': 'üìù',
    'math': 'üî¢',
    'files': 'üìÅ',
    'beginner': 'üå±',
    'intermediate': 'üöÄ',
    'advanced': '‚≠ê'
  };
  
  return emojis[category?.toLowerCase()] || 'üí°';
}





function closeExamplesPanel() {
  document.getElementById('examplesPanel').style.display = 'none';
  const overlay = document.getElementById('examplesOverlay');
  if (overlay) overlay.style.display = 'none';
  currentExamples = [];
}

// Make examples panel draggable (same as hint panel)
document.addEventListener('DOMContentLoaded', function() {
  const examplesPanel = document.getElementById('examplesPanel');
  const dragHandle = document.getElementById('examplesDragHandle');
  const resizeHandle = document.getElementById('examplesResizeHandle');
  
  if (!examplesPanel || !dragHandle) return;
  
  let isDragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  
  dragHandle.addEventListener('mousedown', function(e) {
    if (e.target.tagName === 'BUTTON') return;
    isDragging = true;
    dragOffsetX = e.clientX - examplesPanel.offsetLeft;
    dragOffsetY = e.clientY - examplesPanel.offsetTop;
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    let newLeft = e.clientX - dragOffsetX;
    let newTop = e.clientY - dragOffsetY;
    const maxLeft = window.innerWidth - examplesPanel.offsetWidth;
    const maxTop = window.innerHeight - examplesPanel.offsetHeight;
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop = Math.max(0, Math.min(newTop, maxTop));
    examplesPanel.style.left = newLeft + 'px';
    examplesPanel.style.top = newTop + 'px';
  });
  
  document.addEventListener('mouseup', function() {
    isDragging = false;
  });
});  
</script>

<script>
// ai open and close tab js  
const toggleBtn = document.getElementById("toggleAIBtn");
const aiPanel = document.getElementById("aiopenclose");

toggleBtn.addEventListener("click", function() {
    if (aiPanel.style.display === "none") {
        aiPanel.style.display = "block";
    } else {
        aiPanel.style.display = "none";
    }
});
</script>


<script>
  
/* ================= TAB SWITCHING ================= */
const appBuilderTab = document.getElementById('appBuilderTab');
const fileEditorTab = document.getElementById('fileEditorTab');
const appBuilderPanel = document.getElementById('appBuilderPanel');
const fileEditorPanel = document.getElementById('fileEditorPanel');

function switchToAppBuilder() {
  appBuilderPanel.style.display = 'flex';
  fileEditorPanel.style.display = 'none';

  appBuilderTab.style.borderBottom = '3px solid #007bff';
  appBuilderTab.style.fontWeight = 'bold';
  appBuilderTab.style.color = '#007bff';

  fileEditorTab.style.borderBottom = '3px solid transparent';
  fileEditorTab.style.fontWeight = 'normal';
  fileEditorTab.style.color = '#666';
}

function switchToFileEditor() {
  appBuilderPanel.style.display = 'none';
  fileEditorPanel.style.display = 'flex';

  fileEditorTab.style.borderBottom = '3px solid #28a745';
  fileEditorTab.style.fontWeight = 'bold';
  fileEditorTab.style.color = '#28a745';

  appBuilderTab.style.borderBottom = '3px solid transparent';
  appBuilderTab.style.fontWeight = 'normal';
  appBuilderTab.style.color = '#666';
}

appBuilderTab.onclick = switchToAppBuilder;
fileEditorTab.onclick = switchToFileEditor;

/* ================= FLOATING PANEL DRAG (Desktop + Mobile) ================= */
const panel = document.getElementById('floatingAI');
const dragHandle = document.getElementById('dragHandle');

let isDraggingPanel = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

// Desktop: Mouse events
dragHandle.addEventListener('mousedown', e => {
  // Don't drag if clicking buttons
  if (e.target.id === 'collapseBtn' || e.target.id === 'closeBtn') return;
  
  isDraggingPanel = true;
  dragOffsetX = e.clientX - panel.offsetLeft;
  dragOffsetY = e.clientY - panel.offsetTop;
  dragHandle.style.cursor = 'grabbing';
  e.preventDefault();
});

document.addEventListener('mousemove', e => {
  if (!isDraggingPanel) return;
  
  let newLeft = e.clientX - dragOffsetX;
  let newTop = e.clientY - dragOffsetY;
  
  const maxLeft = window.innerWidth - panel.offsetWidth;
  const maxTop = window.innerHeight - panel.offsetHeight;
  
  newLeft = Math.max(0, Math.min(newLeft, maxLeft));
  newTop = Math.max(0, Math.min(newTop, maxTop));
  
  panel.style.left = newLeft + 'px';
  panel.style.top = newTop + 'px';
});

document.addEventListener('mouseup', () => {
  isDraggingPanel = false;
  dragHandle.style.cursor = 'grab';
});

// Mobile: Touch events
dragHandle.addEventListener('touchstart', e => {
  // Don't drag if touching buttons
  if (e.target.id === 'collapseBtn' || e.target.id === 'closeBtn') return;
  
  isDraggingPanel = true;
  const touch = e.touches[0];
  dragOffsetX = touch.clientX - panel.offsetLeft;
  dragOffsetY = touch.clientY - panel.offsetTop;
  e.preventDefault();
});

document.addEventListener('touchmove', e => {
  if (!isDraggingPanel) return;
  
  const touch = e.touches[0];
  let newLeft = touch.clientX - dragOffsetX;
  let newTop = touch.clientY - dragOffsetY;
  
  const maxLeft = window.innerWidth - panel.offsetWidth;
  const maxTop = window.innerHeight - panel.offsetHeight;
  
  newLeft = Math.max(0, Math.min(newLeft, maxLeft));
  newTop = Math.max(0, Math.min(newTop, maxTop));
  
  panel.style.left = newLeft + 'px';
  panel.style.top = newTop + 'px';
  
  e.preventDefault();
});

document.addEventListener('touchend', () => {
  isDraggingPanel = false;
});

/* ================= RESIZE ================= */
const resizeHandleAI = document.getElementById('resizeHandleAI');
let isResizing = false;

resizeHandleAI.addEventListener('mousedown', e => {
  isResizing = true;
  e.preventDefault();
});

document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  let newHeight = e.clientY - panel.offsetTop;
  if (newHeight < 150) newHeight = 150;
  panel.style.height = newHeight + 'px';
});

document.addEventListener('mouseup', () => isResizing = false);

/* ================= AI APPLY CHANGES ================= */

// ‚úÖ SAFE URL FROM DJANGO
const FILE_CHAT_URL = "{% url 'webprojects:file_chat' project.id file.id %}";

function getCsrfToken() {
  return (
    document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
    document.querySelector('meta[name="csrf-token"]')?.content ||
    ''
  );
}

async function applyChanges() {
  const promptInput = document.getElementById('fileChatPrompt');
  const outputEl = document.getElementById('fileChatOutput');
  const applyBtn = document.getElementById('applyBtn');

  const prompt = promptInput.value.trim();
  if (!prompt) {
    alert("Please describe the changes you want");
    return;
  }

  applyBtn.disabled = true;
  applyBtn.textContent = 'Applying...';
  outputEl.style.display = 'block';
  outputEl.textContent += `\n‚è≥ Applying: "${prompt}"\n`;

  try {
    const res = await fetch(FILE_CHAT_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-CSRFToken": getCsrfToken()
      },
      credentials: "same-origin",
      body: JSON.stringify({
        prompt: prompt,
        apply: true
      })
    });

    const contentType = res.headers.get("content-type") || "";

    if (!contentType.includes("application/json")) {
      throw new Error("Server returned HTML instead of JSON");
    }

    const data = await res.json();

    if (data.status === "success" && data.code) {
      if (typeof editor !== 'undefined' && editor) {
        if (editor.setValue) {
          editor.setValue(data.code);
        } else if (editor.getModel) {
          editor.getModel().setValue(data.code);
        }
      }

      outputEl.textContent += "‚úÖ Changes applied and saved!\n\n";
      promptInput.value = "";
    } else {
      outputEl.textContent += `‚ùå Error: ${data.message || "Unknown error"}\n\n`;
    }

  } catch (err) {
    console.error(err);
    outputEl.textContent += `‚ùå Request failed: ${err.message}\n\n`;
  } finally {
    applyBtn.disabled = false;
    applyBtn.textContent = 'Apply Changes';
  }
}

document.getElementById('applyBtn').onclick = applyChanges;

document.getElementById('fileChatPrompt').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    applyChanges();
  }
});
</script>



  <!-- Output panel -->
  <div id="outputPanel" style="height: 100px; background: #1e1e1e; color: #dcdcdc; padding: 2px; overflow-y: auto; font-family: monospace; font-size: 0.9em; border-top: 1px solid #444;">
    <strong>üîΩ Output:</strong>
    <pre id="outputText" style="white-space: pre-wrap;"></pre>
    <div id="tablePreview" style="margin-top: 1px;display: none;"></div>
    <div id="plotPreview" style="display: none;"></div>
  </div>
</div>

<!-- XP HUD -->
<div id="xpHUD" style="
  position: fixed;
  top: 58px;
  right: 15px;
  background: #1a1a2e;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 8px 14px;
  z-index: 9997;
  font-size: 13px;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
">
  
</div>

<!-- +XP float popup -->
<div id="xpPopup" style="
  position: fixed;
  bottom: 130px;
  right: 30px;
  background: #f39c12;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 15px;
  z-index: 99999;
  display: none;
  pointer-events: none;
"></div>

<style>
@keyframes floatUp {
  0%   { opacity:1; transform:translateY(0);     }
  100% { opacity:0; transform:translateY(-60px); }
}
</style>

<script>
// Load XP on page start
async function loadXPStats() {
  try {
    const res  = await fetch("{% url 'webprojects:xp_stats' %}");
    const data = await res.json();
    if (data.status === 'success') {
      document.getElementById('xpTotal').textContent  = data.total_xp;
      document.getElementById('xpStreak').textContent = data.streak;
    }
  } catch(e) {}
}

// Show +XP floating text
function showXPGain(amount) {
  // ADD THIS ‚Äî pulse the HUD
  const hud = document.getElementById('xpHUD');
  hud.classList.remove('xp-pulse');
  hud.offsetHeight;
  hud.classList.add('xp-pulse');
  setTimeout(() => hud.classList.remove('xp-pulse'), 400);

  // existing code below unchanged
  const popup = document.getElementById('xpPopup');
  popup.textContent     = `+${amount} XP ‚ö°`;
  popup.style.display   = 'block';
  popup.style.animation = 'none';
  popup.offsetHeight;
  popup.style.animation = 'floatUp 1.2s ease forwards';
  setTimeout(() => { popup.style.display = 'none'; }, 1200);
}

// Update HUD when XP comes back from server
function handleXPResponse(xpData) {
  if (!xpData) return;
  document.getElementById('xpTotal').textContent  = xpData.total_xp;
  document.getElementById('xpStreak').textContent = xpData.streak;
  showXPGain(xpData.xp_gained);

  // Big celebration for topic complete
  if (xpData.xp_gained >= 100) {
    showToast(`üéâ Topic Complete! +100 XP ‚ö°`);
    launchConfetti();
  }

  // Streak milestone messages
  if (xpData.streak === 3)  showToast('üî• 3 Day Streak! Keep it up!');
  if (xpData.streak === 7)  showToast('‚ö° 7 Day Streak! You\'re on fire!');
  if (xpData.streak === 30) showToast('üíé 30 Day Streak! Legendary!');
}

function launchConfetti() {
  const colors = ['#f39c12','#e74c3c','#2ecc71','#3498db','#9b59b6'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.style.cssText = `
      position:fixed;
      top:-10px;
      left:${Math.random()*100}vw;
      width:${Math.random()*8+4}px;
      height:${Math.random()*8+4}px;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      border-radius:${Math.random()>0.5?'50%':'2px'};
      z-index:999999;
      pointer-events:none;
      animation:fall ${Math.random()*2+1}s linear forwards;
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }
}

// Add confetti CSS
const confettiStyle = document.createElement('style');
confettiStyle.textContent = `
  @keyframes fall {
    0%   { transform:translateY(0) rotate(0deg);    opacity:1; }
    100% { transform:translateY(100vh) rotate(720deg); opacity:0; }
  }
`;
document.head.appendChild(confettiStyle);

// Intercept fetch to catch XP from run_code and mark_topic responses
const _origFetch = window.fetch;
window.fetch = async function(...args) {
  const res = await _origFetch(...args);
  const url = typeof args[0] === 'string' ? args[0] : '';

  if (url.includes('run') || url.includes('mark-topic') || url.includes('mark_topic')) {
    res.clone().json().then(data => {
      if (data.xp) handleXPResponse(data.xp);
    }).catch(() => {});
  }
  return res;
};

document.addEventListener('DOMContentLoaded', loadXPStats);
</script>

    <!-- AI Suggestion Preview Modal -->
<div id="aiModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:#2d2d2d; color:#fff; padding:20px; border-radius:8px; z-index:1000; max-width:80%; box-shadow:0 0 10px #000;">
  <h3>üí° AI Suggestion Preview</h3>
  <pre id="aiModalContent" style="max-height:400px; overflow-y:auto; white-space:pre-wrap; background:#1e1e1e; padding:10px; border:1px solid #444;"></pre>
  <div style="text-align:right; margin-top:10px;">
    <button onclick="insertSuggestionFromModal()" style="background:#2ecc71; color:white; padding:6px 12px; border:none; border-radius:4px;">Insert</button>
    <button onclick="closeAIModal()" style="background:#e74c3c; color:white; padding:6px 12px; border:none; border-radius:4px; margin-left:8px;">Cancel</button>
  </div>
</div>

  </div>
</div>

<div id="toastMessage" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #222;
  color: #fff;
  padding: 10px 18px;
  border-radius: 6px;
  z-index: 9999;
  font-size: 0.9em;
  max-width: 90%;
  text-align: left;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
"></div>


<!-- js section -->

<!-- prompts js -->
<script>
// ============= FILE SWITCHING WITHOUT RELOAD =============
let currentFileId = {{ file.id }};
let currentProjectId = {{ file.project.id }};

async function loadFile(projectId, fileId, fileName) {
  if (fileId === currentFileId) return;
  
  // Add loading indicator
  const link = document.querySelector(`[data-file-id="${fileId}"]`);
  if (link) link.classList.add('loading');
  
  showToast('‚è≥ Loading ' + fileName + '...');
  
  // Save current file before switching
  if (editor && lastSavedContent !== editor.getValue()) {
    await performAutoSave();
  }
  
  try {
    const response = await fetch(`/webprojects/project/${projectId}/file/${fileId}/content/`);
    const data = await response.json();
    
    if (data.status === 'success') {
      const fileData = data.file;
      
      if (editor) {
        editor.setValue(fileData.content);
        const model = editor.getModel();
        monaco.editor.setModelLanguage(model, fileData.language);
        lastSavedContent = fileData.content;
      }
      
      currentFileId = fileData.id;
      currentProjectId = projectId;
      
      updateActiveFileUI(fileId, fileName);
      updateURL(projectId, fileId);
      clearOutput();
      
      showToast('‚úÖ Loaded ' + fileName);
    } else {
      showToast('‚ùå Failed to load file: ' + data.message);
    }
  } catch (error) {
    console.error('Error loading file:', error);
    showToast('‚ùå Error loading file');
  } finally {
    // Remove loading indicator
    if (link) link.classList.remove('loading');
  }
}

function updateActiveFileUI(fileId, fileName) {
  // Remove highlight from all files
  document.querySelectorAll('.file-link').forEach(link => {
    link.style.fontWeight = 'normal';
    link.style.color = '';
  });
  
  // Highlight active file
  const activeLink = document.querySelector(`[data-file-id="${fileId}"]`);
  if (activeLink) {
    activeLink.style.fontWeight = 'bold';
    activeLink.style.color = '#3498db';
  }
  
  // Update page title
  document.title = fileName + ' | Code Editor';
  
  // Update file name display in navbar
  const fileNameDisplay = document.querySelector('.project-info span:last-child');
  if (fileNameDisplay) {
    fileNameDisplay.textContent = 'üìù ' + fileName;
  }
}

function updateURL(projectId, fileId) {
  // Update browser URL without reload (allows bookmarking/back button)
  const newUrl = `/webprojects/${projectId}/file/${fileId}/`;
  window.history.pushState(
    { projectId, fileId }, 
    '', 
    newUrl
  );
}

function clearOutput() {
  // Clear output panel when switching files
  const outputText = document.getElementById('outputText');
  const plotPreview = document.getElementById('plotPreview');
  const tablePreview = document.getElementById('tablePreview');
  
  if (outputText) outputText.textContent = '';
  if (plotPreview) plotPreview.innerHTML = '';
  if (tablePreview) {
    tablePreview.innerHTML = '';
    tablePreview.style.display = 'none';
  }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
  if (event.state && event.state.fileId) {
    // User clicked back/forward - load that file
    const link = document.querySelector(`[data-file-id="${event.state.fileId}"]`);
    if (link) {
      const fileName = link.textContent.trim().replace('üìù ', '');
      loadFile(event.state.projectId, event.state.fileId, fileName);
    }
  }
});

// Initialize history state
window.history.replaceState(
  { projectId: currentProjectId, fileId: currentFileId },
  '',
  window.location.pathname
);

console.log('‚úÖ File switching initialized');
</script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const runButton = document.getElementById("runAIPrompt");
    const aiPrompt = document.getElementById("aiPrompt");
    const preview = document.getElementById("preview");

    const FILE_ID = {{ file.id }};
    const PROJECT_ID = {{ project.id }};
    const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // ‚úÖ Helper: Render into iframe
    function renderPreview(html, css, js) {
      preview.srcdoc = `
        <html>
          <head>
            <style>${css || ""}</style>
          </head>
          <body>
            ${html || ""}
            <script>${js || ""}<\/script>
          </body>
        </html>`;
    }

    

    // ‚úÖ Run AI and update project
    runButton.addEventListener("click", async () => {
      const promptText = aiPrompt.value.trim();
      if (!promptText) return alert("Enter a prompt");

      runButton.disabled = true;
      runButton.textContent = "Generating...";

      try {
        const res = await fetch(`/webprojects/${PROJECT_ID}/file/${FILE_ID}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ file_id: FILE_ID, prompt: promptText })
        });

        const data = await res.json();
        console.log("AI Response:", data);

        if (data.status === "success" && data.ai_content) {
          // ‚úÖ Render new AI output immediately
          renderPreview(
            data.ai_content.html,
            data.ai_content.css,
            data.ai_content.js
          );
        } else {
          alert("AI generation failed: " + (data.message || JSON.stringify(data)));
        }

      } catch (err) {
        console.error(err);
        alert("Error contacting AI backend: " + err.message);
      } finally {
        runButton.disabled = false;
        runButton.textContent = "‚ú® Generate";
      }
    });

  });
</script>

<!-- side content js -->

<script>
function toggleDesc(id, el, lang) {
  const desc = document.getElementById(id);
  const topicId = parseInt(id.replace('topic-', ''), 10);

  if (desc.style.display === "none") {
    desc.style.display = "block";
    el.querySelector(".toggle-icon").textContent = "‚ûñ";

    // ‚îÄ‚îÄ Auto-click Study This Topic when opening ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const btn = document.getElementById('topic-btn-' + topicId);
    if (btn && btn.textContent.trim().includes('üìö Study This Topic')) {
      // Only auto-study if not already studying or completed
      btn.click();
    }

    // ‚îÄ‚îÄ Defer Prism highlighting so UI opens instantly ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    setTimeout(() => {
      const codeEl = desc.querySelector('code');
      if (codeEl) {
        codeEl.className = 'language-' + lang;
        Prism.highlightElement(codeEl);
      }
    }, 50);

  } else {
    desc.style.display = "none";
    el.querySelector(".toggle-icon").textContent = "‚ûï";
  }
}

</script>

<!-- your sidebar content below... -->
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const editorLayout = document.getElementById('editorLayout');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const sidebar = document.querySelector('.sidebar'); // Add your sidebar selector
    const resizeHandle = document.createElement('div');
    
    // Create resize handle
    resizeHandle.className = 'resize-handle';
    resizeHandle.style.cssText = `
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: transparent;
      z-index: 10;
    `;
    resizeHandle.onmouseenter = () => resizeHandle.style.background = '#4fa';
    resizeHandle.onmouseleave = () => resizeHandle.style.background = 'transparent';
    
    sidebar.style.position = 'relative';
    sidebar.appendChild(resizeHandle);

    // Resize functionality
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      startX = e.clientX;
      startWidth = sidebar.offsetWidth;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      
      const width = startWidth + (e.clientX - startX);
      const minWidth = 200; // Minimum sidebar width
      const maxWidth = 950; // Maximum sidebar width
      
      if (width >= minWidth && width <= maxWidth) {
        sidebar.style.width = width + 'px';
        sidebar.style.flexBasis = width + 'px';
        sidebar.style.minWidth = width + 'px';
        
        // Relayout Monaco Editor during resize
        if (window.editor?.layout) {
          window.editor.layout();
        }
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Save width to localStorage
        localStorage.setItem('sidebarWidth', sidebar.offsetWidth);
      }
    });

    // Restore saved width
    const savedWidth = localStorage.getItem('sidebarWidth');
    if (savedWidth) {
      sidebar.style.width = savedWidth + 'px';
      sidebar.style.flexBasis = savedWidth + 'px';
      sidebar.style.minWidth = savedWidth + 'px';
    }

    // Toggle sidebar
    const updateToggleIcon = (isCollapsed) => {
      toggleBtn.innerHTML = isCollapsed 
        ? '<span title="Open Sidebar">‚ò∞</span>' 
        : '<span title="Close Sidebar">‚úñ</span>';
    };

    toggleBtn.addEventListener('click', () => {
      const isCollapsed = editorLayout.classList.toggle('collapsed');
      updateToggleIcon(isCollapsed);

      // Relayout Monaco Editor
      setTimeout(() => {
        if (window.editor?.layout) {
          window.editor.layout();
        }
      }, 100);
    });

    // Initial state
    updateToggleIcon(editorLayout.classList.contains('collapsed'));
  });
</script>

<script>
  function showImageModal(imgUrl) {
    document.getElementById('popupImage').src = imgUrl;
    document.getElementById('imagePopupModal').style.display = 'block';
  }

  function closeImageModal() {
    document.getElementById('imagePopupModal').style.display = 'none';
    document.getElementById('popupImage').src = "";
  }
</script>

<script>
// function getAISuggestion() {
//   alert("AI Suggestion not implemented yet.");
// }
// function explainCode() {
//   alert("Explain Code not implemented yet.");
// }
function runAIAction() {
  const action = document.getElementById("aiAction").value;
  alert("Run AI Action (" + action + ") not implemented yet.");
}


// Helper: Find which line has the syntax error
function findErrorLine(code) {
  const lines = code.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // Skip empty lines and comments
    if (!line || line.startsWith('#')) continue;
    
    // Check for unclosed parentheses
    const openParens = (line.match(/\(/g) || []).length;
    const closeParens = (line.match(/\)/g) || []).length;
    if (openParens !== closeParens) return i + 1;
    
    // Check for unclosed quotes (simple check)
    let inString = false;
    let quoteChar = null;
    for (let j = 0; j < line.length; j++) {
      const char = line[j];
      const prevChar = j > 0 ? line[j - 1] : null;
      
      if ((char === '"' || char === "'") && prevChar !== '\\') {
        if (!inString) {
          inString = true;
          quoteChar = char;
        } else if (char === quoteChar) {
          inString = false;
          quoteChar = null;
        }
      }
    }
    if (inString) return i + 1; // Unclosed string
    
    // Check for unclosed brackets
    const openBrackets = (line.match(/\[/g) || []).length;
    const closeBrackets = (line.match(/\]/g) || []).length;
    if (openBrackets !== closeBrackets) return i + 1;
    
    // Check for unclosed braces
    const openBraces = (line.match(/\{/g) || []).length;
    const closeBraces = (line.match(/\}/g) || []).length;
    if (openBraces !== closeBraces) return i + 1;
  }
  
  return -1; // No error found
}

// Helper function to detect common syntax errors
function checkForSyntaxErrors(code) {
  return findErrorLine(code) > 0;
}

// Helper: Append code to the end with proper spacing
function appendToEnd(code) {
  const lastLine = editor.getModel().getLineCount();
  const lastLineContent = editor.getModel().getLineContent(lastLine);
  const needsNewline = lastLineContent.trim() !== '';
  
  editor.executeEdits('hint-suggestion', [{
    range: new monaco.Range(lastLine + 1, 1, lastLine + 1, 1),
    text: (needsNewline ? '\n' : '') + code,
    forceMoveMarkers: true
  }]);
  
  // Scroll to the new code
  setTimeout(() => {
    const newLastLine = editor.getModel().getLineCount();
    editor.revealLineInCenter(newLastLine);
  }, 100);
}

// Helper: Find which line has the syntax error
function findErrorLine(code) {
  const lines = code.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // Check for unclosed parentheses
    const openParens = (line.match(/\(/g) || []).length;
    const closeParens = (line.match(/\)/g) || []).length;
    if (openParens !== closeParens) return i + 1;
    
    // Check for unclosed quotes
    const singleQuotes = (line.match(/(?<!\\)'/g) || []).length;
    const doubleQuotes = (line.match(/(?<!\\)"/g) || []).length;
    if (singleQuotes % 2 !== 0 || doubleQuotes % 2 !== 0) return i + 1;
    
    // Check for unclosed brackets
    const openBrackets = (line.match(/\[/g) || []).length;
    const closeBrackets = (line.match(/\]/g) || []).length;
    if (openBrackets !== closeBrackets) return i + 1;
  }
  
  return -1; // No error found
}

// Helper: Parse AI suggestion into fixed code vs new code
function parseSuggestion(suggestion, currentCode) {
  const suggestionLines = suggestion.split('\n');
  const currentLines = currentCode.split('\n');
  
  let fixedCode = '';
  let newCode = '';
  let foundDifference = false;
  
  // Try to identify which part is "fixing" existing code vs adding new code
  for (let i = 0; i < suggestionLines.length; i++) {
    const sugLine = suggestionLines[i].trim();
    
    // Check if this line looks like a fix of an existing line
    if (!foundDifference && i < currentLines.length) {
      const currLine = currentLines[i].trim();
      
      // If lines are similar (fixing syntax), this is the fixed code
      if (areSimilarLines(currLine, sugLine) && currLine !== sugLine) {
        fixedCode = suggestionLines[i];
        foundDifference = true;
        continue;
      }
    }
    
    // Everything else is new code
    if (foundDifference || i >= currentLines.length) {
      newCode += (newCode ? '\n' : '') + suggestionLines[i];
    }
  }
  
  return { fixedCode, newCode };
}

// Helper: Check if two lines are similar (same variable names, structure)
function areSimilarLines(line1, line2) {
  // Remove whitespace and compare structure
  const normalized1 = line1.replace(/\s+/g, '').toLowerCase();
  const normalized2 = line2.replace(/\s+/g, '').toLowerCase();
  
  // Check if they share significant portions
  const shorter = normalized1.length < normalized2.length ? normalized1 : normalized2;
  const longer = normalized1.length >= normalized2.length ? normalized1 : normalized2;
  
  // If 70% of the shorter string is in the longer string, they're similar
  let matchCount = 0;
  for (let i = 0; i < shorter.length; i++) {
    if (longer.includes(shorter[i])) matchCount++;
  }
  
  return (matchCount / shorter.length) > 0.7;
}

// Helper function to detect common syntax errors (keep existing)
function checkForSyntaxErrors(code) {
  const lines = code.split('\n');
  
  for (let line of lines) {
    const trimmed = line.trim();
    
    // Check for unclosed parentheses
    const openParens = (trimmed.match(/\(/g) || []).length;
    const closeParens = (trimmed.match(/\)/g) || []).length;
    if (openParens !== closeParens) return true;
    
    // Check for unclosed quotes
    const singleQuotes = (trimmed.match(/(?<!\\)'/g) || []).length;
    const doubleQuotes = (trimmed.match(/(?<!\\)"/g) || []).length;
    if (singleQuotes % 2 !== 0 || doubleQuotes % 2 !== 0) return true;
    
    // Check for unclosed brackets
    const openBrackets = (trimmed.match(/\[/g) || []).length;
    const closeBrackets = (trimmed.match(/\]/g) || []).length;
    if (openBrackets !== closeBrackets) return true;
    
    // Check for unclosed braces
    const openBraces = (trimmed.match(/\{/g) || []).length;
    const closeBraces = (trimmed.match(/\}/g) || []).length;
    if (openBraces !== closeBraces) return true;
  }
  
  return false;
}


function showMoreHints() {
  // Request a different type of hint
  getSmartHint();
}

function closeHintPanel() {
  document.getElementById('hintPanel').style.display = 'none';
  document.getElementById('hintOverlay').style.display = 'none';
  currentHintSuggestion = null;

  
}
// ============= HINT PANEL DRAG & RESIZE =============
let isDraggingHint = false;
let isResizingHint = false;
let hintDragOffsetX = 0;
let hintDragOffsetY = 0;
let hintStartWidth = 0;
let hintStartHeight = 0;
let hintStartX = 0;
let hintStartY = 0;

// Initialize drag and resize handlers
document.addEventListener('DOMContentLoaded', function() {
  const hintPanel = document.getElementById('hintPanel');
  const dragHandle = document.getElementById('hintDragHandle');
  const resizeHandle = document.getElementById('hintResizeHandle');
  
  if (!hintPanel || !dragHandle) return;
  
  // ========== DRAG FUNCTIONALITY (Desktop + Mobile) ==========
  
  // Mouse events (Desktop)
  dragHandle.addEventListener('mousedown', startDragging);
  
  // Touch events (Mobile)
  dragHandle.addEventListener('touchstart', startDraggingTouch);
  
  function startDragging(e) {
    // Don't drag if clicking the close button
    if (e.target.tagName === 'BUTTON') return;
    
    isDraggingHint = true;
    hintPanel.classList.add('dragging');
    
    hintDragOffsetX = e.clientX - hintPanel.offsetLeft;
    hintDragOffsetY = e.clientY - hintPanel.offsetTop;
    
    e.preventDefault();
  }
  
  function startDraggingTouch(e) {
    if (e.target.tagName === 'BUTTON') return;
    
    isDraggingHint = true;
    hintPanel.classList.add('dragging');
    
    const touch = e.touches[0];
    hintDragOffsetX = touch.clientX - hintPanel.offsetLeft;
    hintDragOffsetY = touch.clientY - hintPanel.offsetTop;
    
    e.preventDefault();
  }
  
  // Mouse move
  document.addEventListener('mousemove', function(e) {
    if (!isDraggingHint) return;
    
    let newLeft = e.clientX - hintDragOffsetX;
    let newTop = e.clientY - hintDragOffsetY;
    
    // Keep within viewport bounds
    const maxLeft = window.innerWidth - hintPanel.offsetWidth;
    const maxTop = window.innerHeight - hintPanel.offsetHeight;
    
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop = Math.max(0, Math.min(newTop, maxTop));
    
    hintPanel.style.left = newLeft + 'px';
    hintPanel.style.top = newTop + 'px';
    hintPanel.style.right = 'auto'; // Remove right positioning
  });
  
  // Touch move
  document.addEventListener('touchmove', function(e) {
    if (!isDraggingHint) return;
    
    const touch = e.touches[0];
    let newLeft = touch.clientX - hintDragOffsetX;
    let newTop = touch.clientY - hintDragOffsetY;
    
    const maxLeft = window.innerWidth - hintPanel.offsetWidth;
    const maxTop = window.innerHeight - hintPanel.offsetHeight;
    
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop = Math.max(0, Math.min(newTop, maxTop));
    
    hintPanel.style.left = newLeft + 'px';
    hintPanel.style.top = newTop + 'px';
    hintPanel.style.right = 'auto';
    
    e.preventDefault();
  });
  
  // Mouse up
  document.addEventListener('mouseup', function() {
    if (isDraggingHint) {
      isDraggingHint = false;
      hintPanel.classList.remove('dragging');
    }
    if (isResizingHint) {
      isResizingHint = false;
    }
  });
  
  // Touch end
  document.addEventListener('touchend', function() {
    if (isDraggingHint) {
      isDraggingHint = false;
      hintPanel.classList.remove('dragging');
    }
    if (isResizingHint) {
      isResizingHint = false;
    }
  });
  
  // ========== RESIZE FUNCTIONALITY ==========
  
  if (resizeHandle) {
    // Mouse events
    resizeHandle.addEventListener('mousedown', function(e) {
      isResizingHint = true;
      hintStartWidth = hintPanel.offsetWidth;
      hintStartHeight = hintPanel.offsetHeight;
      hintStartX = e.clientX;
      hintStartY = e.clientY;
      e.preventDefault();
      e.stopPropagation();
    });
    
    // Touch events
    resizeHandle.addEventListener('touchstart', function(e) {
      isResizingHint = true;
      hintStartWidth = hintPanel.offsetWidth;
      hintStartHeight = hintPanel.offsetHeight;
      const touch = e.touches[0];
      hintStartX = touch.clientX;
      hintStartY = touch.clientY;
      e.preventDefault();
      e.stopPropagation();
    });
    
    // Mouse move for resize
    document.addEventListener('mousemove', function(e) {
      if (!isResizingHint) return;
      
      const deltaX = e.clientX - hintStartX;
      const deltaY = e.clientY - hintStartY;
      
      let newWidth = hintStartWidth + deltaX;
      let newHeight = hintStartHeight + deltaY;
      
      // Min and max constraints
      newWidth = Math.max(300, Math.min(newWidth, 800));
      newHeight = Math.max(300, Math.min(newHeight, window.innerHeight - 100));
      
      hintPanel.style.width = newWidth + 'px';
      hintPanel.style.maxHeight = newHeight + 'px';
      
      // Adjust content height
      const contentHeight = newHeight - 180; // Account for header and actions
      document.getElementById('hintContent').style.maxHeight = contentHeight + 'px';
    });
    
    // Touch move for resize
    document.addEventListener('touchmove', function(e) {
      if (!isResizingHint) return;
      
      const touch = e.touches[0];
      const deltaX = touch.clientX - hintStartX;
      const deltaY = touch.clientY - hintStartY;
      
      let newWidth = hintStartWidth + deltaX;
      let newHeight = hintStartHeight + deltaY;
      
      newWidth = Math.max(300, Math.min(newWidth, 800));
      newHeight = Math.max(300, Math.min(newHeight, window.innerHeight - 100));
      
      hintPanel.style.width = newWidth + 'px';
      hintPanel.style.maxHeight = newHeight + 'px';
      
      const contentHeight = newHeight - 180;
      document.getElementById('hintContent').style.maxHeight = contentHeight + 'px';
      
      e.preventDefault();
    });
  }
});

// Update closeHintPanel to show overlay
function closeHintPanel() {
  document.getElementById('hintPanel').style.display = 'none';
  const overlay = document.getElementById('hintOverlay');
  if (overlay) overlay.style.display = 'none';
  currentHintSuggestion = null;
}
</script>


<script>
// ============= GLOBAL VARIABLES =============
let editor;
let currentTheme = localStorage.getItem('editorTheme') || 'vs-dark';
let autoSaveInterval;
let lastSavedContent = '';
let saveIndicator = null;

// ============= UTILITY FUNCTIONS (Define First) =============
function getLanguage(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  switch (ext) {
    case "py": return "python";
    case "js": return "javascript";
    case "html": return "html";
    case "css": return "css";
    case "json": return "json";
    default: return "plaintext";
  }
}

function updateThemeButton(theme) {
  const themeText = document.getElementById('themeToggleText');
  const isDark = theme === 'vs-dark';
  
  if (themeText) {
    themeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
  }
}

function escapeHTML(str) {
  return String(str).replace(/[&<>"']/g, tag => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[tag]));
}

// ============= AUTO-SAVE FUNCTIONS =============
function createSaveIndicator() {
  if (!saveIndicator) {
    saveIndicator = document.createElement('div');
    saveIndicator.id = 'saveIndicator';
    saveIndicator.style.cssText = `
      position: fixed;
      top: 60px;
      right: 20px;
      padding: 8px 15px;
      background: rgba(46, 204, 113, 0.9);
      color: white;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(saveIndicator);
  }
  return saveIndicator;
}



function showSaveStatus(message, isError = false) {
  const indicator = createSaveIndicator();
  indicator.textContent = message;
  indicator.style.background = isError 
    ? 'rgba(231, 76, 60, 0.9)' 
    : 'rgba(46, 204, 113, 0.9)';
  indicator.style.opacity = '1';
  indicator.style.display = 'block'; // ‚úÖ ADD THIS
  
  setTimeout(() => {
    indicator.style.opacity = '0';
    setTimeout(() => {
      indicator.style.display = 'none'; // ‚úÖ ADD THIS
    }, 300);
  }, 2000);
}


let isSaving = false; // Prevent overlapping saves

async function performAutoSave() {
  // Skip if already saving
  if (isSaving) {
    console.log("‚è≠Ô∏è Save already in progress - skipping");
    return;
  }
  
  if (!editor) {
    console.log("‚è≠Ô∏è Editor not ready yet");
    return;
  }

  const currentContent = editor.getValue();
  
  if (currentContent === lastSavedContent) {
    console.log("‚è≠Ô∏è Skipped - No changes");
    return;
  }
  
  isSaving = true; // Lock
  console.log("üíæ Attempting auto-save...");
  
  try {
    const response = await fetch("{% url 'webprojects:file_autosave' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        file_id: currentFileId,
        content: currentContent
      }),
      // ‚úÖ CRITICAL: Don't wait for response
      keepalive: true
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    
    if (data.status === "success") {
      lastSavedContent = currentContent;
      const time = new Date().toLocaleTimeString();
      console.log(`‚úÖ Saved at ${time}`);
      
      // ‚úÖ Show subtle indicator (not blocking toast)
      showSaveIndicator(time);
    }
    
  } catch (err) {
    console.error("‚ùå Save error:", err);
  } finally {
    isSaving = false; // Unlock
  }
}

// ‚úÖ Non-blocking save indicator (top-right corner)
function showSaveIndicator(time) {
  let indicator = document.getElementById('save-indicator');
  
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.id = 'save-indicator';
    indicator.style.cssText = `
      position: fixed;
      top: 65px;
      right: 20px;
      padding: 4px 10px;
      background: rgba(46, 204, 113, 0.95);
      color: white;
      border-radius: 4px;
      font-size: 11px;
      z-index: 9999;
      transition: opacity 0.3s;
      pointer-events: none;
    `;
    document.body.appendChild(indicator);
  }
  
  indicator.textContent = `üíæ ${time}`;
  indicator.style.opacity = '1';
  
  // Fade out after 2 seconds
  setTimeout(() => {
    indicator.style.opacity = '0.3';
  }, 2000);
}

// ============= MONACO EDITOR INITIALIZATION =============
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });

require(['vs/editor/editor.main'], function () {
  console.log("‚úÖ Monaco Editor loaded");
  
  editor = monaco.editor.create(document.getElementById('container'), {
  value: `{{ file.content|escapejs }}`,
  language: getLanguage("{{ file.name }}"),
  theme: currentTheme,
  automaticLayout: true,
  readOnly: false,
  
  // ‚úÖ PERFORMANCE OPTIMIZATIONS:
  minimap: { enabled: false },              // Disable minimap
  quickSuggestions: false,                  // Disable auto-complete while typing
  wordBasedSuggestions: false,              // Disable word suggestions
  parameterHints: { enabled: false },       // Disable parameter hints
  suggestOnTriggerCharacters: true,         // Only suggest on . or (
  acceptSuggestionOnCommitCharacter: false, // Don't auto-accept suggestions
  tabCompletion: "off",                     // Disable tab completion
  wordWrap: "on",                           // Enable word wrap (easier on eyes)
  scrollBeyondLastLine: false,              // Don't scroll past end
  folding: false,                           // Disable code folding
  renderLineHighlight: "none",              // Don't highlight current line
  occurrencesHighlight: false,              // Don't highlight word occurrences
  renderWhitespace: "none",                 // Don't show whitespace
  codeLens: false,                          // Disable code lens
});

  console.log("‚úÖ Editor created");

  // Apply theme to page
  applyPageTheme(currentTheme);
  updateThemeButton(currentTheme);

  // Initialize autosave after editor is ready
  setTimeout(() => {
    lastSavedContent = editor.getValue();
    console.log("‚úÖ Initial content loaded, length:", lastSavedContent.length);
  

// ============= ERROR LINE HIGHLIGHTING =============
let errorDecoration = [];

function highlightErrorLine(lineNumber) {
  if (!editor || !lineNumber) return;
  
  console.log(`üé® Highlighting line ${lineNumber}`);
  
  // Clear previous decorations
  errorDecoration = editor.deltaDecorations(errorDecoration, []);
  
  // Add new decoration (red background + wavy underline)
  errorDecoration = editor.deltaDecorations([], [
    {
      range: new monaco.Range(lineNumber, 1, lineNumber, 1000),
      options: {
        isWholeLine: true,
        className: 'error-line-highlight',
        glyphMarginClassName: 'error-line-glyph',
        linesDecorationsClassName: 'error-line-decoration'
      }
    }
  ]);
  
  // Scroll to error line
  editor.revealLineInCenter(lineNumber);
  
  // Auto-remove after 10 seconds
  setTimeout(() => {
    clearErrorHighlight();
  }, 10000);
}

function clearErrorHighlight() {
  if (errorDecoration.length > 0) {
    errorDecoration = editor.deltaDecorations(errorDecoration, []);
    console.log("üßπ Cleared error highlight");
  }
}

// ============= SMART AI TUTOR =============
let hintTimeout = null;
let lastAnalyzedCode = '';
let isAnalyzing = false;

// Listen to code changes
// Listen to code changes
// editor.onDidChangeModelContent(() => {
//   clearTimeout(hintTimeout);
  
//   hintTimeout = setTimeout(() => {
//     analyzeCodeInRealTime();
//   }, 10000); // ‚úÖ 10 seconds - much less CPU usage
// });

// Find this function and REPLACE it:
async function analyzeCodeInRealTime() {
  if (!editor) {
    console.log("Editor not ready");
    return;
  }

  const code = editor.getValue();
  
  if (code === lastAnalyzedCode || isAnalyzing) {
    return;
  }
  
  if (!code.trim()) {
    closeSmartHint();
    clearErrorHighlight();
    return;
  }
  
  isAnalyzing = true;
  lastAnalyzedCode = code;
  
  const selection = editor.getSelection();
  const cursorLine = selection.startLineNumber;
  
  // Detect syntax errors
  const errorData = detectSyntaxError(code);
  
  // Highlight error line if exists
  if (errorData) {
    highlightErrorLine(errorData.lineNumber);
  } else {
    clearErrorHighlight();
  }
  
  // ‚úÖ GET CURRENT TOPIC ID
  const currentTopicId = window._currentTopicId || localStorage.getItem('currentTopicId');
  
  console.log("Detected error:", errorData);
  console.log("üìç Current Topic ID:", currentTopicId);  // ‚Üê Debug log
  
  try {
    const response = await fetch("{% url 'webprojects:get_contextual_hint' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        code: code,
        file_id: currentFileId,
        cursor_line: cursorLine,
        error: errorData ? errorData.message : null,
        current_topic_id: currentTopicId ? parseInt(currentTopicId) : null  // ‚Üê SEND TOPIC ID
      })
    });
    
    const data = await response.json();
    
    console.log("Backend response:", data);  // ‚Üê Debug log
    
    if (data.status === 'success') {
      showSmartHint(data.hint, data.type, data.topic);
    }
  } catch (err) {
    console.error('‚ùå Fetch error:', err);
  } finally {
    isAnalyzing = false;
  }
}


function detectSyntaxError(code) {
  /**
   * Returns: { message: string, lineNumber: number } or null
   */
  
  const lines = code.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    const lineNum = i + 1;
    
    // Skip empty lines and comments
    if (!line || line.startsWith('#')) continue;
    
    // 1. Unclosed parentheses
    const openParens = (line.match(/\(/g) || []).length;
    const closeParens = (line.match(/\)/g) || []).length;
    if (openParens > closeParens) {
      return {
        message: `Line ${lineNum}: Missing closing parenthesis ')'`,
        lineNumber: lineNum
      };
    }
    if (closeParens > openParens) {
      return {
        message: `Line ${lineNum}: Extra closing parenthesis ')'`,
        lineNumber: lineNum
      };
    }
    
    // 2. Unclosed quotes
    const singleQuotes = (line.match(/(?<!\\)'/g) || []).length;
    const doubleQuotes = (line.match(/(?<!\\)"/g) || []).length;
    if (singleQuotes % 2 !== 0) {
      return {
        message: `Line ${lineNum}: Unclosed single quote '`,
        lineNumber: lineNum
      };
    }
    if (doubleQuotes % 2 !== 0) {
      return {
        message: `Line ${lineNum}: Unclosed double quote "`,
        lineNumber: lineNum
      };
    }
    
    // 3. Missing colon
    if (/^(if|elif|else|for|while|def|class)\s+/.test(line) && !line.endsWith(':')) {
      return {
        message: `Line ${lineNum}: Missing colon ':' at end of statement`,
        lineNumber: lineNum
      };
    }
    
    // 4. Print without parentheses
    if (/^print\s+[^(]/.test(line)) {
      return {
        message: `Line ${lineNum}: print needs parentheses. Use: print(...)`,
        lineNumber: lineNum
      };
    }
  }
  
  return null;
}



function showSmartHint(hint, type, topic) {
  const panel = document.getElementById('smartHintPanel');
  const content = document.getElementById('hintContent');
  const topicDiv = document.getElementById('hintTopic');
  const icon = document.getElementById('hintIcon');
  const title = document.getElementById('hintTitle');
  
  if (!panel || !content) {
    console.error("Smart hint panel elements not found");
    return;
  }
  
  // Clear any existing timeout
  if (window.hintAutoHideTimeout) {
    clearTimeout(window.hintAutoHideTimeout);
  }
  
  // Remove all hint type classes
  panel.classList.remove('hint-error', 'hint-success', 'hint-next-step');
  
  // Set content
  content.innerHTML = escapeHTML(hint);
  
  // Set icon and style based on type
  switch(type) {
    case 'error':
      icon.textContent = '‚ö†Ô∏è';
      title.textContent = 'Error Detected';
      title.style.color = '#e74c3c';
      panel.classList.add('hint-error');
      break;
    case 'start':
      icon.textContent = 'üöÄ';
      title.textContent = 'Getting Started';
      title.style.color = '#27ae60';
      panel.classList.add('hint-success');
      break;
    case 'next_step':
      icon.textContent = 'üí°';
      title.textContent = 'Next Step';
      title.style.color = '#3498db';
      panel.classList.add('hint-next-step');
      break;
    case 'improvement':
      icon.textContent = '‚ú®';
      title.textContent = 'Suggestion';
      title.style.color = '#27ae60';
      panel.classList.add('hint-success');
      break;
    default:
      icon.textContent = 'üí°';
      title.textContent = 'AI Tutor';
      title.style.color = '#2c3e50';
  }
  
  // Show topic context
  if (topic) {
    topicDiv.innerHTML = `üìö Lesson: ${escapeHTML(topic)}`;
    topicDiv.style.display = 'block';
  } else {
    topicDiv.style.display = 'none';
  }
  
  // Show panel
  panel.style.display = 'block';
  
  // ‚úÖ SPEAK WITH CALLBACK - Wait for speech to finish before auto-hiding
// ‚úÖ SPEAK WITH CALLBACK - Wait for speech to finish before auto-hiding
  window.speakText(hint, () => {
    console.log("Speech completed for hint");
    
    // Auto-hide ONLY for non-errors, after speech finishes
    if (type !== 'error') {
      window.hintAutoHideTimeout = setTimeout(() => {
        if (panel.style.display === 'block' && !window.speechSynthesis.speaking) {
          closeSmartHint();
        }
      }, 5000); // Wait 5 more seconds after speech ends
    }
  });
} // ‚Üê closes showSmartHint


function closeSmartHint() {
  const panel = document.getElementById('smartHintPanel');
  if (panel) panel.style.display = 'none';
  window.speechSynthesis.cancel();
}

// ============= TEXT-TO-SPEECH =============
// ============= TEXT-TO-SPEECH =============


let voicesLoaded = false;
let availableVoices = [];



// Initialize voices when page loads
// ‚úÖ REPLACE WITH THIS:
// Speech is already initialized by the window.speakText system
if ('speechSynthesis' in window) {
  console.log('‚úÖ Speech synthesis available');
}


// Load voices (needed for some browsers)
window.speechSynthesis.onvoiceschanged = () => {
  console.log("Voices loaded:", window.speechSynthesis.getVoices().length);
};



function closeSmartHint() {
  const panel = document.getElementById('smartHintPanel');
  if (panel) {
    panel.style.display = 'none';
  }
  
  // Stop speaking when panel is closed
  window.speechSynthesis.cancel();
}


// Manual trigger button (add to toolbar)
function getManualHint() {
  lastAnalyzedCode = ''; // Force new analysis
  analyzeCodeInRealTime();
}


console.log('‚úÖ Smart AI Tutor initialized');  
    // Start autosave interval (every 5 seconds)
    autoSaveInterval = setInterval(performAutoSave, 1500); // 10 seconds instead of 5
    console.log("‚úÖ Auto-save interval started");
    
    // Debounced save on typing
    let typingTimer;
    editor.onDidChangeModelContent(() => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        console.log("User stopped typing, triggering save...");
        performAutoSave();
      }, 5000);
    });
    
    // Save before leaving page
    window.addEventListener('beforeunload', (e) => {
      if (editor.getValue() !== lastSavedContent) {
        console.log("Saving before page unload...");
        performAutoSave();
      }
    });
    
  }, 500);

  
  // === HTML COMPLETIONS ===
  monaco.languages.registerCompletionItemProvider('html', {
    triggerCharacters: ['<', '"', "'", ' ', ':', '.', '{'],
    provideCompletionItems: function (model, position) {
      const textUntilPosition = model.getValueInRange({
        startLineNumber: 1,
        startColumn: 1,
        endLineNumber: position.lineNumber,
        endColumn: position.column
      });

      const htmlTags = [
        'html', 'head', 'body', 'title', 'meta', 'link', 'style', 'script',
        'header', 'nav', 'main', 'footer', 'section', 'article', 'aside',
        'div', 'span', 'p', 'a', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
        'ul', 'ol', 'li', 'strong', 'em', 'br', 'hr',
        'form', 'input', 'textarea', 'label', 'button', 'select', 'option',
        'img', 'video', 'audio', 'canvas', 'iframe',
        'table', 'thead', 'tbody', 'tr', 'th', 'td'
      ];

      const voidTags = ['meta', 'link', 'br', 'hr', 'img', 'input'];

      const tagSuggestions = htmlTags.map(tag => {
        const isVoid = voidTags.includes(tag);
        return {
          label: tag,
          kind: monaco.languages.CompletionItemKind.Snippet,
          insertText: isVoid ? `<${tag} $1>` : `<${tag}>$1</${tag}>`,
          insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
          documentation: `Insert <${tag}> tag`
        };
      });

      return { suggestions: tagSuggestions };
    }
  });

  // === JAVASCRIPT COMPLETIONS ===
  monaco.languages.registerCompletionItemProvider('javascript', {
    triggerCharacters: ['.', '(', ' '],
    provideCompletionItems: () => ({
      suggestions: [
        {
          label: 'console.log',
          kind: monaco.languages.CompletionItemKind.Function,
          insertText: 'console.log(${1:message});',
          insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
          documentation: 'Log to console'
        },
        {
          label: 'for loop',
          kind: monaco.languages.CompletionItemKind.Snippet,
          insertText: 'for (let ${1:i} = 0; ${1:i} < ${2:array}.length; ${1:i}++) {\n\t${3:// code}\n}',
          insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
          documentation: 'For loop'
        }
      ]
    })
  });

  // === PYTHON COMPLETIONS ===
  const pythonKeywords = ["False", "None", "True", "and", "as", "assert", "break", "class",
    "continue", "def", "del", "elif", "else", "except", "finally", "for", "from", "global",
    "if", "import", "in", "is", "lambda", "not", "or", "pass", "raise",
    "return", "try", "while", "with", "yield"];

  const pythonFunctions = ["abs", "all", "any", "bin", "bool", "chr", "dict", "dir", "enumerate",
    "filter", "float", "input", "int", "len", "list", "map", "max", "min", "open", "ord",
    "pow", "print", "range", "repr", "reversed", "round", "set", "sorted", "str", "sum",
    "tuple", "type", "zip"];

  monaco.languages.registerCompletionItemProvider('python', {
    triggerCharacters: ['.',...'abcdefghijklmnopqrstuvwxyz'],
    provideCompletionItems: (model, position) => {
      const lineUntilCursor = model.getValueInRange({
        startLineNumber: position.lineNumber,
        startColumn: 1,
        endLineNumber: position.lineNumber,
        endColumn: position.column
      });

      const wordMatch = lineUntilCursor.match(/(\w+)$/);
      if (wordMatch) {
        const prefix = wordMatch[1].toLowerCase();
        
        const suggestions = [
          ...pythonKeywords.filter(k => k.toLowerCase().startsWith(prefix)).map(k => ({
            label: k,
            kind: monaco.languages.CompletionItemKind.Keyword,
            insertText: k,
            documentation: `Python keyword: ${k}`
          })),
          ...pythonFunctions.filter(f => f.startsWith(prefix)).map(f => ({
            label: f,
            kind: monaco.languages.CompletionItemKind.Function,
            insertText: f,
            documentation: `Built-in function: ${f}`
          }))
        ];

        return { suggestions };
      }

      return { suggestions: [] };
    }
  });

}); // End of Monaco require block



// ============= THEME TOGGLE (Outside Monaco) =============
function toggleTheme() {
  currentTheme = currentTheme === 'vs-dark' ? 'vs-light' : 'vs-dark';
  
  if (typeof monaco !== 'undefined' && editor) {
    monaco.editor.setTheme(currentTheme);
  }
  
  localStorage.setItem('editorTheme', currentTheme);
  applyPageTheme(currentTheme);
  updateThemeButton(currentTheme);
  
  showToast(`‚úÖ Switched to ${currentTheme === 'vs-dark' ? 'Dark' : 'Light'} Mode`);
}

function applyPageTheme(theme) {
  const body = document.body;
  const isDark = theme === 'vs-dark';
  
  body.style.backgroundColor = isDark ? '#1e1e1e' : '#ffffff';
  body.style.color = isDark ? '#ccc' : '#1a1a1a';
  
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    sidebar.style.backgroundColor = isDark ? '#252526' : '#f8f9fa';
    sidebar.style.borderRight = isDark ? '1px solid #444' : '1px solid #d0d0d0';
    sidebar.style.color = isDark ? '#ccc' : '#1a1a1a';
  }
  
  const toolbar = document.querySelector('.toolbar');
  if (toolbar) {
    toolbar.style.backgroundColor = isDark ? '#1e1e1e' : '#ffffff';
    toolbar.style.borderBottom = isDark ? '1px solid #444' : '1px solid #d0d0d0';
  }
  
  const toolbarButtons = document.querySelectorAll('.toolbar button, .toolbar select');
  toolbarButtons.forEach(btn => {
    btn.style.backgroundColor = isDark ? '#333' : '#007bff';
    btn.style.color = isDark ? '#eee' : '#ffffff';
  });
  
  const runBtn = document.getElementById('runBtnCode');
  if (runBtn) {
    runBtn.style.backgroundColor = isDark ? '#2ecc71' : '#28a745';
    runBtn.style.color = '#ffffff';
  }
  
  const outputPanel = document.getElementById('outputPanel');
  if (outputPanel) {
    outputPanel.style.backgroundColor = isDark ? '#1e1e1e' : '#f8f9fa';
    outputPanel.style.color = isDark ? '#dcdcdc' : '#1a1a1a';
  }
}

// ============= CODE EXECUTION =============
function runCode() {
  const code = editor.getValue();
  const output = document.getElementById("outputText");
  const plotPreview = document.getElementById("plotPreview");

  const inputMatches = code.match(/input\s*\(\s*["']([^"']*)["']\s*\)/g);
  
  if (inputMatches && inputMatches.length > 0) {
    const inputs = [];
    
    for (let i = 0; i < inputMatches.length; i++) {
      const promptMatch = inputMatches[i].match(/input\s*\(\s*["']([^"']*)["']\s*\)/);
      const promptText = promptMatch && promptMatch[1] ? promptMatch[1] : `Input #${i + 1}`;
      
      const userInput = prompt(promptText);
      if (userInput === null) return;
      inputs.push(userInput);
    }
    
    executeCode(code, inputs);
  } else {
    const emptyInputCount = (code.match(/input\s*\(\s*\)/g) || []).length;
    if (emptyInputCount > 0) {
      const inputs = [];
      for (let i = 0; i < emptyInputCount; i++) {
        const userInput = prompt(`Input #${i + 1}: Enter value`);
        if (userInput === null) return;
        inputs.push(userInput);
      }
      executeCode(code, inputs);
    } else {
      executeCode(code, []);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIND this in your template and REPLACE the entire executeCode function
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function executeCode(code, inputs) {
  const output = document.getElementById("outputText");
  const plotPreview = document.getElementById("plotPreview");
  
  output.innerHTML = `‚è≥ Running... <span class="spinner"></span>`;
  plotPreview.innerHTML = "";

  fetch("{% url 'webprojects:run_python_code' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ 
      code: code,
      inputs: inputs
    })
  })
  .then(res => {
    if (!res.ok) {
      return res.text().then(text => { throw new Error(text); });
    }
    return res.json();
  })
  .then(data => {
    if (data.status === "error") {
      output.innerHTML = `<span style="color:red;">‚ùå ${escapeHTML(data.error || data.message)}</span>`;
      return;  // ‚Üê STOP here ‚Äî don't validate errored code
    }

    // ‚îÄ‚îÄ Show output in panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const studentOutput = (data.output || "").trim();
    output.textContent = studentOutput;

    // Display plots
    plotPreview.innerHTML = "";
    if (Array.isArray(data.images) && data.images.length > 0) {
      data.images.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.style.maxWidth = "100%";
        img.style.marginBottom = "10px";
        plotPreview.appendChild(img);
      });
    }

    // ‚îÄ‚îÄ Only validate if there is actual output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (!studentOutput || studentOutput === "[No output]") {
      console.log('[executeCode] No output ‚Äî skipping validation');
      return;
    }

    console.log('[executeCode] Output:', JSON.stringify(studentOutput));

    // ‚îÄ‚îÄ AI VALIDATION ‚Äî pass the RAW output exactly as-is ‚îÄ‚îÄ‚îÄ‚îÄ
    validateWithAI(code, studentOutput);
  })
  .catch(err => {
    output.innerHTML = `<span style="color:red;">‚ùå Request Failed: ${escapeHTML(err.message)}</span>`;
  });
}


async function submitQuizAnswer(topicId) {
  const answerInput = document.querySelector('#quiz-answer-input');
  
  if (!answerInput || !answerInput.value.trim()) {
    showToast('‚ö†Ô∏è Please enter an answer');
    return;
  }
  
  const answer = answerInput.value.trim();
  
  // Show AI thinking
  showToast('ü§ñ AI is checking your answer...');
  
  try {
    const response = await fetch("{% url 'webprojects:validate_topic_completion' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        topic_id: topicId,
        answer: answer
      })
    });
    
    const data = await response.json();
    
    if (data.is_correct) {
      showToast('üéâ ' + data.message);
      closeQuizModal();
      
      if (data.xp) {
        handleXPResponse(data.xp);
      }
      
      if (typeof window.SmartTutor !== 'undefined') {
        window.SmartTutor.refreshProgress();
      }
      
      launchConfetti();
      showAIFeedback(data.message, true);
    } else {
      showToast('üí° ' + data.message);
      
    }
  } catch (err) {
    showToast('‚ùå Error submitting answer');
  }
}

function showQuizModal(question, topicId) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    z-index: 10000;
    max-width: 500px;
    width: 90%;
  `;
  
  modal.innerHTML = `
    <h3 style="color: #2c3e50; margin-bottom: 20px;">üìù Quiz Question</h3>
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">${escapeHTML(question)}</p>
    
    <textarea 
      id="quiz-answer-input" 
      placeholder="Type your answer here..."
      style="
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
      "
    ></textarea>
    
    <button onclick="submitQuizAnswer(${topicId})" style="
      width: 100%;
      padding: 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    ">Submit Answer</button>
    
    <button onclick="closeQuizModal()" style="
      width: 100%;
      padding: 12px;
      background: #95a5a6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    ">Cancel</button>
  `;
  
  document.body.appendChild(modal);
  window.currentQuizModal = modal;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI VALIDATION ‚Äî paste this script block into your template

// FIND this entire function in your template:
//   async function validateWithAI(code, studentOutput) {
// and REPLACE the entire function with this:


async function validateWithAI(code, studentOutput) {
  const topicId = window._currentTopicId || localStorage.getItem('currentTopicId');

  if (!topicId) {
    console.log('[validateWithAI] No topic selected ‚Äî skipping');
    return;
  }

  const output = (studentOutput || '').trim();
  if (!output || output === '[No output]') {
    console.log('[validateWithAI] No output ‚Äî skipping');
    return;
  }

  const done = new Set((window._completedTopicIds || []).map(Number));
  if (done.has(Number(topicId))) {
    console.log('[validateWithAI] Topic already completed ‚Äî skipping');
    return;
  }

  console.log('[validateWithAI] Validating topic', topicId, 'output:', output.slice(0, 60));

  try {
    const res = await fetch("{% url 'webprojects:validate_topic_completion' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        topic_id: Number(topicId),
        code:     code,
        output:   output,
      })
    });

    const data = await res.json();
    console.log('[validateWithAI] Result:', data);

    if (data.is_correct) {
  showAIFeedback(data.message, true);
  if (data.xp) handleXPResponse(data.xp);
  
  const id = Number(topicId);
  done.add(id);
  window._completedTopicIds = Array.from(done);

  const item  = document.getElementById('topic-item-'  + id);
  const btn   = document.getElementById('topic-btn-'   + id);
  const icon  = document.getElementById('topic-icon-'  + id);
  const badge = document.getElementById('topic-badge-' + id);

  if (item)  { item.style.border = '2px solid #27ae60'; item.style.backgroundColor = '#f0fff4'; }
  if (btn)   { btn.textContent = '‚úÖ Completed'; btn.style.background = '#27ae60'; btn.style.fontWeight = 'bold'; }
  if (icon)  { icon.textContent = '‚úÖ'; }
  if (badge) {
    badge.style.display    = 'inline-block';
    badge.textContent      = '‚úÖ Done';
    badge.style.background = '#d4edda';
    badge.style.color      = '#155724';
    badge.style.border     = '1px solid #c3e6cb';
  }

  // ‚úÖ Use backend's completion percentage instead of calculating locally
  const pct = data.completion_percentage || 0;
  
  const total    = window._totalTopicCount || 0;
  const doneCount = done.size;

  const fill    = document.getElementById('modules-pb-fill');
  const label   = document.getElementById('modules-done-label');
  const pctEl   = document.getElementById('modules-pct-label');
  const stFill  = document.getElementById('st-pb-fill');
  const stPct   = document.getElementById('st-pct-label');
  const stCount = document.getElementById('st-count-label');

  if (fill)    fill.style.width    = pct + '%';
  if (label)   label.textContent   = doneCount + ' / ' + total + ' topics completed';
  if (pctEl)   pctEl.textContent   = pct + '%';
  if (stFill)  stFill.style.width  = pct + '%';
  if (stPct)   stPct.textContent   = pct + '% complete';
  if (stCount) stCount.textContent = doneCount + ' / ' + total + ' topics';

  // ‚úÖ Check if course is 100% complete using backend data
  console.log('[validateWithAI] Completion:', pct + '%');
  if (pct === 100 && data.course_id) {
    console.log('[validateWithAI] üéâ Course 100% complete! Showing recommendation...');
    // Store course ID for recommendation
    window._currentCourseId = data.course_id;
    localStorage.setItem('currentCourseId', data.course_id);
    
    // Wait for confetti to finish, then show recommendation
    setTimeout(() => {
      fetchAndShowNextCourseRecommendation();
    }, 2000);
  }

  if (typeof launchConfetti === 'function') launchConfetti();
  if (window.SmartTutor) window.SmartTutor.refreshProgress();

} else {
  // Show comparison modal when wrong
  if (data.lesson_code) {
    showCodeComparison(data.lesson_code, code, data.message, data.hint);
  }
} 

  } catch (err) {
    console.error('[validateWithAI] Error:', err);
  }
}

// ========================================
// ‚úÖ Course Recommendation System
// ========================================

async function fetchAndShowNextCourseRecommendation() {
  const currentCourseId = window._currentCourseId || localStorage.getItem('currentCourseId');
  
  if (!currentCourseId) {
    console.log('[recommendation] No current course ID found');
    return;
  }
  
  try {
    const res = await fetch(`/webprojects/recommend-next-course/?course_id=${currentCourseId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const data = await res.json();
    console.log('[recommendation] Response:', data);
    
    if (data.status === 'success' && data.recommended_course) {
      showCourseRecommendationModal(data.recommended_course, data.current_course);
    } else {
      showCourseCompletionCelebration(data.current_course);
    }
    
  } catch (err) {
    console.error('[recommendation] Error:', err);
  }
}



function showCourseRecommendationModal(nextCourse, currentCourse) {
  const existing = document.getElementById('course-recommendation-overlay');
  if (existing) existing.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'course-recommendation-overlay';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7); z-index: 10000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
    animation: fadeIn 0.3s ease;
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px; padding: 40px; max-width: 600px; width: 100%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4); color: white; text-align: center;
    animation: slideInUp 0.4s ease;
  `;
  
  modal.innerHTML = `
    <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
    <h2 style="font-size: 32px; font-weight: bold; margin: 0 0 16px 0; color: white;">
      Congratulations!
    </h2>
    <p style="font-size: 18px; margin: 0 0 30px 0; opacity: 0.95;">
      You've completed <strong>${escapeHTML(currentCourse.title)}</strong>!
    </p>
    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); 
                border-radius: 12px; padding: 24px; margin: 30px 0;">
      <div style="font-size: 16px; margin-bottom: 12px; opacity: 0.9;">
        üöÄ Ready for the next challenge?
      </div>
      <h3 style="font-size: 24px; font-weight: bold; margin: 12px 0; color: #fff;">
        ${escapeHTML(nextCourse.title)}
      </h3>
      <p style="font-size: 14px; margin: 12px 0; opacity: 0.85; line-height: 1.6;
          display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
          overflow: hidden; text-overflow: ellipsis;">
        ${escapeHTML(nextCourse.description || 'Continue your learning journey with this course!')}
      </p>
      <div style="font-size: 14px; margin-top: 16px; opacity: 0.8;">
        üìö ${nextCourse.topic_count || 0} topics
      </div>
    </div>
    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px;">
      <button onclick="startRecommendedCourse(${nextCourse.id})" 
              style="background: white; color: #667eea; border: none; 
                     padding: 14px 32px; border-radius: 8px; cursor: pointer;
                     font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
        Start Next Course ‚Üí
      </button>
      <button onclick="document.getElementById('course-recommendation-overlay').remove()" 
              style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; 
                     padding: 14px 32px; border-radius: 8px; cursor: pointer;
                     font-size: 16px; font-weight: bold;">
        Maybe Later
      </button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

function showCourseCompletionCelebration(currentCourse) {
  const existing = document.getElementById('course-recommendation-overlay');
  if (existing) existing.remove();
  
  const overlay = document.createElement('div');
  overlay.id = 'course-recommendation-overlay';
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.7); z-index: 10000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border-radius: 16px; padding: 40px; max-width: 500px; width: 100%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4); color: white; text-align: center;
  `;
  
  modal.innerHTML = `
    <div style="font-size: 80px; margin-bottom: 20px;">üèÜ</div>
    <h2 style="font-size: 32px; font-weight: bold; margin: 0 0 16px 0;">
      Course Completed!
    </h2>
    <p style="font-size: 18px; margin: 0 0 30px 0; opacity: 0.95;">
      Amazing work completing <strong>${escapeHTML(currentCourse.title)}</strong>!
    </p>
    <button onclick="window.location.href='/courses/'" 
            style="background: white; color: #f5576c; border: none; 
                   padding: 14px 32px; border-radius: 8px; cursor: pointer;
                   font-size: 16px; font-weight: bold;">
      Explore More Courses
    </button>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
}

function startRecommendedCourse(courseId) {
  window.location.href = `/course/${courseId}/`;
}



function showCodeComparison(lessonCode, studentCode, feedback, hint) {
    const existing = document.getElementById('code-comparison-overlay');
    if (existing) existing.remove();
    
    const overlay = document.createElement('div');
    overlay.id = 'code-comparison-overlay';
    overlay.style.cssText = `
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: rgba(0, 0, 0, 0.5); 
        z-index: 9998;
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    `;
    
    const comparisonDiv = document.createElement('div');
    comparisonDiv.id = 'code-comparison';
    comparisonDiv.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 900px;
        max-height: 80vh;
        overflow: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    `;
    
    const cleanCode = (code) => code.trim();
    
    const expectedClean = cleanCode(lessonCode);
    const studentClean = cleanCode(studentCode);
    
    const expectedNonEmpty = expectedClean.split('\n').filter(line => line.trim());
    const studentNonEmpty = studentClean.split('\n').filter(line => line.trim());
    
    let expectedHTML = '';
    let studentHTML = '';
    let errorCount = 0;
    let fixSuggestions = [];
    
    // ‚úÖ Helper function to highlight character differences
    const highlightDifferences = (expected, actual) => {
        let result = '';
        const maxLen = Math.max(expected.length, actual.length);
        
        for (let i = 0; i < maxLen; i++) {
            const expChar = expected[i] || '';
            const actChar = actual[i] || '';
            
            if (expChar !== actChar) {
                if (actChar) {
                    // Character is wrong
                    result += `<span style="background: #ff5252; color: white; padding: 0 2px; border-radius: 2px; font-weight: bold;">${escapeHTML(actChar)}</span>`;
                }
            } else {
                result += escapeHTML(actChar);
            }
        }
        
        return result;
    };
    
    for (let i = 0; i < Math.max(expectedNonEmpty.length, studentNonEmpty.length); i++) {
        const expectedLine = expectedNonEmpty[i] || '';
        const studentLine = studentNonEmpty[i] || '';
        const lineNum = i + 1;
        
        const expectedTrimmed = expectedLine.trim();
        const studentTrimmed = studentLine.trim();
        
        const isMatch = expectedTrimmed === studentTrimmed;
        
        if (!isMatch && expectedTrimmed && studentTrimmed) {
            errorCount++;
            
            // ‚úÖ Generate fix suggestion for this line
            const differences = [];
            for (let j = 0; j < Math.max(expectedTrimmed.length, studentTrimmed.length); j++) {
                if (expectedTrimmed[j] !== studentTrimmed[j]) {
                    if (expectedTrimmed[j] && studentTrimmed[j]) {
                        differences.push(`Change '${studentTrimmed[j]}' to '${expectedTrimmed[j]}'`);
                    } else if (!studentTrimmed[j]) {
                        differences.push(`Add '${expectedTrimmed[j]}'`);
                    } else {
                        differences.push(`Remove '${studentTrimmed[j]}'`);
                    }
                }
            }
            
            // Find what needs to be changed (simple case-insensitive check)
            if (expectedTrimmed.toLowerCase() === studentTrimmed.toLowerCase()) {
                // Case difference
                fixSuggestions.push({
                    line: lineNum,
                    issue: 'Capitalization',
                    fix: `Change to: <code style="background: #e8f5e9; padding: 2px 6px; border-radius: 3px; font-family: monospace;">${escapeHTML(expectedTrimmed)}</code>`
                });
            } else {
                // Other difference
                fixSuggestions.push({
                    line: lineNum,
                    issue: 'Text mismatch',
                    fix: `Change to: <code style="background: #e8f5e9; padding: 2px 6px; border-radius: 3px; font-family: monospace;">${escapeHTML(expectedTrimmed)}</code>`
                });
            }
        }
        
        // Expected code side
        if (expectedTrimmed) {
            expectedHTML += `<div style="display: flex; padding: 4px 0; user-select: none;">
                <span style="color: #999; width: 30px; text-align: right; margin-right: 12px; user-select: none; flex-shrink: 0;">${lineNum}</span>
                <span style="flex: 1; font-family: 'Courier New', monospace; ${!isMatch && studentTrimmed ? 'background: #fff3cd; padding: 2px 4px; border-radius: 3px;' : ''}">${escapeHTML(expectedLine)}</span>
            </div>`;
        }
        
        // Student code side with character-level highlighting
        if (studentTrimmed) {
            const hasError = !isMatch && expectedTrimmed;
            const displayLine = hasError ? highlightDifferences(expectedTrimmed, studentTrimmed) : escapeHTML(studentLine);
            
            studentHTML += `<div style="display: flex; padding: 4px 0;">
                <span style="color: #999; width: 30px; text-align: right; margin-right: 12px; user-select: none; flex-shrink: 0;">${lineNum}</span>
                <span style="flex: 1; font-family: 'Courier New', monospace; ${hasError ? 'background: #ffebee; padding: 2px 4px; border-radius: 3px; border-left: 3px solid #dc3545;' : ''}">${displayLine}</span>
                ${hasError ? '<span style="color: #dc3545; margin-left: 8px; font-weight: bold; flex-shrink: 0;">‚ö†Ô∏è</span>' : ''}
            </div>`;
        }
    }
    
    const hintHTML = hint ? `
        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; 
                    margin-top: 16px; border-radius: 4px;">
            <div style="font-weight: bold; color: #1976d2; margin-bottom: 4px;">üí° Hint:</div>
            <div style="color: #1565c0; white-space: pre-wrap;">${escapeHTML(hint)}</div>
        </div>
    ` : '';
    
    // ‚úÖ Generate fix suggestions HTML
    const fixSuggestionsHTML = fixSuggestions.length > 0 ? `
        <div style="background: #e8f5e9; border-left: 4px solid #4caf50; padding: 12px; 
                    margin-top: 16px; border-radius: 4px;">
            <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">üîß How to Fix:</div>
            ${fixSuggestions.map(fix => `
                <div style="color: #1b5e20; font-size: 14px; margin-bottom: 8px;">
                    <strong>Line ${fix.line}:</strong> ${fix.issue}<br>
                    <span style="margin-left: 20px;">${fix.fix}</span>
                </div>
            `).join('')}
        </div>
    ` : '';
    
    const errorSummaryHTML = errorCount > 0 ? `
        <div style="background: #ffebee; border-left: 4px solid #dc3545; padding: 12px; 
                    margin-bottom: 16px; border-radius: 4px;">
            <div style="font-weight: bold; color: #c62828; margin-bottom: 4px;">
                ‚ö†Ô∏è Found ${errorCount} error${errorCount > 1 ? 's' : ''}
            </div>
            <div style="color: #d32f2f; font-size: 14px;">
                Wrong characters are <span style="background: #ff5252; color: white; padding: 2px 4px; border-radius: 2px; font-weight: bold;">highlighted in red</span>
            </div>
        </div>
    ` : '';
    
    comparisonDiv.innerHTML = `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px;">
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 16px; color: #856404; white-space: pre-wrap;">
                ${escapeHTML(feedback)}
            </div>
            
            ${errorSummaryHTML}
            ${fixSuggestionsHTML}
            ${hintHTML}
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px;user-select: none;">
                <!-- Expected Code -->
                <div style="background: #f0fff4; border: 2px solid #28a745; border-radius: 8px; padding: 12px;">
                    <div style="font-weight: bold; color: #28a745; margin-bottom: 8px; font-size: 14px;">
                        ‚úÖ Expected Code:
                    </div>
                    <div style="font-size: 13px; color: #212529; line-height: 1.8;">
                        ${expectedHTML}
                    </div>
                </div>
                
                <!-- Your Code -->
                <div style="background: #fff5f5; border: 2px solid #dc3545; border-radius: 8px; padding: 12px;">
                    <div style="font-weight: bold; color: #dc3545; margin-bottom: 8px; font-size: 14px;">
                        ‚ùå Your Code:
                    </div>
                    <div style="font-size: 13px; color: #212529; line-height: 1.8;">
                        ${studentHTML}
                    </div>
                </div>
            </div>
            
            <div style="background: #e3f2fd; padding: 12px; margin-top: 16px; border-radius: 6px; font-size: 13px; color: #1565c0;">
                <strong>üîç Legend:</strong> 
                <span style="background: #ff5252; color: white; padding: 2px 6px; border-radius: 2px; font-weight: bold; margin: 0 4px;">Red</span> = Wrong character
                ‚Ä¢ Blank lines between code don't matter
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="document.getElementById('code-comparison-overlay').remove()" 
                        style="background: #6c757d; color: white; border: none; 
                               padding: 10px 24px; border-radius: 6px; cursor: pointer;
                               font-size: 14px; font-weight: bold;">
                    Got it, let me try again
                </button>
            </div>
        </div>
    `;
    
    overlay.appendChild(comparisonDiv);
    document.body.appendChild(overlay);
    
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.remove();
        }
    });
}



// ‚îÄ‚îÄ 2. Show feedback bubble above the output panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAIFeedback(message, isCorrect) {
  const old = document.getElementById('ai-feedback-bubble');
  if (old) old.remove();

  const bubble = document.createElement('div');
  bubble.id = 'ai-feedback-bubble';
  bubble.style.cssText = `
    position: fixed;
    bottom: 160px;
    right: 20px;
    user-select: none;
    max-width: 380px;
    padding: 14px 18px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.6;
    color: white;
    z-index: 9999;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    animation: slideInUp 0.3s ease;
    background: ${isCorrect ? '#27ae60' : '#e67e22'};
    border-left: 5px solid ${isCorrect ? '#1e8449' : '#d35400'};
    white-space: pre-wrap;
  `;
  
  const content = document.createElement('div');
  content.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;gap:10px;';
  
  const messageSpan = document.createElement('span');
  messageSpan.textContent = `${isCorrect ? '‚úÖ' : 'üí°'} ${message}`;
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '√ó';
  closeBtn.style.cssText = 'background:none;border:none;color:white;font-size:18px;cursor:pointer;line-height:1;padding:0;flex-shrink:0;';
  closeBtn.onclick = () => bubble.remove();
  
  content.appendChild(messageSpan);
  content.appendChild(closeBtn);
  bubble.appendChild(content);
  
  document.body.appendChild(bubble);

  setTimeout(() => { if (bubble.parentNode) bubble.remove(); }, 8000);
}

// ‚îÄ‚îÄ 3. Auto-show quiz modal when student clicks "Study This Topic"
//       and the topic is a quiz type ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeQuizModal() {
  if (window.currentQuizModal) {
    window.currentQuizModal.remove();
    window.currentQuizModal = null;
  }
  // Remove backdrop
  const backdrop = document.getElementById('quiz-backdrop');
  if (backdrop) backdrop.remove();
}

// Patch setCurrentTopic to auto-show quiz for non-code topics
(function patchForQuiz() {
  const _origHandleStudy = window.handleStudyClick;
  window.handleStudyClick = function(topicId, btn) {
    if (typeof _origHandleStudy === 'function') _origHandleStudy(topicId, btn);

    // After a short delay, check if this topic needs a quiz
    setTimeout(() => checkIfQuizTopic(topicId), 600);
  };
})();

async function checkIfQuizTopic(topicId) {
  try {
    const res  = await fetch(`/webprojects/topic-info/${topicId}/`);
    const data = await res.json();

    if (data.validation_type === 'quiz' && data.quiz_question) {
      showQuizModal(data.quiz_question, topicId);
    }
  } catch (e) {
    // Silently fail ‚Äî topic-info endpoint may not exist yet
    // Add the view below if you want auto quiz triggering
  }
}
</script>



<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggles = document.querySelectorAll('.folder-toggle');

  toggles.forEach(toggle => {
    const ext = toggle.dataset.ext;
    const storedState = localStorage.getItem('folder_' + ext);

    if (storedState === 'open') {
      toggle.classList.add('open');
      toggle.nextElementSibling.style.display = 'block';
    }

    toggle.addEventListener('click', () => {
      const group = toggle.nextElementSibling;
      const isOpen = toggle.classList.toggle('open');
      group.style.display = isOpen ? 'block' : 'none';
      localStorage.setItem('folder_' + ext, isOpen ? 'open' : 'closed');
    });
  });
});

function getSelectedText() {
  return editor.getModel().getValueInRange(editor.getSelection());
}

function insertAfterSelection(original, insertion) {
  const range = editor.getSelection();
  editor.executeEdits(null, [{
    range: range,
    text: original + "\n\n" + insertion,
    forceMoveMarkers: true
  }]);
}

function cleanAIResponse(text) {
  if (text.includes("```")) {
    const parts = text.split("```");
    if (parts.length >= 2) {
      return parts[1].replace(/^(\w+\n)?/, "").trim();
    }
  }
  return text.trim();
}





function showToast(message) {
  const toast = document.getElementById("toastMessage");
  if (!toast) {
    console.error("Toast element not found");
    return;
  }
  
  toast.innerHTML = `
    <span>${message}</span>
    <button onclick="hideToast()" style="
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      position: absolute;
      right: 12px;
      top: 8px;
      cursor: pointer;
    ">&times;</button>
  `;
  toast.style.display = "block";
  toast.style.opacity = "1";
  
  // Auto-hide after 3 seconds
  setTimeout(() => {
    hideToast();
  }, 3000);
}

function hideToast() {
  const toast = document.getElementById("toastMessage");
  if (toast) {
    toast.style.opacity = "0";
    setTimeout(() => {
      toast.style.display = "none";
    }, 500);
  }
}


function hideToast() {
  const toast = document.getElementById("toastMessage");
  toast.style.opacity = "0";
  setTimeout(() => (toast.style.display = "none"), 500);
}


function runAIAction() {
  const selectedText = getSelectedText();
  const action = document.getElementById("aiAction").value;
  const loadingIndicator = document.getElementById("aiLoading");
  const runBtn = document.getElementById("runBtn");

  if (!selectedText.trim()) {
    return alert("‚ö†Ô∏è Please select code first.");
  }

  const instructions = {
    // complete: "Complete the following code:",
    explain: "Explain what this code does:",
    optimize: "Optimize this code for performance or readability:",
    comment: "Add detailed comments to the following code:",
    fix: "Fix any bugs or issues in this code:"
  };

  const prompt = instructions[action] + "\n\n" + selectedText;

  // Show loading
  loadingIndicator.style.display = "inline";
  runBtn.disabled = true;
  runBtn.textContent = "‚è≥ Running...";

  fetch("{% url 'webprojects:ai_suggest_code' %}", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ prompt: prompt })
  })
  .then(res => res.json())
  .then(data => {
    const output = cleanAIResponse(data.suggestion || "");
    insertAfterSelection(selectedText, output);
  })
  .catch(err => {
    alert("AI Action Failed: " + err);
  })
  .finally(() => {
    // Hide loading
    loadingIndicator.style.display = "none";
    runBtn.disabled = false;
    runBtn.textContent = "üöÄ Run AI Action";
  });
}


function createNewFolder() {
  const name = document.getElementById("newFolderName").value.trim();
  const projectId = {{ file.project.id }};

  if (!name) return alert("‚ö†Ô∏è Please enter a folder name");

  fetch(`/webprojects/${projectId}/create-folder/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      alert("‚úÖ Folder created!");
      location.reload(); // refresh to show the new folder
    } else {
      alert("‚ùå " + data.message);
    }
  })
  .catch(err => alert("‚ùå Request failed: " + err));
}

function createNewFile() {
  const name = document.getElementById("newFileName").value.trim();
  const projectId = {{ file.project.id }};

  if (!name) return alert("‚ö†Ô∏è Please enter a file name");

  fetch(`/webprojects/${projectId}/create-file/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      showToast(`‚úÖ File "${name}" created successfully!`);
      
      // Clear input
      document.getElementById("newFileName").value = "";
      
      // Add file to sidebar dynamically
      addNewFileToSidebar(data.file_id, name, projectId);
      
      // ‚úÖ REMOVED: No navigation, no reload
      // User can click the new file in the sidebar when they want to open it
      
    } else {
      alert("‚ùå " + data.message);
    }
  })
  .catch(err => alert("‚ùå Request failed: " + err));
}

function addNewFileToSidebar(fileId, fileName, projectId) {
  // Get file extension
  const ext = fileName.split('.').pop().toLowerCase();
  
  // Find the appropriate file group
  const folderToggles = document.querySelectorAll('.folder-toggle');
  let targetGroup = null;
  
  folderToggles.forEach(toggle => {
    if (toggle.dataset.ext === ext) {
      targetGroup = toggle.nextElementSibling;
      // Make sure the folder is open
      if (!toggle.classList.contains('open')) {
        toggle.classList.add('open');
        targetGroup.style.display = 'block';
        localStorage.setItem('folder_' + ext, 'open');
      }
    }
  });
  
  // If no group exists for this extension, create one
  if (!targetGroup) {
    const sidebar = document.querySelector('.sidebar');
    const modulesContainer = document.querySelector('.topics-container');
    
    // Create new folder toggle
    const newToggle = document.createElement('div');
    newToggle.className = 'folder-toggle open';
    newToggle.dataset.ext = ext;
    newToggle.innerHTML = `üìÅ ${ext.toUpperCase()} Files <span>‚Æü</span>`;
    
    // Create new file group
    const newGroup = document.createElement('div');
    newGroup.className = 'file-group';
    newGroup.style.display = 'block';
    
    // Insert before modules section
    if (modulesContainer) {
      const modulesParent = modulesContainer.parentElement;
      const h2 = modulesParent.querySelector('h2');
      if (h2) {
        modulesParent.insertBefore(newToggle, h2);
        modulesParent.insertBefore(newGroup, h2);
      }
    } else {
      sidebar.appendChild(newToggle);
      sidebar.appendChild(newGroup);
    }
    
    // Add click handler for toggle
    newToggle.addEventListener('click', () => {
      const group = newToggle.nextElementSibling;
      const isOpen = newToggle.classList.toggle('open');
      group.style.display = isOpen ? 'block' : 'none';
      localStorage.setItem('folder_' + ext, isOpen ? 'open' : 'closed');
    });
    
    targetGroup = newGroup;
  }
  
  // Create the file item
  const fileItem = document.createElement('div');
  fileItem.className = 'file-item';
  
  // Determine file type and create appropriate link
  // UPDATE THIS PART - use AJAX click handler
  const isImage = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext);
  const isExcel = ['xls', 'xlsx', 'csv'].includes(ext);
  
  if (isImage) {
    fileItem.innerHTML = `
      <a href="javascript:void(0);" style="color:#4fa;">üñºÔ∏è ${fileName}</a>
      <form method="POST" action="/webprojects/${projectId}/file/${fileId}/delete/" class="delete-file-form d-inline">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
      </form>
    `;
  } else {
    fileItem.innerHTML = `
      <a href="javascript:void(0);" 
         onclick="loadFile(${projectId}, ${fileId}, '${fileName}')"
         class="file-link"
         data-file-id="${fileId}">üìù ${fileName}</a>
      ${ext === 'html' ? `<a href="/webprojects/${projectId}/file/${fileId}/preview/" target="_blank" style="color: green;">publish</a>` : ''}
      ${isExcel ? `<a href="/webprojects/${projectId}/file/${fileId}/preview/" class="btn btn-sm">View</a>` : ''}
      <form method="POST" action="/webprojects/${projectId}/file/${fileId}/delete/" class="delete-file-form d-inline">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
      </form>
    `;
  }
  // Add to group
  targetGroup.appendChild(fileItem);
  
  // Attach delete handler
  const deleteForm = fileItem.querySelector('.delete-file-form');
  if (deleteForm) {
    deleteForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!confirm("Are you sure you want to delete this file?")) return;
      
      const url = deleteForm.getAttribute('action');
      const csrfToken = deleteForm.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          fileItem.remove();
          showToast('‚úÖ File deleted');
        } else {
          alert(data.message || 'Failed to delete file.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error deleting file.');
      });
    });
  }
  
  // Scroll to the new file
  fileItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  // Highlight the new file briefly
  fileItem.style.background = 'rgba(52, 152, 219, 0.3)';
  setTimeout(() => {
    fileItem.style.background = '';
  }, 2000);
}


</script>

<!-- uppload file js  -->
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '#333';
});

dropZone.addEventListener('dragleave', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '';
});

dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '';
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
});

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (file) uploadFile(file);
});

function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('name', file.name);

  const loader = document.getElementById("upload-loader");
  loader.style.display = "flex"; // show loader

  fetch("{% url 'webprojects:upload_file_ajax' project.id %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showToast(`‚úÖ Uploaded: ${file.name}`);
      addFileToList(data.file_id, file.name, data.file_url || "");

      // ‚úÖ reload after 1.5 seconds
      setTimeout(() => {
        location.reload();
      }, 1500);
    } else {
      showToast(`‚ùå Upload failed: ${data.error || ''}`);
    }
  })
  .catch(() => showToast("‚ö†Ô∏è Upload error"))
  .finally(() => {
    loader.style.display = "none"; // hide loader
  });
}


function addFileToList(fileId, fileName, fileUrl) {
  const ext = fileName.split('.').pop().toLowerCase();
  const groups = document.querySelectorAll('.file-group');

  groups.forEach(group => {
    if (group.previousElementSibling.dataset.ext === ext) {
      const div = document.createElement('div');
      div.classList.add('file-item');

      if (["png", "jpg", "jpeg", "gif", "svg", "webp"].includes(ext)) {
        div.innerHTML = `<a href="javascript:void(0);" onclick="showImageModal('${fileUrl}')" style="color:#4fa;">üñºÔ∏è ${fileName}</a>`;
      } 
      else if (["xls", "xlsx", "csv"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#f1c40f;">üìä ${fileName}</a>`;
      } 
      else if (["pdf"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#e74c3c;">üìÑ ${fileName}</a>`;
      } 
      else if (["doc", "docx"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#3498db;">üìë ${fileName}</a>`;
      } 
      else if (["txt", "md"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#9b59b6;">üìù ${fileName}</a>`;
      } 
      else {
        div.innerHTML = `<a href="/file/${fileId}/" style="color:#fff;">üì¶ ${fileName}</a>`;
      }

      group.appendChild(div);
    }
  });
}

function showToast(message) {
  const toast = document.getElementById("toastMessage");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 2500);
}
</script>


<!-- dragging output area js -->
 <script>
  const container = document.getElementById("container");
  const outputPanel = document.getElementById("outputPanel");
  const resizeHandle = document.getElementById("resizeHandle");

  let isDragging = false;
  let startY = 0;
  let startHeight = 0;

  resizeHandle.addEventListener("mousedown", (e) => {
    isDragging = true;
    startY = e.clientY;
    startHeight = outputPanel.offsetHeight;
    document.body.style.userSelect = "none"; // Prevent text selection
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    const dy = e.clientY - startY;
    const newHeight = Math.max(startHeight - dy, 100); // Minimum height
    outputPanel.style.height = `${newHeight}px`;
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
    document.body.style.userSelect = "";
  });

  // Touch support for mobile
  resizeHandle.addEventListener("touchstart", (e) => {
    isDragging = true;
    startY = e.touches[0].clientY;
    startHeight = outputPanel.offsetHeight;
  });

  document.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    const dy = e.touches[0].clientY - startY;
    const newHeight = Math.max(startHeight - dy, 100);
    outputPanel.style.height = `${newHeight}px`;
  });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });


// ============= INITIALIZE SPEECH ON PAGE LOAD =============
document.addEventListener('DOMContentLoaded', function() {
  console.log("üîä Initializing speech...");
  
  // Force load voices
  if ('speechSynthesis' in window) {
    // Chrome/Edge need this
    let voices = window.speechSynthesis.getVoices();
    
    if (voices.length === 0) {
      window.speechSynthesis.onvoiceschanged = () => {
        voices = window.speechSynthesis.getVoices();
        console.log("‚úÖ Loaded voices:", voices.length);
        voices.forEach((voice, i) => {
          console.log(`${i}: ${voice.name} (${voice.lang})`);
        });
      };
    } else {
      console.log("‚úÖ Voices already loaded:", voices.length);
    }
    
    // Update button state
  
  } else {
    console.error("‚ùå Speech synthesis not supported");
  }
});  
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPEECH SYSTEM ‚Äî defined first, before anything else
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.speechEnabled = localStorage.getItem('speechEnabled') !== 'false';

window.updateSpeechButton = function() {
  var btn = document.getElementById('speechToggleBtn');
  if (!btn) return;
  btn.textContent      = window.speechEnabled ? 'üîä Speech On' : 'üîá Speech Off';
  btn.style.background = window.speechEnabled ? '#27ae60' : '#95a5a6';
};

window.speakText = function(text, onFinish) {
  if (!window.speechEnabled || !text) {
    if (onFinish) onFinish();
    return;
  }
  
  if (!('speechSynthesis' in window)) {
    if (onFinish) onFinish();
    return;
  }
  
  window.speechSynthesis.cancel();
  
  setTimeout(() => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.lang = 'en-US';
    
    const voices = window.speechSynthesis.getVoices();
    const goodVoice = voices.find(v =>
      v.lang.startsWith('en') && /Google|Microsoft|Samantha/.test(v.name)
    ) || voices.find(v => v.lang.startsWith('en')) || voices[0];
    
    if (goodVoice) utterance.voice = goodVoice;
    
    utterance.onend = () => {
      console.log("üîá Speech ended");
      if (onFinish) onFinish();
    };
    
    utterance.onerror = (e) => {
      console.error("Speech error:", e);
      if (onFinish) onFinish();
    };
    
    window.speechSynthesis.speak(utterance);
  }, 150);
};

// Alias for compatibility
window.speakHint = window.speakText;

window.toggleSpeech = function() {
  console.log('[Speech] toggleSpeech called');
  window.speechEnabled = !window.speechEnabled;
  localStorage.setItem('speechEnabled', window.speechEnabled);
  window.updateSpeechButton();

  if (!window.speechEnabled) {
    window.speechSynthesis.cancel();
    if (typeof showToast === 'function') showToast('üîá Speech disabled');
    return;
  }

  if (typeof showToast === 'function') showToast('üîä Speech enabled');
  window.speakText('Speech is now on. I will guide you as you code.');
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  window.updateSpeechButton();
  
  // Force load voices
  if ('speechSynthesis' in window) {
    let voices = window.speechSynthesis.getVoices();
    
    if (voices.length === 0) {
      window.speechSynthesis.onvoiceschanged = () => {
        voices = window.speechSynthesis.getVoices();
        console.log('[Speech] ‚úÖ Loaded voices:', voices.length);
      };
    } else {
      console.log('[Speech] ‚úÖ Voices already loaded:', voices.length);
    }
  }
  
  console.log('[Speech] ‚úÖ System ready');
});
</script>

<script>
// ============= GLOBAL VARIABLES =============
let editor;
let currentTheme = localStorage.getItem('editorTheme') || 'vs-dark';
let currentFileId = {{ file.id }};
let currentProjectId = {{ file.project.id }};
let autoSaveInterval;
let lastSavedContent = '';
let saveIndicator = null;

// Smart Tutor variables
let hintTimeout = null;
let lastAnalyzedCode = '';
let isAnalyzing = false;
let errorDecoration = [];

// Speech variables

let availableVoices = [];

// ============= UTILITY FUNCTIONS =============
function getLanguage(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  switch (ext) {
    case "py": return "python";
    case "js": return "javascript";
    case "html": return "html";
    case "css": return "css";
    case "json": return "json";
    default: return "plaintext";
  }
}

function updateThemeButton(theme) {
  const themeText = document.getElementById('themeToggleText');
  const isDark = theme === 'vs-dark';
  
  if (themeText) {
    themeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
  }
}

function escapeHTML(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, tag => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[tag]));
}

// ============= TEXT-TO-SPEECH =============


function loadVoices() {
  return new Promise((resolve) => {
    availableVoices = window.speechSynthesis.getVoices();
    
    if (availableVoices.length > 0) {
      console.log("‚úÖ Voices loaded:", availableVoices.length);
      resolve(availableVoices);
    } else {
      window.speechSynthesis.onvoiceschanged = () => {
        availableVoices = window.speechSynthesis.getVoices();
        console.log("‚úÖ Voices loaded (delayed):", availableVoices.length);
        resolve(availableVoices);
      };
    }
  });
}


// ============= ERROR LINE HIGHLIGHTING =============
function highlightErrorLine(lineNumber) {
  if (!editor || !lineNumber) return;
  
  console.log(`üé® Highlighting line ${lineNumber}`);
  
  // Clear previous decorations
  errorDecoration = editor.deltaDecorations(errorDecoration, []);
  
  // Add new decoration
  errorDecoration = editor.deltaDecorations([], [
    {
      range: new monaco.Range(lineNumber, 1, lineNumber, 1000),
      options: {
        isWholeLine: true,
        className: 'error-line-highlight',
        glyphMarginClassName: 'error-line-glyph',
        linesDecorationsClassName: 'error-line-decoration'
      }
    }
  ]);
  
  // Scroll to error line
  editor.revealLineInCenter(lineNumber);
  
  // Auto-remove after 10 seconds
  setTimeout(() => {
    clearErrorHighlight();
  }, 10000);
}

function clearErrorHighlight() {
  if (errorDecoration.length > 0) {
    errorDecoration = editor.deltaDecorations(errorDecoration, []);
    console.log("üßπ Cleared error highlight");
  }
}

// ============= SMART HINT DISPLAY =============

function showSmartHint(hint, type, topic) {
  const panel = document.getElementById('smartHintPanel');
  const content = document.getElementById('hintContent');
  const topicDiv = document.getElementById('hintTopic');
  const icon = document.getElementById('hintIcon');
  const title = document.getElementById('hintTitle');
  
  if (!panel || !content) {
    console.error("Smart hint panel elements not found");
    return;
  }
  
  // Clear any existing timeout
  if (window.hintAutoHideTimeout) {
    clearTimeout(window.hintAutoHideTimeout);
  }
  
  // Remove all hint type classes
  panel.classList.remove('hint-error', 'hint-success', 'hint-next-step');
  
  // Set content
  content.innerHTML = escapeHTML(hint);
  
  // Set icon and style based on type
  switch(type) {
    case 'error':
      icon.textContent = '‚ö†Ô∏è';
      title.textContent = 'Error Detected';
      title.style.color = '#e74c3c';
      panel.classList.add('hint-error');
      break;
    case 'start':
      icon.textContent = 'üöÄ';
      title.textContent = 'Getting Started';
      title.style.color = '#27ae60';
      panel.classList.add('hint-success');
      break;
    case 'next_step':
      icon.textContent = 'üí°';
      title.textContent = 'Next Step';
      title.style.color = '#3498db';
      panel.classList.add('hint-next-step');
      break;
    case 'improvement':
      icon.textContent = '‚ú®';
      title.textContent = 'Suggestion';
      title.style.color = '#27ae60';
      panel.classList.add('hint-success');
      break;
    default:
      icon.textContent = 'üí°';
      title.textContent = 'AI Tutor';
      title.style.color = '#2c3e50';
  }
  
  // Show topic context
  if (topic) {
    topicDiv.innerHTML = `üìö Lesson: ${escapeHTML(topic)}`;
    topicDiv.style.display = 'block';
  } else {
    topicDiv.style.display = 'none';
  }
  
  // Show panel
  panel.style.display = 'block';
  

function closeSmartHint() {
  const panel = document.getElementById('smartHintPanel');
  if (panel) {
    panel.style.display = 'none';
  }
  
  // Stop speaking
  window.speechSynthesis.cancel();
}

// ============= ERROR DETECTION =============
function detectSyntaxError(code) {
  const lines = code.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    const lineNum = i + 1;
    
    if (!line || line.startsWith('#')) continue;
    
    // 1. Unclosed parentheses
    const openParens = (line.match(/\(/g) || []).length;
    const closeParens = (line.match(/\)/g) || []).length;
    if (openParens > closeParens) {
      return {
        message: `Line ${lineNum}: Missing closing parenthesis ')'`,
        lineNumber: lineNum
      };
    }
    if (closeParens > openParens) {
      return {
        message: `Line ${lineNum}: Extra closing parenthesis ')'`,
        lineNumber: lineNum
      };
    }
    
    // 2. Unclosed quotes
    const singleQuotes = (line.match(/(?<!\\)'/g) || []).length;
    const doubleQuotes = (line.match(/(?<!\\)"/g) || []).length;
    if (singleQuotes % 2 !== 0) {
      return {
        message: `Line ${lineNum}: Unclosed single quote '`,
        lineNumber: lineNum
      };
    }
    if (doubleQuotes % 2 !== 0) {
      return {
        message: `Line ${lineNum}: Unclosed double quote "`,
        lineNumber: lineNum
      };
    }
    
    // 3. Missing colon
    if (/^(if|elif|else|for|while|def|class)\s+/.test(line) && !line.endsWith(':')) {
      return {
        message: `Line ${lineNum}: Missing colon ':' at end of statement`,
        lineNumber: lineNum
      };
    }
    
    // 4. Print without parentheses
    if (/^print\s+[^(]/.test(line)) {
      return {
        message: `Line ${lineNum}: print needs parentheses. Use: print(...)`,
        lineNumber: lineNum
      };
    }
  }
  
  return null;
}

// ============= REAL-TIME CODE ANALYSIS =============
async function analyzeCodeInRealTime() {
  if (!editor) {
    console.log("Editor not ready");
    return;
  }

  const code = editor.getValue();
  
  if (code === lastAnalyzedCode || isAnalyzing) {
    return;
  }
  
  if (!code.trim()) {
    closeSmartHint();
    clearErrorHighlight();
    return;
  }
  
  isAnalyzing = true;
  lastAnalyzedCode = code;
  
  const selection = editor.getSelection();
  const cursorLine = selection.startLineNumber;
  
  // Detect syntax errors
  const errorData = detectSyntaxError(code);
  
  // Highlight error line if exists
  if (errorData) {
    highlightErrorLine(errorData.lineNumber);
  } else {
    clearErrorHighlight();
  }
  
  console.log("Detected error:", errorData);
  
  try {
    const response = await fetch("{% url 'webprojects:get_contextual_hint' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        code: code,
        file_id: currentFileId,
        cursor_line: cursorLine,
        error: errorData ? errorData.message : null
      })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      showSmartHint(data.hint, data.type, data.topic);
    }
  } catch (err) {
    console.error('‚ùå Fetch error:', err);
  } finally {
    isAnalyzing = false;
  }
}

function initializeSmartTutor() {
  console.log("üîß Initializing Smart Tutor...");
  
  if (!editor) {
    console.error("‚ùå Editor not ready for Smart Tutor");
    return;
  }

  console.log("‚úÖ Editor exists, attaching listener");

  // Listen to code changes
  editor.onDidChangeModelContent(() => {
    console.log("‚å®Ô∏è Code changed, starting timer...");
    
    clearTimeout(hintTimeout);
    
    hintTimeout = setTimeout(() => {
      console.log("‚è∞ 3 seconds passed, analyzing now...");
      analyzeCodeInRealTime();
    }, 10000);
  });

  console.log('‚úÖ Smart AI Tutor listener attached');
}



function getManualHint() {
  console.log("üñ±Ô∏è Manual hint requested");
  lastAnalyzedCode = '';
  analyzeCodeInRealTime();
}

// ============= DOM READY =============
document.addEventListener('DOMContentLoaded', function() {
  console.log("üîä Initializing speech...");
  
  if ('speechSynthesis' in window) {
  
  } else {
    console.error("‚ùå Speech synthesis not supported");
  }
});

console.log("‚úÖ All functions loaded");
</script>


<script>
  
(function () {
  'use strict';

  // ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let topicRegistry        = [];
  let activeTopicId        = null;
  let completionShownForId = null;  // track per-topic, not boolean
  let lastCode             = '';
  let isFetching           = false;
  let hintCooldown         = false;
  let hintTimer            = null;

  // course_id from template constant (set in SETUP block above)
  function getCourseId() {
    return (typeof window.COURSE_ID !== 'undefined' && window.COURSE_ID)
      ? window.COURSE_ID : null;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 1. PROGRESS BAR ‚Äî injected above Monaco editor
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


  // ‚îÄ‚îÄ Render progress API data into toolbar + sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderProgress(data) {
    // Persist globally so sidebar script can use it
    window._completedTopicIds = data.completed_topic_ids || [];
    window._currentTopicId    = data.current_topic_id;
    window._totalTopicCount   = data.total_count || 0;

    // Toolbar text
    _setText('st-topic-name',  data.current_topic_title || 'None selected');
    _setText('st-pct-label',   data.overall_pct + '% complete');
    _setText('st-count-label', data.completed_count + ' / ' + data.total_count + ' topics');

    // Fill bar
    const fill = document.getElementById('st-pb-fill');
    if (fill) {
      fill.style.width = data.overall_pct + '%';
      fill.style.background =
        data.overall_pct === 100 ? 'linear-gradient(90deg,#27ae60,#2ecc71)' :
        data.overall_pct >=  50  ? 'linear-gradient(90deg,#f39c12,#2ecc71)' :
                                   'linear-gradient(90deg,#3498db,#2ecc71)';
    }

    // Dots
    const dotsEl = document.getElementById('st-topic-dots');
    if (dotsEl && data.topics) {
      dotsEl.innerHTML = '';
      data.topics.forEach(t => {
        const d = document.createElement('div');
        d.title = t.title;
        const size = t.is_current ? '13px' : '10px';
        const bg   = t.completed ? '#27ae60' : t.is_current ? '#3498db' : '#2a2a3e';
        const bor  = t.completed ? '#1e8449' : t.is_current ? '#1a6fa3' : '#444';
        d.style.cssText = `
          width:${size};height:${size};background:${bg};border:1.5px solid ${bor};
          border-radius:50%;cursor:default;transition:all .3s;flex-shrink:0;`;
        d.addEventListener('mouseenter', () => {
          d.style.transform = 'scale(1.5)';
          _miniToast((t.completed ? '‚úÖ ' : t.is_current ? 'üìç ' : '‚óã ') + t.title);
        });
        d.addEventListener('mouseleave', () => { d.style.transform = 'scale(1)'; });
        dotsEl.appendChild(d);
      });
    }

    // KEY: push into sidebar applyTopicStates (defined in sidebar template)
    if (typeof window.applyTopicStates === 'function') {
      window.applyTopicStates(data);
    }

    // Keep activeTopicId in sync with what DB says is current
    if (data.current_topic_id && !activeTopicId) {
      activeTopicId = data.current_topic_id;
      localStorage.setItem('currentTopicId', activeTopicId);
    }
  }

  function _setText(id, txt) {
    const el = document.getElementById(id);
    if (el) el.textContent = txt;
  }

  function updateStepBadge(idx, total) {
    const badge = document.getElementById('st-step-badge');
    const text  = document.getElementById('st-step-text');
    if (!badge || !text) return;
    if (total > 0) {
      badge.style.display = 'flex';
      text.textContent    = 'Step ' + (idx + 1) + '/' + total;
    } else {
      badge.style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ fetchProgress ‚Äî sends course_id so counts are course-scoped ‚îÄ‚îÄ
  async function fetchProgress(justCompletedTopicId) {
    if (!window.PROGRESS_URL) return;
    try {
      const courseId = getCourseId();

      // Always require a course_id ‚Äî without it we get cross-course pollution
      if (!courseId) {
        console.warn('[SmartTutor] No course_id ‚Äî skipping fetchProgress');
        return;
      }

      const url = window.PROGRESS_URL + '?course_id=' + courseId;

      const res  = await fetch(url);
      const data = await res.json();
      if (data.status !== 'success') return;

      // Retry if just-completed topic is missing (DB race condition)
      if (justCompletedTopicId) {
        const ids = (data.completed_topic_ids || []).map(Number);
        if (!ids.includes(Number(justCompletedTopicId))) {
          console.log('[SmartTutor] Retrying progress fetch‚Ä¶');
          await _delay(600);
          const res2  = await fetch(url);
          const data2 = await res2.json();
          if (data2.status === 'success') { renderProgress(data2); return; }
        }
      }

      renderProgress(data);
    } catch (e) {
      console.warn('[SmartTutor] fetchProgress:', e);
    }
  }

  // ‚îÄ‚îÄ markTopicComplete ‚Äî ticks sidebar INSTANTLY then syncs DB ‚îÄ‚îÄ‚îÄ
async function markTopicComplete(topicId) {
    if (!window.MARK_DONE_URL || !topicId) return;
    const courseId = getCourseId();

    // ‚ö° INSTANT tick ‚Äî update DOM and cache before any fetch
    _tickSidebarItem(topicId);

    try {
      const res  = await fetch(window.MARK_DONE_URL, {
        method:  'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken':  window.CSRF_TOK || ''
        },
        body: JSON.stringify({
          topic_id:        topicId,
          course_id:       courseId,
          advance_to_next: true
        })
      });
      const data = await res.json();

      if (data.status === 'success') {
        console.log('[SmartTutor] ‚úÖ DB marked complete:', topicId);

        // Merge DB completed ids with our optimistic cache
        const merged = new Set([
          ...((data.completed_topic_ids || []).map(Number)),
          ...((window._completedTopicIds || []).map(Number)),
          Number(topicId)  // always include the one we just completed
        ]);
        window._completedTopicIds = Array.from(merged);
        window._currentTopicId    = data.next_topic_id || window._currentTopicId;

        // Update toolbar numbers
        if (data.overall_pct !== undefined) {
          const fill = document.getElementById('st-pb-fill');
          if (fill) fill.style.width = data.overall_pct + '%';
          _setText('st-pct-label',   data.overall_pct + '% complete');
          _setText('st-count-label', data.completed_count + ' / ' + data.total_count + ' topics');
          _setText('st-topic-name',  data.next_topic_title || _getText('st-topic-name'));
        }

        // Apply full state ‚Äî completed_topic_ids already has topicId merged in
        // so this will paint the tick GREEN not reset it
        if (typeof window.applyTopicStates === 'function') {
          window.applyTopicStates({
            current_topic_id:    data.next_topic_id    || window._currentTopicId,
            completed_topic_ids: Array.from(merged),
            total_count:         data.total_count      || window._totalTopicCount || 0,
            overall_pct:         data.overall_pct      || 0,
            completed_count:     data.completed_count  || merged.size,
          });
        }

        // ‚úÖ NO fetchProgress() call here ‚Äî it was racing and overwriting the tick
        // The data we got back from mark_topic_complete is already fresh from DB
      }
    } catch (e) {
      console.warn('[SmartTutor] markTopicComplete:', e);
    }
}
  // Direct DOM tick ‚Äî updates cache AND DOM atomically so no
  // subsequent applyTopicStates() call can overwrite the tick.
function _tickSidebarItem(topicId) {
    const id = Number(topicId);
    if (!id) { console.warn('[SmartTutor] _tickSidebarItem: invalid id', topicId); return; }

    // 1. Update cache first
    const done = new Set((window._completedTopicIds || []).map(Number));
    done.add(id);
    window._completedTopicIds = Array.from(done);

    // 2. Direct DOM update
    const item  = document.getElementById('topic-item-'  + id);
    const btn   = document.getElementById('topic-btn-'   + id);
    const icon  = document.getElementById('topic-icon-'  + id);
    const badge = document.getElementById('topic-badge-' + id);

    if (!item) {
        console.warn('[SmartTutor] topic-item-' + id + ' not found in DOM');
        return;
    }

    item.style.border          = '2px solid #27ae60';
    item.style.backgroundColor = '#f0fff4';

    if (btn) {
        btn.textContent      = '‚úÖ Completed';
        btn.style.background = '#27ae60';
        btn.style.fontWeight = 'bold';
        btn.style.cursor     = 'pointer';
    }
    if (icon)  icon.textContent = '‚úÖ';
    if (badge) {
        badge.style.display    = 'inline-block';
        badge.textContent      = '‚úÖ Done';
        badge.style.background = '#d4edda';
        badge.style.color      = '#155724';
        badge.style.border     = '1px solid #c3e6cb';
    }

    console.log('[SmartTutor] ‚ö° DOM tick done for', id, '| all completed:', window._completedTopicIds);

    // 3. Force applyTopicStates with merged cache
    if (typeof window.applyTopicStates === 'function') {
        window.applyTopicStates({
            current_topic_id:    window._currentTopicId || null,
            completed_topic_ids: Array.from(done),
            total_count:         window._totalTopicCount || 0,
        });
    }
}
  function _getText(id) {
    const el = document.getElementById(id);
    return el ? el.textContent : '';
  }

  function _delay(ms) { return new Promise(r => setTimeout(r, ms)); }

  function _miniToast(msg) {
    let t = document.getElementById('st-mini-toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'st-mini-toast';
      t.style.cssText = `
        position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
        background:#333;color:#fff;padding:6px 14px;border-radius:20px;
        font-size:12px;z-index:99999;pointer-events:none;
        opacity:0;transition:opacity .2s;`;
      document.body.appendChild(t);
    }
    t.textContent   = msg;
    t.style.opacity = '1';
    clearTimeout(t._t);
    t._t = setTimeout(() => { t.style.opacity = '0'; }, 1800);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 2. TOPIC REGISTRY
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function buildRegistry() {
    topicRegistry = [];
    document.querySelectorAll('.topic-item[data-topic-id]').forEach((item, idx) => {
      const id    = parseInt(item.dataset.topicId, 10);
      const el    = item.querySelector('strong');
      const title = el
        ? el.textContent.replace(/^\d+\.\s*/, '').trim()
        : 'Topic ' + (idx + 1);
      topicRegistry.push({ id, title, index: idx });
    });
    console.log('[SmartTutor] Registry:',
      topicRegistry.map(t => '[' + t.index + '] ' + t.title).join(', '));
  }

  function entryById(id) {
    return topicRegistry.find(t => t.id === id) || null;
  }

  function nextEntry() {
    const cur = entryById(activeTopicId);
    if (!cur) return topicRegistry[0] || null;
    return topicRegistry[cur.index + 1] || null;
  }

  // Wrap setCurrentTopic so the patch stays in sync
  function patchSetCurrentTopic() {
    const _orig = window.setCurrentTopic;
    window.setCurrentTopic = function (topicId, btn) {
      activeTopicId        = topicId;
      completionShownForId = null;  // reset so new topic can show completion
      lastCode             = '';
      localStorage.setItem('currentTopicId', topicId);
      if (typeof _orig === 'function') _orig(topicId, btn);
      setTimeout(() => fetchProgress(), 700);
    };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 3. EDITOR LISTENER + HINT FETCH
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function attachEditorListener() {
    if (!window.editor) { setTimeout(attachEditorListener, 500); return; }
    window.editor.onDidChangeModelContent(() => {
      clearTimeout(hintTimer);
      hintTimer = setTimeout(analyzeCode, 3000);
    });
    console.log('[SmartTutor] Editor listener attached.');
  }

  async function analyzeCode() {
    if (!window.editor || isFetching || hintCooldown) return;

    const code = window.editor.getValue().trim();
    if (code === lastCode && code !== '') return;
    lastCode = code;

    if (!activeTopicId) {
      showPanel({
        icon: 'üìö', title: 'Select a Topic First',
        border: '#f39c12', bg: '#fffbe6', left: '#f39c12',
        body:   'Click <strong>Study This Topic</strong> in the sidebar to begin.',
        speech: 'Please select a topic from the sidebar first.'
      });
      return;
    }

    const cur      = entryById(activeTopicId);
    const next     = nextEntry();
    const courseId = getCourseId();
    const err      = detectSyntax(code);

    if (err) highlightLine(err.line); else clearHighlight();

    isFetching = true;
    try {
      const res = await fetch(window.HINT_URL, {
        method:  'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken':  window.CSRF_TOK || ''
        },
        body: JSON.stringify({
          code,
          file_id:          window.CURRENT_FILE_ID || 0,
          cursor_line:      window.editor.getPosition().lineNumber,
          error:            err ? err.msg : null,
          current_topic:    cur  ? cur.title  : null,
          current_topic_id: cur  ? cur.id     : null,
          next_topic:       next ? next.title  : null,
          next_topic_id:    next ? next.id     : null,
          course_id:        courseId,            // ‚Üê FIXED: now sent
          strict_topic:     true
        })
      });

      const data = await res.json();
      if (data.status !== 'success') return;

      // Update step badge in toolbar
      if (data.total_steps > 0) {
        updateStepBadge(data.step_index || 0, data.total_steps);
      }

      // ‚îÄ‚îÄ COMPLETION ‚Äî only show once per unique topic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (data.type === 'topic_complete') {
    completionShownForId = activeTopicId;

    console.log('[SmartTutor] üéØ topic_complete received ‚Äî ticking now');

    // 1. Tick the DOM immediately using the ID from the response
    const topicToTick = data.completed_topic_id || activeTopicId;
    _tickSidebarItem(topicToTick);

    // 2. Celebrate
    showCompletionPanel(cur, next, data.hint);

    // 3. Save to DB in background
    markTopicComplete(topicToTick);

 } else // ‚îÄ‚îÄ COMPLETION from hint system ‚Äî NEVER mark complete here ‚îÄ‚îÄ‚îÄ‚îÄ
if (data.type === 'topic_complete') {
    // The hint system only sees CODE, not actual output.
    // Only validateWithAI (which checks real output) can mark complete.
    // Just show encouragement panel, nothing else.
    console.log('[SmartTutor] topic_complete hint received ‚Äî encouragement only, NOT marking complete');
    if (completionShownForId !== activeTopicId) {
        completionShownForId = activeTopicId;
        showCompletionPanel(cur, next, data.hint);
        // ‚ùå NO _tickSidebarItem
        // ‚ùå NO markTopicComplete
    }
} else {
    showStepPanel(data);
}

    } catch (e) {
      console.error('[SmartTutor] analyzeCode:', e);
    } finally {
      isFetching   = false;
      hintCooldown = true;
      setTimeout(() => { hintCooldown = false; }, 8000);
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 4. PANEL RENDERING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function showStepPanel(data) {
    const {
      hint, type, topic,
      step_index, total_steps,
      current_example, next_example
    } = data;

    const stepNum  = (step_index ?? 0) + 1;
    const totalNum = total_steps || 1;
    const pct      = Math.round((stepNum - 1) / totalNum * 100);
    const border   = typeColor(type);

    const progressHTML = total_steps > 0 ? `
      <div style="margin-bottom:12px;">
        <div style="display:flex;justify-content:space-between;
                    font-size:11px;color:#666;margin-bottom:3px;">
          <span>üìç Step ${stepNum} of ${totalNum}</span>
          <span>${pct}%</span>
        </div>
        <div style="background:#e0e0e0;border-radius:20px;height:5px;overflow:hidden;">
          <div style="background:#3498db;width:${pct}%;height:100%;
                      border-radius:20px;transition:width .4s;"></div>
        </div>
      </div>` : '';

    const exampleHTML = current_example ? `
      <div style="margin:10px 0;padding:10px;background:#1e1e1e;
                  border-radius:6px;border-left:4px solid #3498db;">
        <div style="font-size:10px;color:#888;margin-bottom:4px;
                    text-transform:uppercase;letter-spacing:1px;">
          ‚úçÔ∏è Type this now
        </div>
        <code style="color:#4ec9b0;font-size:14px;font-family:monospace;
                     white-space:pre-wrap;">${escHTML(current_example)}</code>
        <button
          onclick="SmartTutor.insertExample(\`${escAttr(current_example)}\`, this)"
          style="margin-top:8px;padding:3px 10px;font-size:11px;
                 background:#264f78;color:#fff;border:none;
                 border-radius:3px;cursor:pointer;display:block;">
          üìã Insert into editor
        </button>
      </div>` : '';

    const hintHTML = `
      <div style="padding:10px;background:${typeBg(type)};border-radius:6px;
                  border-left:4px solid ${border};font-size:13px;
                  line-height:1.6;color:#2c3e50;margin-bottom:8px;">
        ${escHTML(hint)}
      </div>`;

    const nextHTML = next_example ? `
      <div style="padding:7px 10px;background:#f5f5f5;border-radius:5px;
                  font-size:11px;color:#666;border-left:3px solid #ccc;">
        <strong>Coming up:</strong>
        <code style="margin-left:5px;color:#333;">${escHTML(next_example)}</code>
      </div>` : '';

    showPanel({
      icon:     typeIcon(type),
      title:    topic
                  ? topic + ' ‚Äî Step ' + stepNum + '/' + totalNum
                  : typeTitle(type),
      border,
      bg:       '#fff',
      left:     border,
      body:     progressHTML + exampleHTML + hintHTML + nextHTML,
      speech:   hint,
      autohide: type !== 'error'
    });
  }

  function showCompletionPanel(cur, next, hint) {
    // üéä Fire celebration immediately
    _launchCelebration();

    const nextBlock = next
      ? `<div style="margin-top:12px;padding:12px;background:#e8fff0;
                     border-radius:8px;border-left:4px solid #27ae60;">
           <strong>üëâ Up next:</strong>
           <em>${escHTML(next.title)}</em><br>
           <button onclick="SmartTutor.jumpTo(${next.id})" style="
             margin-top:8px;padding:6px 16px;background:#27ae60;color:white;
             border:none;border-radius:4px;cursor:pointer;
             font-size:13px;font-weight:bold;">
             Start Next Topic ‚Üí
           </button>
         </div>`
      : `<div style="margin-top:10px;padding:10px;
                     background:#e8fff0;border-radius:8px;">
           üèÜ <strong>All topics complete! You are a Python star!</strong>
         </div>`;

    showPanel({
      icon:  'üéâ',
      title: 'Topic Complete!',
      border: '#27ae60', bg: '#efffef', left: '#27ae60',
      body:   `<div style="padding:10px;background:#efffef;border-radius:6px;
                            border-left:4px solid #27ae60;font-size:13px;
                            line-height:1.6;color:#2c3e50;margin-bottom:8px;">
                 ${escHTML(hint || 'Great work!')}
               </div>` + nextBlock,
      speech:   (hint || 'Great work!') +
                (next ? ' Up next: ' + next.title + '.' : ''),
      autohide: false
    });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üéä CELEBRATION ENGINE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function _launchCelebration() {
    _injectCelebrationStyles();
    _flashScreenGreen();
    _fireConfetti();
    _spawnDancingEmojis();
  }

  function _injectCelebrationStyles() {
    if (document.getElementById('st-celebration-styles')) return;
    const style = document.createElement('style');
    style.id = 'st-celebration-styles';
    style.textContent = `
      @keyframes st-flash {
        0%   { opacity: 1; }
        100% { opacity: 0; }
      }
      @keyframes st-emoji-rise {
        0%   { transform: translateY(0)     rotate(0deg)   scale(0.5); opacity: 1; }
        30%  { transform: translateY(-30vh) rotate(12deg)  scale(1.2); opacity: 1; }
        60%  { transform: translateY(-60vh) rotate(-8deg)  scale(1.0); opacity: 0.9; }
        100% { transform: translateY(-95vh) rotate(18deg)  scale(0.6); opacity: 0; }
      }
      @keyframes st-emoji-bounce {
        0%,100% { transform: translateY(0); }
        50%     { transform: translateY(-18px); }
      }
    `;
    document.head.appendChild(style);
  }

  function _flashScreenGreen() {
    const flash = document.createElement('div');
    flash.style.cssText = `
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(39,174,96,0.22);pointer-events:none;
      z-index:999990;animation:st-flash 700ms ease-out forwards;`;
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 750);
  }

  function _fireConfetti() {
    const COLORS = ['#27ae60','#3498db','#f39c12','#e74c3c',
                    '#9b59b6','#1abc9c','#f1c40f','#e67e22','#fff'];
    const COUNT  = 130;

    const canvas = document.createElement('canvas');
    canvas.style.cssText = `
      position:fixed;top:0;left:0;width:100%;height:100%;
      pointer-events:none;z-index:999995;`;
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
    document.body.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const particles = [];

    for (let i = 0; i < COUNT; i++) {
      const side = Math.random() < 0.5 ? 0 : canvas.width;
      particles.push({
        x:       side + (Math.random() - 0.5) * 80,
        y:       canvas.height * (0.1 + Math.random() * 0.4),
        vx:      (side === 0 ? 1 : -1) * (2 + Math.random() * 5),
        vy:      -(4 + Math.random() * 7),
        size:    5 + Math.random() * 9,
        color:   COLORS[Math.floor(Math.random() * COLORS.length)],
        shape:   Math.random() < 0.5 ? 'rect' : 'circle',
        rot:     Math.random() * 360,
        rotV:    (Math.random() - 0.5) * 10,
        alpha:   1,
        gravity: 0.18 + Math.random() * 0.14,
        wave:    Math.random() * Math.PI * 2,
        waveAmp: (Math.random() - 0.5) * 2,
      });
    }

    let frame;
    let tick = 0;
    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      tick++;
      let alive = false;

      particles.forEach(p => {
        if (p.alpha <= 0.01) return;
        alive = true;
        p.vy  += p.gravity;
        p.x   += p.vx + Math.sin(p.wave + tick * 0.04) * p.waveAmp;
        p.y   += p.vy;
        p.rot += p.rotV;
        if (p.y > canvas.height * 0.75) p.alpha -= 0.03;

        ctx.save();
        ctx.globalAlpha = Math.max(p.alpha, 0);
        ctx.translate(p.x, p.y);
        ctx.rotate((p.rot * Math.PI) / 180);
        ctx.fillStyle = p.color;

        if (p.shape === 'circle') {
          ctx.beginPath();
          ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
          ctx.fill();
        } else {
          ctx.fillRect(-p.size / 2, -p.size / 3, p.size, p.size * 0.6);
        }
        ctx.restore();
      });

      if (alive) {
        frame = requestAnimationFrame(animate);
      } else {
        cancelAnimationFrame(frame);
        canvas.remove();
      }
    };

    frame = requestAnimationFrame(animate);
    setTimeout(() => { cancelAnimationFrame(frame); canvas.remove(); }, 5500);
  }

  function _spawnDancingEmojis() {
    const EMOJIS = ['üéâ','‚≠ê','üèÜ','üéä','‚ú®','üöÄ','üíØ','üåü','üëè','üî•','üí™','üòÑ','üéØ','ü•≥'];
    const COUNT  = 14;

    for (let i = 0; i < COUNT; i++) {
      setTimeout(() => {
        const el   = document.createElement('div');
        const em   = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
        const left = 3 + Math.random() * 94;
        const size = 26 + Math.floor(Math.random() * 28);
        const rise = 1600 + Math.random() * 1400;
        const delay= Math.random() * 300;

        el.textContent   = em;
        el.style.cssText = `
          position:fixed;
          left:${left}%;
          bottom:-70px;
          font-size:${size}px;
          z-index:999996;
          pointer-events:none;
          user-select:none;
          animation:
            st-emoji-rise  ${rise}ms ${delay}ms ease-out forwards,
            st-emoji-bounce 600ms ${delay}ms ease-in-out 3;
        `;
        document.body.appendChild(el);
        setTimeout(() => { if (el.parentNode) el.remove(); }, rise + delay + 200);
      }, i * 100);
    }
  }

  function showPanel({ icon, title, border, bg, left,
                       body, topic, speech, autohide }) {
    const panel   = document.getElementById('smartHintPanel');
    const content = document.getElementById('hintContent');
    const topicEl = document.getElementById('hintTopic');
    const iconEl  = document.getElementById('hintIcon');
    const titleEl = document.getElementById('hintTitle');
    if (!panel) return;

    if (window.hintAutoHideTimeout) clearTimeout(window.hintAutoHideTimeout);

    panel.className          = '';
    panel.style.border       = '2px solid ' + border;
    panel.style.boxShadow    = '0 8px 32px ' + border + '44';
    iconEl.textContent       = icon;
    titleEl.textContent      = title;
    titleEl.style.color      = border;
    content.innerHTML        = body;
    content.style.background = bg;
    content.style.borderLeft = '4px solid ' + left;

    if (topic) {
      topicEl.innerHTML     = 'üìö Lesson: <strong>' + escHTML(topic) + '</strong>';
      topicEl.style.display = 'block';
    } else {
      topicEl.style.display = 'none';
    }

    panel.style.display = 'block';
    if (speech) speak(speech);

    if (autohide !== false) {
      const ms = Math.max(
        ((speech || '').split(' ').length / 2.5) * 1000, 8000
      ) + 5000;
      window.hintAutoHideTimeout = setTimeout(() => {
        if (!window.speechSynthesis.speaking) closePanel();
      }, ms);
    }
  }

  function closePanel() {
    const p = document.getElementById('smartHintPanel');
    if (p) p.style.display = 'none';
    if (window.speechSynthesis) window.speechSynthesis.cancel();
  }
  window.closeSmartHint = closePanel;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 5. SPEECH
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function speak(text) {
  window.speakText(text);  // ‚Üê Use the global function
}

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 6. SYNTAX DETECTION + HIGHLIGHT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function detectSyntax(code) {
    const lines = code.split('\n');
    for (let i = 0; i < lines.length; i++) {
      const l = lines[i].trim(), n = i + 1;
      if (!l || l.startsWith('#')) continue;
      const op = (l.match(/\(/g) || []).length;
      const cp = (l.match(/\)/g) || []).length;
      if (op > cp) return { line: n, msg: 'Line ' + n + ': Missing closing )' };
      if (cp > op) return { line: n, msg: 'Line ' + n + ': Extra closing )' };
      if ((l.match(/(?<!\\)'/g)  || []).length % 2 !== 0)
        return { line: n, msg: 'Line ' + n + ': Unclosed single quote' };
      if ((l.match(/(?<!\\)"/g)  || []).length % 2 !== 0)
        return { line: n, msg: 'Line ' + n + ': Unclosed double quote' };
      if (/^(if|elif|else|for|while|def|class)\b/.test(l) && !l.endsWith(':'))
        return { line: n, msg: 'Line ' + n + ': Missing colon at end' };
      if (/^print\s+[^(]/.test(l))
        return { line: n, msg: 'Line ' + n + ': Use print(...) with parentheses' };
    }
    return null;
  }

  function highlightLine(n) {
    if (!window.editor || !window.monaco) return;
    window._errDec = window.editor.deltaDecorations(
      window._errDec || [], [{
        range:   new monaco.Range(n, 1, n, 1000),
        options: {
          isWholeLine:         true,
          className:           'error-line-highlight',
          glyphMarginClassName:'error-line-glyph'
        }
      }]
    );
    window.editor.revealLineInCenter(n);
    setTimeout(clearHighlight, 10000);
  }

  function clearHighlight() {
    if (window.editor && window._errDec)
      window._errDec = window.editor.deltaDecorations(window._errDec, []);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 7. HELPERS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function escHTML(s) {
    return s
      ? String(s).replace(/[&<>"']/g, t =>
          ({ '&':'&amp;', '<':'&lt;', '>':'&gt;',
             '"':'&quot;', "'":'&#39;' }[t]))
      : '';
  }

  function escAttr(s) {
    return s
      ? s.replace(/\\/g, '\\\\')
           .replace(/`/g,  '\\`')
           .replace(/\$/g, '\\$')
      : '';
  }

  function typeIcon(t) {
    return { error:'‚ö†Ô∏è', start:'üöÄ', next_step:'üí°', improvement:'‚ú®' }[t] || 'üí°';
  }
  function typeTitle(t) {
    return { error:'Error', start:'Start Here',
             next_step:'Next Step', improvement:'Suggestion' }[t] || 'AI Tutor';
  }
  function typeColor(t) {
    return { error:'#e74c3c', start:'#27ae60',
             next_step:'#3498db', improvement:'#27ae60' }[t] || '#2c3e50';
  }
  function typeBg(t) {
    return { error:'#fff0f0', start:'#efffef',
             next_step:'#eff8ff', improvement:'#efffef' }[t] || '#f8f9fa';
  }

  function jumpTo(topicId) {
    closePanel();
    document.querySelectorAll('.topic-study-btn').forEach(btn => {
      if (parseInt(btn.dataset.topicId, 10) === topicId) {
        btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => btn.click(), 400);
      }
    });
  }

  function insertExample(code, btn) {
    if (window.editor) {
      const model   = window.editor.getModel();
      const last    = model.getLineCount();
      const lastCol = model.getLineMaxColumn(last);
      const existing = model.getValue().trim();
      window.editor.executeEdits('smart-tutor', [{
        range: new monaco.Range(last, lastCol, last, lastCol),
        text:  existing ? '\n' + code : code
      }]);
      window.editor.revealLine(model.getLineCount());
      window.editor.focus();
    } else {
      navigator.clipboard && navigator.clipboard.writeText(code);
    }
    if (btn) {
      btn.textContent = '‚úÖ Inserted!';
      setTimeout(() => { btn.textContent = 'üìã Insert into editor'; }, 2000);
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // 8. INIT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  document.addEventListener('DOMContentLoaded', () => {
    buildRegistry();
    patchSetCurrentTopic();
   

    // Restore active topic from localStorage
    const saved = localStorage.getItem('currentTopicId');
    if (saved) activeTopicId = parseInt(saved, 10);

    // Load real progress from DB ‚Üí renderProgress ‚Üí applyTopicStates ‚Üí sidebar ticks
    fetchProgress();

    attachEditorListener();

    // Allow toolbar "Get Hint" button to force a fresh analysis
    window.getManualHint = () => { lastCode = ''; analyzeCode(); };
    startPolling();
  });

  // Public API
  window.SmartTutor = {
    jumpTo,
    insertExample,
    refreshProgress: () => fetchProgress()
  };
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 9. LIVE POLLING ‚Äî updates sidebar every 5s without page reload
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function startPolling() {
  let lastSnapshot = '';

  setInterval(async () => {
    try {
      // Build URL safely ‚Äî only append course_id if it's a real number
      const courseId = (typeof COURSE_ID !== 'undefined' && COURSE_ID && !isNaN(COURSE_ID))
        ? COURSE_ID : null;

      const url = courseId
        ? `{% url 'webprojects:get_student_progress' %}?course_id=${courseId}`
        : `{% url 'webprojects:get_student_progress' %}`;

      const res  = await fetch(url);
      if (!res.ok) return;  // silently skip bad responses
      const data = await res.json();
      if (data.status !== 'success') return;

      // Snapshot to detect changes
      const snapshot = JSON.stringify({
        completed: (data.completed_topic_ids || []).sort(),
        current:   data.current_topic_id
      });

      if (snapshot === lastSnapshot) return;  // nothing changed
      lastSnapshot = snapshot;

      console.log('[Poll] Change detected ‚Äî updating sidebar');

      // Merge with optimistic cache so ticks are never lost
      const merged = new Set([
        ...(data.completed_topic_ids || []).map(Number),
        ...(window._completedTopicIds || []).map(Number),
      ]);
      data.completed_topic_ids = Array.from(merged);

      renderProgress(data);

      if (typeof window.applyTopicStates === 'function') {
        window.applyTopicStates(data);
      }

    } catch (e) {
      // Silently ignore ‚Äî don't spam console on every poll failure
    }
  }, 5000);
}

})();

</script>
{% endblock %}