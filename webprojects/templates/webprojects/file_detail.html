{% extends "webprojects/base_editor.html" %}
{% load file_filters %}

{% block title %}{{ file.name }} | {{ file.project.name }}{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Segoe UI', sans-serif;
    background-color: #1e1e1e;
    color: #ccc;
  }

  .editor-layout {
    display: flex;
    height: calc(100vh - 48px);
    transition: all 0.3s ease;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    background: #1e1e1e;
    border-bottom: 1px solid #444;
    justify-content: flex-start;
  }

  .toolbar button,
  .toolbar select {
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    font-size: 0.95em;
    background: #333;
    color: #eee;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .toolbar button:hover,
  .toolbar select:hover {
    background: #444;
  }

  .sidebar {
    width: 250px;
    background-color: #252526;
    padding: 10px;
    border-right: 1px solid #444;
    overflow-y: auto;
    transition: all 0.3s ease;
  }

  .folder-toggle {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    color: #ccc;
    margin: 10px 0 5px;
    transition: color 0.3s ease;
  }

  .folder-toggle:hover {
    color: #fff;
  }

  .file-group {
    margin-left: 10px;
    display: none;
    transition: all 0.3s ease;
  }

  .folder-toggle.open + .file-group {
    display: block;
  }

  .file-item {
    margin: 4px 0;
  }

  .file-item a {
    color: #bbb;
    text-decoration: none;
    font-size: 0.9em;
    display: block;
    padding: 2px 0;
    transition: color 0.2s ease;
  }

  .file-item a:hover {
    color: #fff;
  }

  .editor-panel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #container {
    flex-grow: 1;
    border-top: 1px solid #444;
    border-bottom: 1px solid #444;
    min-height: 100px;
  }

  #outputPanel {
    height: 160px;
    background: #1e1e1e;
    color: #dcdcdc;
    padding: 10px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
    border-top: 1px solid #444;
  }

  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
  }

  ::-webkit-scrollbar-track {
    background: #2c2c2c;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .editor-layout {
      flex-direction: column;
    }

    .sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #444;
      max-height: 200px;
      overflow-y: auto;
    }

    .toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .editor-panel {
      height: auto;
    }

    #outputPanel {
      height: 140px;
    }
  }

  @media (max-width: 480px) {
    .toolbar button,
    .toolbar select {
      width: 100%;
      font-size: 0.9em;
    }

    .folder-toggle {
      font-size: 0.9em;
    }

    .file-item a {
      font-size: 0.85em;
    }
  }

  /* Spinner animation */
  .spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 3px solid #ccc;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Sidebar collapse toggle for mobile */
  .editor-layout.collapsed .sidebar {
    display: none;
  }

  .editor-layout.collapsed .editor-panel {
    width: 100% !important;
  }
#toastMessage {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 600px;
  background: #333;
  color: #fff;
  padding: 12px 16px;
  font-size: 0.95em;
  display: none;
  opacity: 0;
  z-index: 9999;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: opacity 0.3s ease;
}

</style>
<style>
/* Folder toggle header */
.folder-toggle {
    background-color: #2b2b2b;
    color: #fff;
    padding: 10px 15px;
    margin-top: 10px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    transition: background 0.3s;
}

.folder-toggle:hover {
    background-color: #444;
}

/* File group container */
.file-group {
    padding-left: 20px;
    margin-bottom: 10px;
    display: none; /* Hidden by default, toggle with JS */
}

/* Individual file item */
.file-item {
    padding: 6px 10px;
    margin-bottom: 4px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #f5f5f5;
    transition: background 0.3s;
}

.file-item a {
    text-decoration: none;
    color: #333;
    flex-grow: 1;
}

.file-item a:hover {
    text-decoration: underline;
    color: #007bff;
}

/* Buttons */
.btn {
    padding: 2px 6px;
    font-size: 0.8rem;
    border-radius: 4px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-sm {
    font-size: 0.75rem;
    padding: 2px 5px;
}

.btn-primary {
    background-color: #007bff;
    color: #fff;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-danger {
    background-color: #dc3545;
    color: #fff;
}

.btn-danger:hover {
    background-color: #b02a37;
}

/* Highlight selected file */
.file-item a[style*="font-weight:bold"] {
    background-color: #007bff;
    color: #fff !important;
    padding: 4px 8px;
    border-radius: 4px;
}

/* Image file color */
.file-item a[onclick*="showImageModal"] {
    color: #4fa;
    font-weight: bold;
}
</style>

<!-- roller -->
 <style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

{% endblock %}

{% block header %}
<a style="color: white;" href="{% url 'create_project' %}">
  üìÅ {{ file.project.name }} ‚Äî üìù {{ file.name }}
</a>  

{% endblock %}


{% block sidebar %}

<div id="dropZone" style="border: 2px dashed #555; padding: 10px; text-align: center; color: #aaa;">
  Drop File Here or 
  <label for="fileInput" style="color: #4fa; cursor:pointer;">Browse</label>
  <input type="file" id="fileInput" 
         accept=".png,.jpg,.jpeg,.gif,.xls,.xlsx,.csv" 
         style="display:none;">
</div>
<small style="color: #888;">Images and Excel files will be added to your files</small>

<!-- Global Upload Spinner -->
<!-- üîÑ Upload Loader -->
<div id="upload-loader" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  z-index:9999;
  justify-content:center;
  align-items:center;
">
  <div style="
    width:50px; height:50px;
    border:5px solid #f3f3f3;
    border-top:5px solid #3498db;
    border-radius:50%;
    animation: spin 1s linear infinite;
  "></div>
</div>


<!-- <div id="dropZone" style="border: 2px dashed #555; padding: 10px; text-align: center; color: #aaa;">
  Drop Image Here or <label for="imageInput" style="color: #4fa;">Browse</label>
  <input type="file" id="imageInput" accept="image/*" style="display:none;">
</div>
<small style="color: #888;">Image will be added to your files</small> -->

<div style="margin-bottom: 20px;">
  <input type="text" id="newFileName" placeholder="üìù New file name (e.g., index.html)" style="width: 100%; padding: 5px; margin-bottom: 5px; font-size: 0.9em;">
  <button onclick="createNewFile()" style="width: 100%; background: #3498db; color: white; padding: 6px 10px; border: none; border-radius: 4px;">‚ûï Create File</button>
</div>

<hr>

{% for ext in exts %}
  {% with files|dictsort:"name" as sorted_files %}
    <div class="folder-toggle" data-ext="{{ ext }}">
      üìÅ {{ ext|upper }} Files <span>‚Æü</span>
    </div>
    <div class="file-group">
      {% for f in sorted_files %}
        {% if f.name|has_ext:ext %}
          {% with f.name|lower as fname %}
            <div class="file-item">

              {% if fname|slice:"-4:" == ".png" or fname|slice:"-4:" == ".jpg" or fname|slice:"-5:" == ".jpeg" or fname|slice:"-4:" == ".gif" %}
                <!-- üëá Image File: Open Modal -->
                <a href="javascript:void(0);" onclick="showImageModal('{{ f.image.url }}')" style="color:#4fa;">üñºÔ∏è {{ f.name }}</a>

              {% else %}
                <!-- üëá Normal File: Go to Editor -->
                <a href="{% url 'file_detail' f.project.id f.id %}" {% if f.id == file.id %}style="font-weight:bold;color:#fff;"{% endif %}>üìù {{ f.name }}</a>

                {% if ".html" in f.name|lower %}
                  <a href="{% url 'share_preview' f.project.id f.id %}" target="_blank">üîóShare</a>
                {% endif %}

                {% if f.is_excel %}
                  <!-- üëá Excel/CSV Preview Button -->
                  <a href="{% url 'file_preview' f.project.id f.id %}" class="btn btn-sm ">View</a>
                {% endif %}

              {% endif %}

              <!-- üëá Delete Button for all files -->
              <form method="POST" action="{% url 'file_delete' f.project.id f.id %}" class="delete-file-form d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
              </form>

            </div>
          {% endwith %}
        {% endif %}
      {% endfor %}
    </div>
  {% endwith %}
{% endfor %}


<!-- üñºÔ∏è Image Popup Modal -->
<div id="imagePopupModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000;">
  <span onclick="closeImageModal()" style="position:absolute; top:20px; right:30px; font-size:32px; color:white; cursor:pointer;">&times;</span>
  <div style="display:flex; align-items:center; justify-content:center; height:100%;">
    <img id="popupImage" src="" alt="Preview" style="max-width:90%; max-height:90%; border: 2px solid #555; border-radius: 8px;" />
  </div>
</div>



{% endblock %}


{% block content %}
<div style="padding: 8px 12px; background: #222; border-bottom: 1px solid #444; text-align: right;">
 <button id="runBtnCode" onclick="runCode()" style="background:#2ecc71; color:white;">‚ñ∂ Run Code</button> 
  <button id="toggleAI" onclick="toggleAITools()" style="background: #444; color: #fff; padding: 6px 12px; border: none; border-radius: 4px;">
    üîß Show AI Tools
  </button>
</div>

<div id="aiToolbar" class="toolbar">
  
  <span id="aiLoading" style="display:none;">‚è≥</span>
  <button id="aiBtn" onclick="getAISuggestion()">üí° AI Suggest</button>
  <button id="explainBtn" onclick="explainCode()">üí¨ Explain Code</button>
  <select id="aiAction">
    <option value="complete">üîß Complete</option>
    <option value="explain">üí¨ Explain</option>
    <option value="optimize">‚ö° Optimize</option>
    <option value="comment">üìù Add Comments</option>
    <option value="fix">üêû Fix Bugs</option>
  </select>
  <button id="runBtn" onclick="runAIAction()">üöÄ Run AI Action</button>
</div>

<!-- delete js  -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteForms = document.querySelectorAll('.delete-file-form');

    deleteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();  // prevent normal form submission

            if (!confirm("Are you sure you want to delete this file?")) return;

            const url = form.getAttribute('action');
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove file item from DOM
                    form.closest('.file-item').remove();
                } else {
                    alert(data.message || 'Failed to delete file.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting file.');
            });
        });
    });
});
</script>




<script>
  function toggleAITools() {
    const aiToolbar = document.getElementById("aiToolbar");
    const toggleBtn = document.getElementById("toggleAI");

    if (aiToolbar.style.display === "none" || aiToolbar.style.display === "") {
      aiToolbar.style.display = "flex";
      toggleBtn.textContent = "‚ùå Hide AI Tools";
    } else {
      aiToolbar.style.display = "none";
      toggleBtn.textContent = "üîß Show AI Tools";
    }
  }

  // Auto-hide toolbar on small screens
  document.addEventListener("DOMContentLoaded", function () {
    if (window.innerWidth <= 768) {
      document.getElementById("aiToolbar").style.display = "none";
    }
  });
</script>

<div class="editor-panel" style="display: flex; flex-direction: column; height: 100%;">
  <div id="container" style="flex-grow: 1; min-height: 10px;"></div>

  <!-- Resize handle -->
  <div id="resizeHandle" style="height: 6px; cursor: row-resize; background: #444;"></div>

  <!-- Output panel -->
  <div id="outputPanel" style="height: 160px; background: #1e1e1e; color: #dcdcdc; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.9em; border-top: 1px solid #444;">
    <strong>üîΩ Output:</strong>
    <pre id="outputText" style="white-space: pre-wrap;"></pre>
    <div id="tablePreview" style="margin-top: 15px;display: none;"></div>
    <div id="plotPreview" style="display: none;"></div>
  </div>
</div>

    <!-- AI Suggestion Preview Modal -->
<div id="aiModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:#2d2d2d; color:#fff; padding:20px; border-radius:8px; z-index:1000; max-width:80%; box-shadow:0 0 10px #000;">
  <h3>üí° AI Suggestion Preview</h3>
  <pre id="aiModalContent" style="max-height:400px; overflow-y:auto; white-space:pre-wrap; background:#1e1e1e; padding:10px; border:1px solid #444;"></pre>
  <div style="text-align:right; margin-top:10px;">
    <button onclick="insertSuggestionFromModal()" style="background:#2ecc71; color:white; padding:6px 12px; border:none; border-radius:4px;">Insert</button>
    <button onclick="closeAIModal()" style="background:#e74c3c; color:white; padding:6px 12px; border:none; border-radius:4px; margin-left:8px;">Cancel</button>
  </div>
</div>

  </div>
</div>

<div id="toastMessage" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #222;
  color: #fff;
  padding: 10px 18px;
  border-radius: 6px;
  z-index: 9999;
  font-size: 0.9em;
  max-width: 90%;
  text-align: left;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
"></div>


<!-- js section -->
<!-- your sidebar content below... -->
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const editorLayout = document.getElementById('editorLayout');
    const toggleBtn = document.getElementById('toggleSidebarBtn');

    const updateToggleIcon = (isCollapsed) => {
      toggleBtn.innerHTML = isCollapsed 
        ? '<span title="Open Sidebar">‚ò∞</span>' 
        : '<span title="Close Sidebar">‚úñ</span>';
    };

    toggleBtn.addEventListener('click', () => {
      const isCollapsed = editorLayout.classList.toggle('collapsed');
      updateToggleIcon(isCollapsed);

      // Relayout Monaco Editor
      setTimeout(() => {
        if (window.editor?.layout) {
          window.editor.layout();
        }
      }, 100);
    });

    // Initial state
    updateToggleIcon(editorLayout.classList.contains('collapsed'));
  });
</script>

<script>
  function showImageModal(imgUrl) {
    document.getElementById('popupImage').src = imgUrl;
    document.getElementById('imagePopupModal').style.display = 'block';
  }

  function closeImageModal() {
    document.getElementById('imagePopupModal').style.display = 'none';
    document.getElementById('popupImage').src = "";
  }
</script>

<script>
function getAISuggestion() {
  alert("AI Suggestion not implemented yet.");
}
function explainCode() {
  alert("Explain Code not implemented yet.");
}
function runAIAction() {
  const action = document.getElementById("aiAction").value;
  alert("Run AI Action (" + action + ") not implemented yet.");
}
</script>

<script>
let editor;
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });
require(['vs/editor/editor.main'], function () {
  editor = monaco.editor.create(document.getElementById('container'), {
    value: `{{ file.content|escapejs }}`,
    language: getLanguage("{{ file.name }}"),
    theme: 'vs-dark',
    automaticLayout: true,
    readOnly: false
  });

  // Auto-save every 3s

let autoSaveInterval = setInterval(() => {
  fetch("{% url 'file_autosave' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({
      file_id: {{ file.id }},
      content: editor.getValue()
    })
  }).then(response => {
    if (!response.ok) {
      console.error("‚ùå Auto-save failed.");
    } else {
      console.log("‚úÖ Auto-saved at", new Date().toLocaleTimeString());
    }
  }).catch(err => {
    console.error("‚ùå Auto-save error:", err);
  });
}, 3000);

  // === HTML Snippet Completions ===
monaco.languages.registerCompletionItemProvider('html', {
  triggerCharacters: ['<', '"', "'", ' ', ':', '.', '{'],
  provideCompletionItems: function (model, position) {
    const textUntilPosition = model.getValueInRange({
      startLineNumber: 1,
      startColumn: 1,
      endLineNumber: position.lineNumber,
      endColumn: position.column
    });

    const cssProperties = [
      "color", "background", "background-color", "font-size", "font-weight", "font-family",
      "margin", "padding", "border", "border-radius", "width", "height", "display", "position",
      "top", "left", "right", "bottom", "z-index", "overflow", "opacity", "flex", "justify-content",
      "align-items", "gap", "grid", "box-shadow", "transition", "animation", "text-align",
      "line-height", "letter-spacing", "visibility"
    ];

    const cssColors = [
      "red", "green", "blue", "black", "white", "gray", "grey", "yellow", "orange", "pink", "purple",
      "brown", "cyan", "magenta", "lime", "teal", "navy", "gold", "silver", "maroon", "aqua",
      "chocolate", "coral", "crimson", "indigo", "khaki", "lavender", "plum", "salmon", "tan", "violet"
    ];

    const htmlTags = [
      'html', 'head', 'body', 'title', 'meta', 'link', 'style', 'script',
      'header', 'nav', 'main', 'footer', 'section', 'article', 'aside',
      'div', 'span', 'p', 'a', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
      'ul', 'ol', 'li', 'strong', 'em', 'br', 'hr', 'mark', 'abbr', 'cite',
      'form', 'input', 'textarea', 'label', 'button', 'select', 'option',
      'fieldset', 'legend', 'output', 'progress', 'meter',
      'img', 'video', 'audio', 'source', 'canvas', 'iframe',
      'details', 'summary', 'dialog', 'template',
      'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td',
      'code', 'pre', 'blockquote', 'figure', 'figcaption',
      'b', 'i', 'u', 'small', 'big', 'sub', 'sup', 'kbd', 'samp'
    ];

    const voidTags = [
      'meta', 'link', 'br', 'hr', 'img', 'input', 'source', 'area', 'base', 'col', 'embed', 'track', 'wbr'
    ];

    const jsSnippets = [
      {
        label: 'console.log',
        insertText: `console.log($1);`,
        documentation: 'Log output to the console'
      },
      {
        label: 'function',
        insertText: `function $1() {\n\t$2\n}`,
        documentation: 'Function declaration'
      },
      {
        label: 'addEventListener',
        insertText: `document.querySelector('$1').addEventListener('$2', function(e) {\n\t$3\n});`,
        documentation: 'Attach event listener'
      },
      {
        label: 'fetch',
        insertText: `fetch('$1')\n\t.then(res => res.json())\n\t.then(data => {\n\t\t$2\n});`,
        documentation: 'Fetch API example'
      }
    ];

    const tagSuggestions = htmlTags.map(tag => {
      const isVoid = voidTags.includes(tag);
      return {
        label: tag,
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: isVoid ? `<${tag} $1>` : `<${tag}>$1</${tag}>`,
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: isVoid
          ? `Insert <${tag}> tag (self-closing)`
          : `Insert <${tag}>...</${tag}>`
      };
    });

    const cssPropertySuggestions = cssProperties.map(prop => ({
      label: prop,
      kind: monaco.languages.CompletionItemKind.Property,
      insertText: `${prop}: $1;`,
      insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
      documentation: `CSS property: ${prop}`
    }));

    const cssColorSuggestions = cssColors.map(color => ({
      label: color,
      kind: monaco.languages.CompletionItemKind.Color,
      insertText: color,
      documentation: `CSS color: ${color}`
    }));

    const jsSuggestions = jsSnippets.map(snip => ({
      label: snip.label,
      kind: monaco.languages.CompletionItemKind.Snippet,
      insertText: snip.insertText,
      insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
      documentation: snip.documentation
    }));

    const insideStyle = /<style[\s\S]*?>[\s\S]*$/i.test(textUntilPosition);
    const insideScript = /<script[\s\S]*?>[\s\S]*$/i.test(textUntilPosition);
    const insideInlineStyle = /style\s*=\s*["'][^"']*$/i.test(textUntilPosition);

    if (insideStyle || insideInlineStyle) {
      return {
        suggestions: [...cssPropertySuggestions, ...cssColorSuggestions]
      };
    }

    if (insideScript) {
      return {
        suggestions: jsSuggestions
      };
    }

    return {
      suggestions: [...tagSuggestions]
    };
  }
});

  // === JavaScript Snippets ===
monaco.languages.registerCompletionItemProvider('javascript', {
  triggerCharacters: ['.', '(', ' '],
  provideCompletionItems: () => ({
    suggestions: [
      {
        label: 'for loop',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: [
          'for (let ${1:i} = 0; ${1:i} < ${2:array}.length; ${1:i}++) {',
          '\t${3:// code}',
          '}'
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'A basic for loop over an array'
      },
      {
        label: 'for...of loop',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: [
          'for (const ${1:item} of ${2:array}) {',
          '\t${3:// code}',
          '}'
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Iterates over iterable objects like arrays'
      },
      {
        label: 'if statement',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: [
          'if (${1:condition}) {',
          '\t${2:// code}',
          '}'
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Basic if condition'
      },
      {
        label: 'console.log',
        kind: monaco.languages.CompletionItemKind.Function,
        insertText: 'console.log(${1:message});',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Prints a message to the console'
      },
      {
        label: 'addEventListener',
        kind: monaco.languages.CompletionItemKind.Function,
        insertText: "document.querySelector('${1:selector}').addEventListener('${2:event}', function(e) {\n\t$3\n});",
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Attaches an event listener to an element'
      },
      {
        label: 'setTimeout',
        kind: monaco.languages.CompletionItemKind.Function,
        insertText: 'setTimeout(() => {\n\t$1\n}, ${2:1000});',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Delays execution of code'
      },
      {
        label: 'fetch',
        kind: monaco.languages.CompletionItemKind.Function,
        insertText: [
          "fetch('${1:url}')",
          "  .then(response => response.json())",
          "  .then(data => {",
          "    ${2:// process data}",
          "  })",
          "  .catch(error => console.error(error));"
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Makes a network request using fetch API'
      }
    ]
  })
});

monaco.languages.registerHoverProvider('javascript', {
  provideHover: function(model, position) {
    const word = model.getWordAtPosition(position);
    if (!word) return;

    const docs = {
      'console': {
        value: '**console.log()**\n\nOutputs messages to the browser console.\nUseful for debugging.'
      },
      'fetch': {
        value: '**fetch()**\n\nPerforms a network request and returns a Promise.\nUsed for AJAX and API calls.'
      },
      'setTimeout': {
        value: '**setTimeout()**\n\nExecutes a function after a specified delay (in milliseconds).'
      }
    };

    const doc = docs[word.word];
    if (doc) {
      return {
        contents: [{ value: doc.value }]
      };
    }

    return null;
  }
});


 // === Python Snippets ===
const staticCompletions = {
  python: {
    keywords: [
      "False", "None", "True", "and", "as", "assert", "async", "await", "break", "class",
      "continue", "def", "del", "elif", "else", "except", "finally", "for", "from", "global",
      "if", "import", "in", "is", "lambda", "match", "nonlocal", "not", "or", "pass", "raise",
      "return", "try", "while", "with", "yield", "case"
    ],
    functions: [
      "abs", "aiter", "all", "any", "anext", "ascii", "bin", "bool", "breakpoint", "bytearray", "bytes",
      "callable", "chr", "classmethod", "compile", "complex", "delattr", "dict", "dir", "divmod", "enumerate",
      "eval", "exec", "filter", "float", "format", "frozenset", "getattr", "globals", "hasattr", "hash",
      "help", "hex", "id", "input", "int", "isinstance", "issubclass", "iter", "len", "list", "locals", "map",
      "max", "memoryview", "min", "next", "object", "oct", "open", "ord", "pow", "print", "property", "range",
      "repr", "reversed", "round", "set", "setattr", "slice", "sorted", "staticmethod", "str", "sum", "super",
      "tuple", "type", "vars", "zip", "__import__"
    ],
    classes: [
      "int", "float", "str", "list", "dict", "set", "tuple", "object", "bool", "bytes", "bytearray",
      "complex", "frozenset", "memoryview"
    ],
    exceptions: [
      "ArithmeticError", "AssertionError", "AttributeError", "BaseException", "BlockingIOError", "BrokenPipeError",
      "BufferError", "BytesWarning", "ChildProcessError", "ConnectionAbortedError", "ConnectionError",
      "ConnectionRefusedError", "ConnectionResetError", "DeprecationWarning", "EOFError", "EnvironmentError",
      "Exception", "FileExistsError", "FileNotFoundError", "FloatingPointError", "FutureWarning", "GeneratorExit",
      "ImportError", "ImportWarning", "IndentationError", "IndexError", "InterruptedError", "IsADirectoryError",
      "KeyError", "KeyboardInterrupt", "LookupError", "MemoryError", "ModuleNotFoundError", "NameError",
      "NotADirectoryError", "NotImplemented", "NotImplementedError", "OSError", "OverflowError",
      "PendingDeprecationWarning", "PermissionError", "ProcessLookupError", "RecursionError", "ReferenceError",
      "ResourceWarning", "RuntimeError", "RuntimeWarning", "StopAsyncIteration", "StopIteration", "SyntaxError",
      "SyntaxWarning", "SystemError", "SystemExit", "TabError", "TimeoutError", "TypeError", "UnboundLocalError",
      "UnicodeDecodeError", "UnicodeEncodeError", "UnicodeError", "UnicodeTranslateError", "UnicodeWarning",
      "UserWarning", "ValueError", "Warning", "ZeroDivisionError"
    ],
    modules: [
      "os", "sys", "math", "random", "datetime", "time", "json", "re", "statistics", "itertools", "functools",
      "collections", "pathlib", "shutil", "subprocess", "glob", "logging", "decimal", "fractions", "pprint",
      "typing", "traceback", "urllib", "http", "argparse", "getopt", "enum", "dataclasses", "asyncio", "threading",
      "multiprocessing", "platform", "socket", "email", "copy", "inspect", "pickle", "csv", "heapq", "uuid",
      "base64", "hashlib", "html", "xml", "webbrowser", "sqlite3"
    ]
  },
    np: [
    "array", "arange", "linspace", "logspace", "zeros", "ones", "full", "eye", "identity", "diag", "empty",
    "reshape", "transpose", "flatten", "ravel", "squeeze", "expand_dims",
    "dot", "matmul", "tensordot", "inner", "outer", "cross",
    "mean", "median", "std", "var", "sum", "cumsum", "prod", "max", "min", "argmax", "argmin", "where",
    "unique", "sort", "argsort", "clip",
    "concatenate", "stack", "vstack", "hstack", "dstack", "column_stack", "split", "hsplit", "vsplit", "array_split",
    "random", "load", "save", "frombuffer", "fromfile", "fromiter", "fromfunction", "vectorize"
  ],

  pd: [
    "DataFrame", "Series", "read_csv", "read_excel", "read_json", "read_sql", "read_html", "read_parquet", "read_feather",
    "to_csv", "to_excel", "to_json", "to_sql", "to_parquet",
    "head", "tail", "sample", "shape", "columns", "index", "dtypes", "axes",
    "describe", "info", "memory_usage", "isnull", "notnull", "dropna", "fillna", "interpolate",
    "groupby", "pivot", "pivot_table", "melt", "stack", "unstack", "merge", "join", "concat", "append",
    "sort_values", "sort_index", "drop", "rename", "set_index", "reset_index",
    "loc", "iloc", "at", "iat", "ix", "astype", "apply", "map", "applymap", "transform", "agg", "duplicated", "nunique", "value_counts"
  ],

  plt: [
    "figure", "subplot", "subplots", "plot", "scatter", "bar", "barh", "hist", "pie", "boxplot", "violinplot", "stem",
    "imshow", "matshow", "contour", "contourf", "pcolor", "quiver", "streamplot",
    "xlabel", "ylabel", "title", "legend", "colorbar", "grid", "axis", "xlim", "ylim", "xticks", "yticks",
    "tight_layout", "savefig", "show", "clf", "cla", "close"
  ],

  sns: [
    "load_dataset", "scatterplot", "lineplot", "barplot", "boxplot", "histplot", "kdeplot", "violinplot", "stripplot",
    "swarmplot", "countplot", "catplot", "pairplot", "heatmap", "clustermap", "jointplot",
    "set", "set_theme", "set_style", "set_context", "color_palette", "despine"
  ],

  cv2: [
    "imread", "imwrite", "imshow", "waitKey", "destroyAllWindows",
    "cvtColor", "resize", "flip", "rotate", "GaussianBlur", "medianBlur", "threshold", "adaptiveThreshold",
    "Canny", "VideoCapture", "VideoWriter", "findContours", "drawContours", "rectangle", "circle", "line", "putText",
    "bitwise_and", "bitwise_or", "bitwise_not", "bitwise_xor", "add", "addWeighted", "subtract", "erode", "dilate",
    "morphologyEx"
  ]

};

monaco.languages.registerCompletionItemProvider('python', {
  triggerCharacters: ['.', ...'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_'],
  provideCompletionItems: async function (model, position) {
    const lineUntilCursor = model.getValueInRange({
      startLineNumber: position.lineNumber,
      startColumn: 1,
      endLineNumber: position.lineNumber,
      endColumn: position.column
    });

    // Dot notation (e.g., np.)
    const dotMatch = lineUntilCursor.match(/(\w+)\.$/);
    if (dotMatch) {
      const prefix = dotMatch[1];
      const completions = staticCompletions[prefix] || [];
      return {
        suggestions: completions.map(item => ({
          label: item,
          kind: monaco.languages.CompletionItemKind.Method,
          insertText: item,
          documentation: `${prefix}.${item}`
        }))
      };
    }

    // General Python typing (e.g., print, for, True, etc.)
    const wordMatch = lineUntilCursor.match(/(\w+)$/);
    if (wordMatch) {
      const prefix = wordMatch[1].toLowerCase();
      const python = staticCompletions.python;

      const suggestions = [
        ...python.keywords.filter(k => k.startsWith(prefix)).map(k => ({
          label: k,
          kind: monaco.languages.CompletionItemKind.Keyword,
          insertText: k,
          documentation: `Python keyword: ${k}`
        })),
        ...python.functions.filter(f => f.startsWith(prefix)).map(f => ({
          label: f,
          kind: monaco.languages.CompletionItemKind.Function,
          insertText: f,
          documentation: `Built-in function: ${f}`
        })),
        ...python.classes.filter(c => c.startsWith(prefix)).map(c => ({
          label: c,
          kind: monaco.languages.CompletionItemKind.Class,
          insertText: c,
          documentation: `Built-in class: ${c}`
        })),
        ...python.exceptions.filter(e => e.toLowerCase().startsWith(prefix)).map(e => ({
          label: e,
          kind: monaco.languages.CompletionItemKind.Class,
          insertText: e,
          documentation: `Exception: ${e}`
        })),
        ...python.modules.filter(m => m.startsWith(prefix)).map(m => ({
          label: m,
          kind: monaco.languages.CompletionItemKind.Module,
          insertText: m,
          documentation: `Python module: ${m}`
        }))
      ];

      return { suggestions };
    }

    // Optional fallback to AI suggestions
    try {
      const res = await fetch("/ai-python-completion/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
        body: JSON.stringify({ prefix: lineUntilCursor.trim() })
      });

      const data = await res.json();
      if (data.completions) {
        return {
          suggestions: data.completions.map(item => ({
            label: item,
            kind: monaco.languages.CompletionItemKind.Function,
            insertText: item,
            documentation: `AI: ${item}`
          }))
        };
      }
    } catch (err) {
      console.warn("AI fallback failed", err);
    }

    return { suggestions: [] };
  }
});


});


// === CSS Snippets ===
monaco.languages.registerCompletionItemProvider('css', {
  provideCompletionItems: () => ({
    suggestions: [
      // === Layout & Box Model ===
      {
        label: 'display: flex',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'display: flex;',
        documentation: 'Set display mode to flex'
      },
      {
        label: 'display: grid',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'display: grid;',
        documentation: 'Set display mode to grid'
      },
      {
        label: 'flex-center',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: [
          'display: flex;',
          'justify-content: center;',
          'align-items: center;'
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Center content using flex'
      },
      {
        label: 'margin',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'margin: ${1:0};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set margin'
      },
      {
        label: 'padding',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'padding: ${1:0};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set padding'
      },
      {
        label: 'box-sizing',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'box-sizing: border-box;',
        documentation: 'Include padding and border in element width and height'
      },
      {
        label: 'gap',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'gap: ${1:1rem};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Spacing between grid/flex items'
      },

      // === Dimensions ===
      {
        label: 'width',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'width: ${1:100%};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set width'
      },
      {
        label: 'height',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'height: ${1:auto};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set height'
      },

      // === Positioning ===
      {
        label: 'position',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'position: ${1:relative};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set positioning method'
      },
      {
        label: 'top',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'top: ${1:0};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set top offset'
      },
      {
        label: 'left',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'left: ${1:0};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set left offset'
      },

      // === Typography ===
      {
        label: 'font-size',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'font-size: ${1:16px};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set font size'
      },
      {
        label: 'font-weight',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'font-weight: ${1:bold};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set font weight'
      },
      {
        label: 'line-height',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'line-height: ${1:1.5};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Set line height'
      },

      // === Colors ===
      {
        label: 'color',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'color: ${1:#000};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Text color'
      },
      {
        label: 'background-color',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'background-color: ${1:#fff};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Background color'
      },
      {
        label: 'primary-color',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'color: ${1:#3498db};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Primary brand color'
      },
      {
        label: 'named-color',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'color: ${1:red};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Use named color like red, blue, green, etc.'
      },

      // === Effects ===
      {
        label: 'transition',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'transition: ${1:all} ${2:0.3s} ease-in-out;',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Smooth transition'
      },
      {
        label: 'box-shadow',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'box-shadow: ${1:0 2px 4px rgba(0,0,0,0.1)};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Shadow effect'
      },
      {
        label: 'border-radius',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'border-radius: ${1:4px};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Rounded corners'
      },

      // === Animation ===
      {
        label: '@keyframes',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: [
          '@keyframes ${1:fadeIn} {',
          '  0% { opacity: 0; }',
          '  100% { opacity: 1; }',
          '}'
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Define keyframes'
      },
      {
        label: 'animation',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: 'animation: ${1:fadeIn} ${2:1s} ${3:ease-in-out};',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Apply animation'
      },

      // === Media Query ===
      {
        label: '@media',
        kind: monaco.languages.CompletionItemKind.Snippet,
        insertText: [
          '@media (max-width: ${1:768px}) {',
          '\t${2:selector} {',
          '\t\t${3:property}: ${4:value};',
          '\t}',
          '}'
        ].join('\n'),
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        documentation: 'Media query block'
      },

      // === Utility Reminder (Tailwind etc.) ===
      {
        label: 'tw-bg-blue-500',
        kind: monaco.languages.CompletionItemKind.Text,
        insertText: 'bg-blue-500',
        documentation: 'Tailwind class (remember: this is not native CSS)'
      }
    ]
  })
});



function getLanguage(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  switch (ext) {
    case "py": return "python";
    case "js": return "javascript";
    case "html": return "html";
    case "css": return "css";
    case "json": return "json";
    default: return "plaintext";
  }
}

function runCode() {
    const code = editor.getValue();
    const output = document.getElementById("outputText");
    const tablePreview = document.getElementById("tablePreview");
    const plotPreview = document.getElementById("plotPreview");

    // Show spinner
    output.innerHTML = `‚è≥ Running... <span class="spinner"></span>`;
    tablePreview.innerHTML = "";
    plotPreview.innerHTML = "";

    fetch("{% url 'file_detail' file.project.id file.id %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ 
            content: code,
            run_plot: true,
            run_table: true
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "error") {
            output.innerHTML = `<span style="color:red;">‚ùå ${escapeHTML(data.message)}</span>`;
        } else {
            // Text output
            output.textContent = data.output || "[No output]";

            // Table preview (first 20 rows of CSV or resulting DataFrame)
            if (data.table) {
                tablePreview.innerHTML = data.table;
                tablePreview.style.display = "block";
            } else {
                tablePreview.style.display = "none";
            }

            // Plot preview
            plotPreview.innerHTML = "";
            if (Array.isArray(data.images) && data.images.length > 0) {
                data.images.forEach(src => {
                    const img = document.createElement("img");
                    img.src = src;
                    img.style.maxWidth = "100%";
                    img.style.marginBottom = "10px";
                    plotPreview.appendChild(img);
                });
                plotPreview.style.display = "block";
            } else {
                plotPreview.style.display = "none";
            }
        }
    })
    .catch(err => {
        output.innerHTML = `<span style="color:red;">‚ùå Request Failed: ${escapeHTML(err.message)}</span>`;
    });
}

function escapeHTML(str) {
  return String(str).replace(/[&<>"']/g, tag => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[tag]));
}

</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggles = document.querySelectorAll('.folder-toggle');

  toggles.forEach(toggle => {
    const ext = toggle.dataset.ext;
    const storedState = localStorage.getItem('folder_' + ext);

    if (storedState === 'open') {
      toggle.classList.add('open');
      toggle.nextElementSibling.style.display = 'block';
    }

    toggle.addEventListener('click', () => {
      const group = toggle.nextElementSibling;
      const isOpen = toggle.classList.toggle('open');
      group.style.display = isOpen ? 'block' : 'none';
      localStorage.setItem('folder_' + ext, isOpen ? 'open' : 'closed');
    });
  });
});

function getSelectedText() {
  return editor.getModel().getValueInRange(editor.getSelection());
}

function insertAfterSelection(original, insertion) {
  const range = editor.getSelection();
  editor.executeEdits(null, [{
    range: range,
    text: original + "\n\n" + insertion,
    forceMoveMarkers: true
  }]);
}

function cleanAIResponse(text) {
  if (text.includes("```")) {
    const parts = text.split("```");
    if (parts.length >= 2) {
      return parts[1].replace(/^(\w+\n)?/, "").trim();
    }
  }
  return text.trim();
}

function getAISuggestion() {
  const selectedText = getSelectedText();
  const btn = document.getElementById("aiBtn");
  const loader = document.getElementById("aiLoading");

  if (!selectedText.trim()) return alert("‚ö†Ô∏è Please select some code first.");

  btn.disabled = true;
  loader.style.display = "inline";

  fetch("{% url 'ai_suggest_code' %}", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ prompt: selectedText })
  })
  .then(res => res.json())
  .then(data => {
    const suggestion = cleanAIResponse(data.suggestion || "");
    insertAfterSelection(selectedText, suggestion);
  })
  .catch(err => alert("AI Suggestion Failed: " + err))
  .finally(() => {
    btn.disabled = false;
    loader.style.display = "none";
  });
}
function showToast(message) {
  const toast = document.getElementById("toastMessage");
  toast.innerHTML = `
    <span>${message}</span>
    <button onclick="hideToast()" style="
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      position: absolute;
      right: 12px;
      top: 8px;
      cursor: pointer;
    ">&times;</button>
  `;
  toast.style.display = "block";
  toast.style.opacity = "1";
}

function hideToast() {
  const toast = document.getElementById("toastMessage");
  toast.style.opacity = "0";
  setTimeout(() => (toast.style.display = "none"), 500);
}

function explainCode() {
  const code = getSelectedText();
  const btn = document.getElementById("explainBtn");

  if (!code.trim()) {
    showToast("‚ö†Ô∏è Please select code to explain.");
    return;
  }

  btn.disabled = true;
  btn.textContent = "üí¨ Explaining...";

  fetch("{% url 'explain_code' %}", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ code: code })
  })
  .then(res => res.json())
  .then(data => {
    showToast("üìò AI Explanation:\n" + data.explanation);
  })
  .catch(err => {
    showToast("‚ö†Ô∏è AI Explanation Error: " + err.message);
  })
  .finally(() => {
    btn.disabled = false;
    btn.textContent = "üí¨ Explain Code";
  });
}


function runAIAction() {
  const selectedText = getSelectedText();
  const action = document.getElementById("aiAction").value;
  const loadingIndicator = document.getElementById("aiLoading");
  const runBtn = document.getElementById("runBtn");

  if (!selectedText.trim()) {
    return alert("‚ö†Ô∏è Please select code first.");
  }

  const instructions = {
    complete: "Complete the following code:",
    explain: "Explain what this code does:",
    optimize: "Optimize this code for performance or readability:",
    comment: "Add detailed comments to the following code:",
    fix: "Fix any bugs or issues in this code:"
  };

  const prompt = instructions[action] + "\n\n" + selectedText;

  // Show loading
  loadingIndicator.style.display = "inline";
  runBtn.disabled = true;
  runBtn.textContent = "‚è≥ Running...";

  fetch("{% url 'ai_suggest_code' %}", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ prompt: prompt })
  })
  .then(res => res.json())
  .then(data => {
    const output = cleanAIResponse(data.suggestion || "");
    insertAfterSelection(selectedText, output);
  })
  .catch(err => {
    alert("AI Action Failed: " + err);
  })
  .finally(() => {
    // Hide loading
    loadingIndicator.style.display = "none";
    runBtn.disabled = false;
    runBtn.textContent = "üöÄ Run AI Action";
  });
}


function createNewFolder() {
  const name = document.getElementById("newFolderName").value.trim();
  const projectId = {{ file.project.id }};

  if (!name) return alert("‚ö†Ô∏è Please enter a folder name");

  fetch(`/webprojects/${projectId}/create-folder/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      alert("‚úÖ Folder created!");
      location.reload(); // refresh to show the new folder
    } else {
      alert("‚ùå " + data.message);
    }
  })
  .catch(err => alert("‚ùå Request failed: " + err));
}

function createNewFile() {
  const name = document.getElementById("newFileName").value.trim();
  const projectId = {{ file.project.id }};

  if (!name) return alert("‚ö†Ô∏è Please enter a file name");

  fetch(`/webprojects/${projectId}/create-file/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      alert("‚úÖ File created!");
      window.location.href = `/webprojects/${projectId}/file/${data.file_id}/`;
    } else {
      alert("‚ùå " + data.message);
    }
  })
  .catch(err => alert("‚ùå Request failed: " + err));
}

</script>

<!-- uppload file js  -->
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '#333';
});

dropZone.addEventListener('dragleave', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '';
});

dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '';
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
});

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (file) uploadFile(file);
});

function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('name', file.name);

  const loader = document.getElementById("upload-loader");
  loader.style.display = "flex"; // show loader

  fetch("{% url 'upload_file_ajax' project.id %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showToast(`‚úÖ Uploaded: ${file.name}`);
      addFileToList(data.file_id, file.name, data.file_url || "");

      // ‚úÖ reload after 1.5 seconds
      setTimeout(() => {
        location.reload();
      }, 1500);
    } else {
      showToast(`‚ùå Upload failed: ${data.error || ''}`);
    }
  })
  .catch(() => showToast("‚ö†Ô∏è Upload error"))
  .finally(() => {
    loader.style.display = "none"; // hide loader
  });
}

// working
// function uploadFile(file) {
//   const formData = new FormData();
//   formData.append('file', file);
//   formData.append('name', file.name);

//   const loader = document.getElementById("upload-loader");
//   loader.style.display = "flex"; // show loader

//   fetch("{% url 'upload_file_ajax' project.id %}", {
//     method: 'POST',
//     headers: { 'X-CSRFToken': '{{ csrf_token }}' },
//     body: formData
//   })
//   .then(res => res.json())
//   .then(data => {
//     if (data.success) {
//       showToast(`‚úÖ Uploaded: ${file.name}`);
//       addFileToList(data.file_id, file.name, data.file_url || "");
      
//     } else {
//       showToast(`‚ùå Upload failed: ${data.error || ''}`);
//     }
//   })
//   .catch(() => showToast("‚ö†Ô∏è Upload error"))
//   .finally(() => {
//     loader.style.display = "none"; // hide loader
//   });
// }

// function uploadFile(file) {
//   const formData = new FormData();
//   formData.append('file', file);  // ‚úÖ universal field
//   formData.append('name', file.name);

//   fetch("{% url 'upload_file_ajax' project.id %}", {
//     method: 'POST',
//     headers: { 'X-CSRFToken': '{{ csrf_token }}' },
//     body: formData
//   })
//   .then(res => res.json())
//   .then(data => {
//     if (data.success) {
//       showToast(`‚úÖ Uploaded: ${file.name}`);
//       addFileToList(data.file_id, file.name, data.file_url || "");
//     } else {
//       showToast(`‚ùå Upload failed: ${data.error || ''}`);
//     }
//   })
//   .catch(() => showToast("‚ö†Ô∏è Upload error"));
// }

function addFileToList(fileId, fileName, fileUrl) {
  const ext = fileName.split('.').pop().toLowerCase();
  const groups = document.querySelectorAll('.file-group');

  groups.forEach(group => {
    if (group.previousElementSibling.dataset.ext === ext) {
      const div = document.createElement('div');
      div.classList.add('file-item');

      if (["png", "jpg", "jpeg", "gif", "svg", "webp"].includes(ext)) {
        div.innerHTML = `<a href="javascript:void(0);" onclick="showImageModal('${fileUrl}')" style="color:#4fa;">üñºÔ∏è ${fileName}</a>`;
      } 
      else if (["xls", "xlsx", "csv"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#f1c40f;">üìä ${fileName}</a>`;
      } 
      else if (["pdf"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#e74c3c;">üìÑ ${fileName}</a>`;
      } 
      else if (["doc", "docx"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#3498db;">üìë ${fileName}</a>`;
      } 
      else if (["txt", "md"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#9b59b6;">üìù ${fileName}</a>`;
      } 
      else {
        div.innerHTML = `<a href="/file/${fileId}/" style="color:#fff;">üì¶ ${fileName}</a>`;
      }

      group.appendChild(div);
    }
  });
}

function showToast(message) {
  const toast = document.getElementById("toastMessage");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 2500);
}
</script>


<!-- dragging output area js -->
 <script>
  const container = document.getElementById("container");
  const outputPanel = document.getElementById("outputPanel");
  const resizeHandle = document.getElementById("resizeHandle");

  let isDragging = false;
  let startY = 0;
  let startHeight = 0;

  resizeHandle.addEventListener("mousedown", (e) => {
    isDragging = true;
    startY = e.clientY;
    startHeight = outputPanel.offsetHeight;
    document.body.style.userSelect = "none"; // Prevent text selection
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    const dy = e.clientY - startY;
    const newHeight = Math.max(startHeight - dy, 100); // Minimum height
    outputPanel.style.height = `${newHeight}px`;
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
    document.body.style.userSelect = "";
  });

  // Touch support for mobile
  resizeHandle.addEventListener("touchstart", (e) => {
    isDragging = true;
    startY = e.touches[0].clientY;
    startHeight = outputPanel.offsetHeight;
  });

  document.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    const dy = e.touches[0].clientY - startY;
    const newHeight = Math.max(startHeight - dy, 100);
    outputPanel.style.height = `${newHeight}px`;
  });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });
</script>


{% endblock %}