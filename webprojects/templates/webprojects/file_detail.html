{% extends "webprojects/base_editor.html" %}
{% load file_filters %}

{% block title %}{{ file.name }} | {{ file.project.name }}  {% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    font-family: 'Segoe UI', sans-serif;
    background-color: #1e1e1e;
    color: #ccc;
  }

  .editor-layout {
    display: flex;
    height: calc(100vh - 48px);
    transition: all 0.3s ease;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    background: #1e1e1e;
    border-bottom: 1px solid #444;
    justify-content: flex-start;
  }

  .toolbar button,
  .toolbar select {
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    font-size: 0.95em;
    background: #333;
    color: #eee;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .toolbar button:hover,
  .toolbar select:hover {
    background: #444;
  }

  .sidebar {
    width: 450px;
    background-color: #252526;
    padding: 10px;
    border-right: 1px solid #444;
    overflow-y: auto;
    transition: all 0.3s ease;
  }

  .folder-toggle {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    color: #ccc;
    margin: 10px 0 5px;
    transition: color 0.3s ease;
  }

  .folder-toggle:hover {
    color: #fff;
  }

  .file-group {
    margin-left: 10px;
    display: none;
    transition: all 0.3s ease;
  }

  .folder-toggle.open + .file-group {
    display: block;
  }

  .file-item {
    margin: 4px 0;
  }

  .file-item a {
    color: #bbb;
    text-decoration: none;
    font-size: 0.9em;
    display: block;
    padding: 2px 0;
    transition: color 0.2s ease;
  }

  .file-item a:hover {
    color: #fff;
  }

  .editor-panel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #container {
    flex-grow: 1;
    border-top: 1px solid #444;
    border-bottom: 1px solid #444;
    min-height: 100px;
  }

  #outputPanel {
    height: 0px;
    background: #1e1e1e;
    color: #dcdcdc;
    padding: 0px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
    border-top: 1px solid #444;
  }

  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
  }

  ::-webkit-scrollbar-track {
    background: #2c2c2c;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .editor-layout {
      flex-direction: column;
    }

    /* .sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #444;
      max-height: 200px;
      overflow-y: auto;
    } */

    .toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .editor-panel {
      height: auto;
    }

    #outputPanel {
      height: 140px;
    }
  }

  @media (max-width: 480px) {
    .toolbar button,
    .toolbar select {
      width: 100%;
      font-size: 0.9em;
    }

    .folder-toggle {
      font-size: 0.9em;
    }

    .file-item a {
      font-size: 0.85em;
    }
  }

  /* Spinner animation */
  .spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 3px solid #ccc;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    vertical-align: middle;
    margin-left: 8px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Sidebar collapse toggle for mobile */
  .editor-layout.collapsed .sidebar {
    display: none;
  }

  .editor-layout.collapsed .editor-panel {
    width: 100% !important;
  }
#toastMessage {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 80%;
  max-width: 600px;
  background: #333;
  color: #fff;
  padding: 12px 16px;
  font-size: 0.95em;
  display: none;
  opacity: 0;
  z-index: 9999;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: opacity 0.3s ease;
}

</style>
<style>
/* Folder toggle header */
.folder-toggle {
    background-color: #2b2b2b;
    color: #fff;
    padding: 10px 15px;
    margin-top: 10px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    transition: background 0.3s;
}

.folder-toggle:hover {
    background-color: #444;
}

/* File group container */
.file-group {
    padding-left: 20px;
    margin-bottom: 10px;
    display: none; /* Hidden by default, toggle with JS */
}

/* Individual file item */
.file-item {
    padding: 6px 10px;
    margin-bottom: 4px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #f5f5f5;
    transition: background 0.3s;
}

.file-item a {
    text-decoration: none;
    color: #333;
    flex-grow: 1;
}

.file-item a:hover {
    text-decoration: underline;
    color: #007bff;
}

/* Buttons */
.btn {
    padding: 2px 6px;
    font-size: 0.8rem;
    border-radius: 4px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
}

.btn-sm {
    font-size: 0.75rem;
    padding: 2px 5px;
}

.btn-primary {
    background-color: #007bff;
    color: #fff;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-danger {
    background-color: #dc3545;
    color: #fff;
}

.btn-danger:hover {
    background-color: #b02a37;
}

/* Highlight selected file */
.file-item a[style*="font-weight:bold"] {
    background-color: #007bff;
    color: #fff !important;
    padding: 4px 8px;
    border-radius: 4px;
}

/* Image file color */
.file-item a[onclick*="showImageModal"] {
    color: #4fa;
    font-weight: bold;
}

/* side contents */
/* .topic-item {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    padding: 8px 12px;
    background-color: #fafafa;
    transition: background-color 0.2s ease;
    font-size: 0.95rem;
  }

  .topic-item:hover {
    background-color: #f0f8ff;
  } */

  .topic-toggle {
    font-weight: 600;
    color: #fefbfb;
    text-decoration: none;
    cursor: pointer;
  }

  .toggle-icon {
    transition: transform 0.3s ease;
    font-weight: bold;
  }

  .topic-desc {
    overflow: auto;
    background-color: #1e1e1e;
    color: #d4d4d4;
    margin-top: 6px;
    padding: 8px;
    border-radius: 6px;
    max-height: 300px;
    font-size: 0.9rem;
  }
  .resize-handle {
  position: absolute;
  right: 0;
  top: 0;
  bottom: 0;
  width: 5px;
  cursor: col-resize;
  background: transparent;
  z-index: 10;
  transition: background 0.2s;
}

.resize-handle:hover {
  background: #4fa !important;
}

.resize-handle::after {
  content: '';
  position: absolute;
  right: -2px;
  top: 50%;
  transform: translateY(-50%);
  width: 1px;
  height: 40px;
  background: rgba(255,255,255,0.1);
}
</style>

<!-- roller -->
 <style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>

{% endblock %}

{% block header %}
<style>
  .navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 12px 16px;
    background: #1a1a1a;
    position: relative;
  }

  .nav-links {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .nav-links a,
  .nav-links button {
    color: white;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    font-size: 14px;
  }

  .nav-links a:hover,
  .nav-links button:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .project-info {
    margin: 0;
    color: white;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
  }

  .hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
    padding: 8px;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    z-index: 1001;
  }

  .hamburger span {
    width: 24px;
    height: 2px;
    background: white;
    transition: all 0.3s;
  }

  .hamburger.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  .hamburger.active span:nth-child(2) {
    opacity: 0;
  }

  .hamburger.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -6px);
  }

  @media (max-width: 768px) {
    .hamburger {
      display: flex;
    }

    .nav-links {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 280px;
      max-width: 80vw;
      background: #2d3748;
      flex-direction: column;
      align-items: stretch;
      padding: 80px 20px 20px;
      gap: 12px;
      transition: right 0.3s ease;
      z-index: 1000;
      box-shadow: -4px 0 10px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    }

    .nav-links.active {
      right: 0;
    }

    .nav-links a,
    .nav-links button {
      width: 100%;
      justify-content: flex-start;
      font-size: 16px;
      padding: 12px 16px;
    }

    .project-info {
      font-size: 12px;
      max-width: calc(100% - 60px);
      flex-wrap: wrap;
    }

    /* Overlay backdrop */
    .nav-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .nav-overlay.active {
      display: block;
      opacity: 1;
    }
  }
  .btn-run {
    background: #2ecc71 !important;
    border-color: #27ae60 !important;
  }

  .btn-run:hover {
    background: #27ae60 !important;
  }

</style>

<div class="navbar">
  <p class="project-info">
    <span>üìÅ</span>
    <strong>{{ file.project.name }}</strong>
    <span>‚Äî</span>
    <span>üìù {{ file.name }}</span>
  </p>

  <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <div class="nav-links" id="navLinks">
    <a href="{% url 'webprojects:create_project' %}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Create Project
    </a>
    
    <a href="{% url 'student:take-exam' %}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 11l3 3L22 4"/>
        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
      </svg>
      Take Exam
    </a>
    

    <button id="toggleAI" onclick="toggleAITools()" class="btn-ai-tools">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
      </svg>
      Show AI Tools
    </button>

    <button id="toggleAI" onclick="toggleAITools()" class="btn-ai-tools">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
      </svg>
    <a class="btn btn-primary" href="{% url 'account_logout' %}">Logout</a>
    </button>

   <button  id="runBtnCode" onclick="runCode()" class="btn-run">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 5v14l11-7z"/>
      </svg>
      Run Code
    </button>

    <button onclick="toggleTheme()" id="themeToggleBtn">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="5"/>
    <line x1="12" y1="1" x2="12" y2="3"/>
    <line x1="12" y1="21" x2="12" y2="23"/>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
    <line x1="1" y1="12" x2="3" y2="12"/>
    <line x1="21" y1="12" x2="23" y2="12"/>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
  </svg>
  <span id="themeToggleText">Light Mode</span>
</button>
    
</div>

  </div>

  <div class="nav-overlay" id="navOverlay"></div>
</div>

<script>
  const hamburger = document.getElementById('hamburgerBtn');
  const navLinks = document.getElementById('navLinks');
  const navOverlay = document.getElementById('navOverlay');

  function toggleMenu() {
    hamburger.classList.toggle('active');
    navLinks.classList.toggle('active');
    navOverlay.classList.toggle('active');
    document.body.style.overflow = navLinks.classList.contains('active') ? 'hidden' : '';
  }

  hamburger.addEventListener('click', toggleMenu);

  // Close menu when clicking overlay
  navOverlay.addEventListener('click', toggleMenu);

  // Close menu when clicking a link
  navLinks.querySelectorAll('a, button').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        toggleMenu();
      }
    });
  });

  // Close menu when window is resized to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768 && navLinks.classList.contains('active')) {
      toggleMenu();
    }
  });
</script>


{% endblock %}


{% block sidebar %}

<div id="dropZone" style="border: 2px dashed #555; padding: 10px; text-align: center; color: #aaa;">
  Drop File Here or 
  <label for="fileInput" style="color: #4fa; cursor:pointer;">Browse</label>
  <input type="file" id="fileInput" 
         accept=".png,.jpg,.jpeg,.gif,.xls,.xlsx,.csv" 
         style="display:none;">
</div>
<small style="color: #888;">Images and Excel files will be added to your files</small>

<!-- Global Upload Spinner -->
<!-- üîÑ Upload Loader -->
<div id="upload-loader" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  z-index:9999;
  justify-content:center;
  align-items:center;
">
  <div style="
    width:50px; height:50px;
    border:5px solid #f3f3f3;
    border-top:5px solid #3498db;
    border-radius:50%;
    animation: spin 1s linear infinite;
  "></div>
</div>


<div style="margin-bottom: 20px;">
  <input type="text" id="newFileName" placeholder="üìù New file name (e.g., app1.py,index.html)" style="width: 100%; padding: 5px; margin-bottom: 5px; font-size: 0.9em;">
  <button onclick="createNewFile()" style="width: 100%; background: #3498db; color: white; padding: 6px 10px; border: none; border-radius: 4px;">‚ûï Create File</button>
</div>

<hr>

<h2 class="mb-3">Modules</h2>
<div class="topics-container">
  {% for topic in topics %}
<div style = "background-color: white" class="topic-item">
      <!-- Topic title with toggle icon -->
<a href="javascript:void(0);" class="topic-toggle d-flex justify-content-between align-items-center"
         onclick="toggleDesc('topic-{{ topic.id }}', this, '{{ topic.language|default:"python" }}')">
<span class="d-flex align-items-center gap-2">
  <strong  class="fs-6 text-secondary">{{ forloop.counter }}. {{ topic.title }}</strong>
</span> 

  <span class="toggle-icon">‚ûï</span>
  </a>

      <!-- Topic description hidden by default -->
      <pre  id="topic-{{ topic.id }}" 
     class="topic-desc language-{{ topic.language|default:'python' }}" 
     style="display:none;margin:0;padding:0;">
<code class="language-{{ topic.language|default:'python' }}" style="user-select: none;">
{{ topic.desc|safe }}
</code>
</pre>

    </div>
  {% empty %}
    <p class="text-muted">No content found for this course.</p>
  {% endfor %}
</div>


<!-- ===== Style ===== -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>

<!-- ===== Script ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-html.min.js"></script>


{% for ext in exts %}
  {% with files|dictsort:"name" as sorted_files %}
    <div class="folder-toggle" data-ext="{{ ext }}">
      üìÅ {{ ext|upper }} Files <span>‚Æü</span>
    </div>
    <div class="file-group">
      {% for f in sorted_files %}
        {% if f.name|has_ext:ext %}
          {% with f.name|lower as fname %}
            <div class="file-item">

              {% if fname|slice:"-4:" == ".png" or fname|slice:"-4:" == ".jpg" or fname|slice:"-5:" == ".jpeg" or fname|slice:"-4:" == ".gif" %}
                <!-- üëá Image File: Open Modal -->
                <a href="javascript:void(0);" onclick="showImageModal('{{ f.image.url }}')" style="color:#4fa;">üñºÔ∏è {{ f.name }}</a>

              {% else %}
                <!-- üëá Normal File: Go to Editor -->
                <!-- <a class="ajax-link" href="{% url 'webprojects:file_detail' f.project.id f.id %}" {% if f.id == file.id %}style="font-weight:bold;color:#fff;"{% endif %}>üìù {{ f.name }}</a> -->
                 <!-- NEW WAY (AJAX - no reload): -->
  <a href="javascript:void(0);" 
     onclick="loadFile({{ f.project.id }}, {{ f.id }}, '{{ f.name|escapejs }}')"
     class="file-link"
     data-file-id="{{ f.id }}"
     {% if f.id == file.id %}style="font-weight:bold;color:#3498db;"{% endif %}>
    üìù {{ f.name }}
  </a>

                {% if ".html" in f.name|lower %}
                  <a href="{% url 'webprojects:share_preview' f.project.id f.id %}" target="_blank" style="color: green;">publish</a>
                {% endif %}

                {% if f.is_excel %}
                  <!-- üëá Excel/CSV Preview Button -->
                  <a href="{% url 'webprojects:file_preview' f.project.id f.id %}" class="btn btn-sm ">View</a>
                {% endif %}

              {% endif %}

              <!-- üëá Delete Button for all files -->
              <form method="POST" action="{% url 'webprojects:file_delete' f.project.id f.id %}" class="delete-file-form d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
              </form>

            </div>
          {% endwith %}
        {% endif %}
      {% endfor %}
    </div>
  {% endwith %}
{% endfor %}
<style>
.file-link {
  transition: all 0.2s ease;
  position: relative;
}

.file-link:hover {
  color: #3498db !important;
  padding-left: 5px;
}

.file-link.loading::after {
  content: "‚è≥";
  position: absolute;
  right: 0px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<!-- üñºÔ∏è Image Popup Modal -->
<div id="imagePopupModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000;">
  <span onclick="closeImageModal()" style="position:absolute; top:20px; right:30px; font-size:32px; color:white; cursor:pointer;">&times;</span>
  <div style="display:flex; align-items:center; justify-content:center; height:100%;">
    <img id="popupImage" src="" alt="Preview" style="max-width:90%; max-height:90%; border: 2px solid #555; border-radius: 8px;" />
  </div>
</div>

{% endblock %}


{% block content %}

<div style="display: none;" class="preview-section"> 
  <h4>Preview</h4>
  <iframe id="preview" style="width:100%; height:400px; border:1px solid #ccc;"></iframe>
</div>

<!-- end -->


<div id="aiToolbar" class="toolbar">
  
  <span id="aiLoading" style="display:none;">‚è≥</span>
  <!-- <button id="aiBtn" onclick="getAISuggestion()">üí° AI Suggest</button> -->
<button onclick="getRelevantExamples()" id="examplesBtn" style="background: #3498db; color: white;">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="3" width="7" height="7"></rect>
    <rect x="14" y="3" width="7" height="7"></rect>
    <rect x="14" y="14" width="7" height="7"></rect>
    <rect x="3" y="14" width="7" height="7"></rect>
  </svg>
  Show Examples üìö
</button>
  <button id="toggleAIBtn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="9" cy="10" r="1" fill="currentColor"/>
        <circle cx="15" cy="10" r="1" fill="currentColor"/>
        <path d="M8 15s1.5 2 4 2 4-2 4-2"/>
      </svg>
      AI Assistant
    </button>
  <select id="aiAction">
    <!-- <option value="complete">üîß Complete</option> -->
    <option value="explain">üí¨ Explain</option>
    <option value="optimize">‚ö° Optimize</option>
    <option value="comment">üìù Add Comments</option>
    <option value="fix">üêû Fix Bugs</option>
  </select>
  <button id="runBtn" onclick="runAIAction()">üöÄ Run AI Action</button>
</div>


<!-- delete js  -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteForms = document.querySelectorAll('.delete-file-form');

    deleteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();  // prevent normal form submission

            if (!confirm("Are you sure you want to delete this file?")) return;

            const url = form.getAttribute('action');
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove file item from DOM
                    form.closest('.file-item').remove();
                } else {
                    alert(data.message || 'Failed to delete file.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting file.');
            });
        });
    });
});
</script>




<script>
  function toggleAITools() {
    const aiToolbar = document.getElementById("aiToolbar");
    const toggleBtn = document.getElementById("toggleAI");

    if (aiToolbar.style.display === "none" || aiToolbar.style.display === "") {
      aiToolbar.style.display = "flex";
      toggleBtn.textContent = "‚ùå Hide AI Tools";
    } else {
      aiToolbar.style.display = "none";
      toggleBtn.textContent = "üîß Show AI Tools";
    }
  }

  // Auto-hide toolbar on small screens
  document.addEventListener("DOMContentLoaded", function () {
    if (window.innerWidth <= 768) {
      document.getElementById("aiToolbar").style.display = "none";
    }
  });
</script>
 
<div class="editor-panel" style="display: flex; flex-direction: column; height: 10%;">
  <!-- Code Editor -->
  <div id="container" style="flex-grow: 1; min-height: 10px;"></div>

  <!-- Resize handle for code editor -->
  <div id="resizeHandle" style="height: 6px; cursor: row-resize; background: #444;"></div>
</div>

 <div id="aiopenclose" style="display:none;">
<!-- Floating AI Panel -->
<div id="floatingAI" style="
  position: fixed;
  top: 100px;
  right: 30px;
  width: 400px;
  height: 300px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  z-index: 9999;
">

  <!-- Drag handle -->

  <div id="dragHandle" style="cursor: grab; padding: 8px; background: #f1f1f1; border-bottom: 1px solid #ccc;">üñêÔ∏è Drag Me</div>

  <!-- Tab Headers -->
  <div style="display:flex; border-bottom:2px solid #eee; background:#f9f9f9;">
    <button 
      id="appBuilderTab" 
      class="ai-tab" 
      style="flex:1; padding:12px 20px; border:none; background:none; cursor:pointer; border-bottom:3px solid #007bff; font-weight:bold; font-size:15px; color:#007bff; transition:all 0.2s;"
    >
      üèóÔ∏è Build Project
    </button>
    <button 
      id="fileEditorTab" 
      class="ai-tab" 
      style="flex:1; padding:12px 20px; border:none; background:none; cursor:pointer; border-bottom:3px solid transparent; font-size:15px; color:#666; transition:all 0.2s;"
    >
      üìù Edit Current File
    </button>
  </div>

  <!-- App Builder Panel -->
  <div id="appBuilderPanel" style="padding:10px; flex:1; display:flex; flex-direction:column;">
    <div style="display:flex; gap:10px; margin-bottom:6px;">
      <input
        type="text"
        id="aiPrompt"
        placeholder="Ask AI to generate a project (e.g., 'Create a bouncing ball game')"
        style="flex:1; padding:10px 12px; font-size:15px; border:1px solid #ccc; border-radius:4px;"
      />
      <button
        id="runAIPrompt"
        style="padding:10px 18px; background:#007bff; color:#fff; font-size:15px; border:none; border-radius:6px; cursor:pointer; transition:background 0.2s, transform 0.1s; white-space:nowrap;"
        onmouseover="this.style.background='#0056b3'"
        onmouseout="this.style.background='#007bff'"
        onmousedown="this.style.transform='scale(0.96)'"
        onmouseup="this.style.transform='scale(1)'"
      >
        Run AI
      </button>
    </div>
    <pre id="appBuilderOutput" 
     style="background:#f5f5f5; padding:10px; border-radius:4px; margin-top:10px; height:200px; overflow-y:auto; white-space:pre-wrap; display:none;">
</pre>

  </div>

  <!-- File Editor Panel -->
  <div id="fileEditorPanel" style="padding:10px; flex:1; display:none; flex-direction:column;">
    <div style="display:flex; gap:10px; margin-bottom:6px;">
      <input 
        id="fileChatPrompt" 
        placeholder="Describe changes to apply to current file..." 
        style="flex:1; padding:10px 12px; font-size:15px; border:1px solid #ccc; border-radius:4px;"
      />
      <button 
        id="applyBtn" 
        style="padding:10px 18px; background:#28a745; color:white; font-size:15px; border:none; border-radius:6px; cursor:pointer; transition:background 0.2s, transform 0.1s; white-space:nowrap;"
        onmouseover="this.style.background='#218838'"
        onmouseout="this.style.background='#28a745'"
        onmousedown="this.style.transform='scale(0.96)'"
        onmouseup="this.style.transform='scale(1)'"
      >
        Apply Changes
      </button>
    </div>
    <pre id="fileChatOutput" style="background:#f5f5f5; flex:1; overflow-y:auto; padding:10px; border-radius:4px; white-space:pre-wrap;"></pre>
  </div>

  <!-- Resize handle for floating AI panel -->
  <div id="resizeHandleAI" style="height:6px; cursor: row-resize; background:#ccc;"></div>
</div>
</div>

<!-- Examples Panel (Semi-Transparent, Draggable) -->
<div id="examplesPanel" style="
  display: none;
  position: fixed;
  top: 80px;
  right: 30px;
  width: 420px;
  max-height: 550px;
  background: rgba(52, 152, 219, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  border: 1px solid rgba(255,255,255,0.2);
  overflow: hidden;
  z-index: 9999;
  animation: slideIn 0.3s ease;
">
  <!-- Draggable Header -->
  <div id="examplesDragHandle" style="
    padding: 12px 15px;
    background: rgba(0,0,0,0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    cursor: move;
    user-select: none;
  ">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 20px;">üìö</span>
      <strong style="color: white; font-size: 14px;">Examples</strong>
      <span style="font-size: 10px; opacity: 0.6; color: white;">(drag)</span>
    </div>
    
    <!-- Opacity Control -->
    <div style="display: flex; align-items: center; gap: 10px;">
      <label style="font-size: 11px; color: white; opacity: 0.8;">Opacity:</label>
      <input 
        type="range" 
        id="opacitySlider" 
        min="50" 
        max="100" 
        value="95" 
        style="width: 80px; cursor: pointer;"
        oninput="adjustPanelOpacity(this.value)"
      />
      <button onclick="closeExamplesPanel()" style="
        background: transparent;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
        margin-left: 5px;
      " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
    </div>
  </div>
  
  <!-- Content -->
  <div id="examplesContent" style="
    padding: 15px;
    color: white;
    max-height: 450px;
    overflow-y: auto;
    font-size: 13px;
    line-height: 1.5;
  ">
    <!-- Examples will be inserted here -->
  </div>
  
  <!-- Resize Handle -->
  <div id="examplesResizeHandle" style="
    position: absolute;
    bottom: 0;
    right: 0;
    width: 15px;
    height: 15px;
    cursor: nwse-resize;
    background: rgba(255,255,255,0.2);
    border-radius: 12px 0 12px 0;
  ">
    <span style="
      position: absolute;
      bottom: 1px;
      right: 2px;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      line-height: 1;
    ">‚ã∞</span>
  </div>
</div>

<script>
// ============= RELEVANT EXAMPLES =============
let currentExamples = [];

async function getRelevantExamples() {
  const code = editor.getValue();
  const selection = editor.getSelection();
  const cursorLine = selection.startLineNumber;
  const selectedText = editor.getModel().getValueInRange(selection);
  
  // Show panel with loading state
  const examplesPanel = document.getElementById('examplesPanel');
  const examplesOverlay = document.getElementById('examplesOverlay');
  const examplesContent = document.getElementById('examplesContent');
  
  // Show overlay and panel
  if (examplesOverlay) examplesOverlay.style.display = 'block';
  examplesPanel.style.display = 'block';
  
  examplesContent.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div class="spinner" style="margin: 0 auto 15px;"></div>
      <p style="color: rgba(255,255,255,0.8);">üîç Finding relevant examples...</p>
    </div>
  `;
  
  try {
    const response = await fetch("{% url 'webprojects:get_code_examples' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        code: code,
        cursor_line: cursorLine,
        selected_text: selectedText,
        file_id: {{ file.id }}
      })
    });
    
    const data = await response.json();
    
    if (data.status === "success" && data.examples) {
      currentExamples = data.examples;
      displayExamples(data.examples);
    } else {
      examplesContent.innerHTML = `
        <div style="text-align: center; padding: 30px;">
          <span style="font-size: 48px;">‚ùå</span>
          <p style="margin-top: 15px;">No examples found</p>
          <small style="opacity: 0.7;">${escapeHTML(data.message || '')}</small>
        </div>
      `;
    }
  } catch (error) {
    examplesContent.innerHTML = `
      <div style="text-align: center; padding: 30px;">
        <span style="font-size: 48px;">‚ö†Ô∏è</span>
        <p style="margin-top: 15px;">Connection error</p>
        <small style="opacity: 0.7;">${escapeHTML(error.message)}</small>
      </div>
    `;
  }
}

function displayExamples(examples) {
  const examplesContent = document.getElementById('examplesContent');
  
  if (!examples || examples.length === 0) {
    examplesContent.innerHTML = `
      <div style="text-align: center; padding: 30px;">
        <span style="font-size: 48px;">üìù</span>
        <p style="margin-top: 15px; color: rgba(255,255,255,0.9);">
          No examples found yet. Keep coding!
        </p>
      </div>
    `;
    return;
  }
  
  examplesContent.innerHTML = '';
  
  examples.forEach((example, index) => {
    const exampleDiv = document.createElement('div');
    exampleDiv.className = 'code-example-item';
    exampleDiv.style.cssText = `
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-left: 4px solid #3498db;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    `;
    
    exampleDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div>
          <span style="
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
          ">${example.category || 'Example'}</span>
        </div>
        <span style="font-size: 24px;">${getCategoryEmoji(example.category)}</span>
      </div>
      
      <h4 style="color: white; margin: 10px 0; font-size: 16px;">
        ${example.title}
      </h4>
      
      <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 12px; line-height: 1.5;">
        ${example.explanation}
      </p>
      
      <pre style="
        background: rgba(0,0,0,0.4);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.5;
        border: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 10px;
      "><code>${escapeHTML(example.code)}</code></pre>
    `;
    
    // Hover effect
    exampleDiv.addEventListener('mouseenter', () => {
      exampleDiv.style.background = 'rgba(52, 152, 219, 0.2)';
      exampleDiv.style.transform = 'translateX(5px)';
    });
    
    exampleDiv.addEventListener('mouseleave', () => {
      exampleDiv.style.background = 'rgba(0,0,0,0.3)';
      exampleDiv.style.transform = 'translateX(0)';
    });
    
    examplesContent.appendChild(exampleDiv);
  });
}

function getCategoryEmoji(category) {
  const emojis = {
    'input': '‚å®Ô∏è',
    'loops': 'üîÑ',
    'conditionals': 'üîÄ',
    'functions': '‚öôÔ∏è',
    'lists': 'üìã',
    'strings': 'üìù',
    'math': 'üî¢',
    'files': 'üìÅ',
    'beginner': 'üå±',
    'intermediate': 'üöÄ',
    'advanced': '‚≠ê'
  };
  
  return emojis[category?.toLowerCase()] || 'üí°';
}





function closeExamplesPanel() {
  document.getElementById('examplesPanel').style.display = 'none';
  const overlay = document.getElementById('examplesOverlay');
  if (overlay) overlay.style.display = 'none';
  currentExamples = [];
}

// Make examples panel draggable (same as hint panel)
document.addEventListener('DOMContentLoaded', function() {
  const examplesPanel = document.getElementById('examplesPanel');
  const dragHandle = document.getElementById('examplesDragHandle');
  const resizeHandle = document.getElementById('examplesResizeHandle');
  
  if (!examplesPanel || !dragHandle) return;
  
  let isDragging = false;
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  
  dragHandle.addEventListener('mousedown', function(e) {
    if (e.target.tagName === 'BUTTON') return;
    isDragging = true;
    dragOffsetX = e.clientX - examplesPanel.offsetLeft;
    dragOffsetY = e.clientY - examplesPanel.offsetTop;
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;
    let newLeft = e.clientX - dragOffsetX;
    let newTop = e.clientY - dragOffsetY;
    const maxLeft = window.innerWidth - examplesPanel.offsetWidth;
    const maxTop = window.innerHeight - examplesPanel.offsetHeight;
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop = Math.max(0, Math.min(newTop, maxTop));
    examplesPanel.style.left = newLeft + 'px';
    examplesPanel.style.top = newTop + 'px';
  });
  
  document.addEventListener('mouseup', function() {
    isDragging = false;
  });
});  
</script>

<script>
// ai open and close tab js  
const toggleBtn = document.getElementById("toggleAIBtn");
const aiPanel = document.getElementById("aiopenclose");

toggleBtn.addEventListener("click", function() {
    if (aiPanel.style.display === "none") {
        aiPanel.style.display = "block";
    } else {
        aiPanel.style.display = "none";
    }
});
</script>


<script>
  
/* ================= TAB SWITCHING ================= */
const appBuilderTab = document.getElementById('appBuilderTab');
const fileEditorTab = document.getElementById('fileEditorTab');
const appBuilderPanel = document.getElementById('appBuilderPanel');
const fileEditorPanel = document.getElementById('fileEditorPanel');

function switchToAppBuilder() {
  appBuilderPanel.style.display = 'flex';
  fileEditorPanel.style.display = 'none';

  appBuilderTab.style.borderBottom = '3px solid #007bff';
  appBuilderTab.style.fontWeight = 'bold';
  appBuilderTab.style.color = '#007bff';

  fileEditorTab.style.borderBottom = '3px solid transparent';
  fileEditorTab.style.fontWeight = 'normal';
  fileEditorTab.style.color = '#666';
}

function switchToFileEditor() {
  appBuilderPanel.style.display = 'none';
  fileEditorPanel.style.display = 'flex';

  fileEditorTab.style.borderBottom = '3px solid #28a745';
  fileEditorTab.style.fontWeight = 'bold';
  fileEditorTab.style.color = '#28a745';

  appBuilderTab.style.borderBottom = '3px solid transparent';
  appBuilderTab.style.fontWeight = 'normal';
  appBuilderTab.style.color = '#666';
}

appBuilderTab.onclick = switchToAppBuilder;
fileEditorTab.onclick = switchToFileEditor;

/* ================= FLOATING PANEL DRAG (Desktop + Mobile) ================= */
const panel = document.getElementById('floatingAI');
const dragHandle = document.getElementById('dragHandle');

let isDraggingPanel = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

// Desktop: Mouse events
dragHandle.addEventListener('mousedown', e => {
  // Don't drag if clicking buttons
  if (e.target.id === 'collapseBtn' || e.target.id === 'closeBtn') return;
  
  isDraggingPanel = true;
  dragOffsetX = e.clientX - panel.offsetLeft;
  dragOffsetY = e.clientY - panel.offsetTop;
  dragHandle.style.cursor = 'grabbing';
  e.preventDefault();
});

document.addEventListener('mousemove', e => {
  if (!isDraggingPanel) return;
  
  let newLeft = e.clientX - dragOffsetX;
  let newTop = e.clientY - dragOffsetY;
  
  const maxLeft = window.innerWidth - panel.offsetWidth;
  const maxTop = window.innerHeight - panel.offsetHeight;
  
  newLeft = Math.max(0, Math.min(newLeft, maxLeft));
  newTop = Math.max(0, Math.min(newTop, maxTop));
  
  panel.style.left = newLeft + 'px';
  panel.style.top = newTop + 'px';
});

document.addEventListener('mouseup', () => {
  isDraggingPanel = false;
  dragHandle.style.cursor = 'grab';
});

// Mobile: Touch events
dragHandle.addEventListener('touchstart', e => {
  // Don't drag if touching buttons
  if (e.target.id === 'collapseBtn' || e.target.id === 'closeBtn') return;
  
  isDraggingPanel = true;
  const touch = e.touches[0];
  dragOffsetX = touch.clientX - panel.offsetLeft;
  dragOffsetY = touch.clientY - panel.offsetTop;
  e.preventDefault();
});

document.addEventListener('touchmove', e => {
  if (!isDraggingPanel) return;
  
  const touch = e.touches[0];
  let newLeft = touch.clientX - dragOffsetX;
  let newTop = touch.clientY - dragOffsetY;
  
  const maxLeft = window.innerWidth - panel.offsetWidth;
  const maxTop = window.innerHeight - panel.offsetHeight;
  
  newLeft = Math.max(0, Math.min(newLeft, maxLeft));
  newTop = Math.max(0, Math.min(newTop, maxTop));
  
  panel.style.left = newLeft + 'px';
  panel.style.top = newTop + 'px';
  
  e.preventDefault();
});

document.addEventListener('touchend', () => {
  isDraggingPanel = false;
});

/* ================= RESIZE ================= */
const resizeHandleAI = document.getElementById('resizeHandleAI');
let isResizing = false;

resizeHandleAI.addEventListener('mousedown', e => {
  isResizing = true;
  e.preventDefault();
});

document.addEventListener('mousemove', e => {
  if (!isResizing) return;
  let newHeight = e.clientY - panel.offsetTop;
  if (newHeight < 150) newHeight = 150;
  panel.style.height = newHeight + 'px';
});

document.addEventListener('mouseup', () => isResizing = false);

/* ================= AI APPLY CHANGES ================= */

// ‚úÖ SAFE URL FROM DJANGO
const FILE_CHAT_URL = "{% url 'webprojects:file_chat' project.id file.id %}";

function getCsrfToken() {
  return (
    document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
    document.querySelector('meta[name="csrf-token"]')?.content ||
    ''
  );
}

async function applyChanges() {
  const promptInput = document.getElementById('fileChatPrompt');
  const outputEl = document.getElementById('fileChatOutput');
  const applyBtn = document.getElementById('applyBtn');

  const prompt = promptInput.value.trim();
  if (!prompt) {
    alert("Please describe the changes you want");
    return;
  }

  applyBtn.disabled = true;
  applyBtn.textContent = 'Applying...';
  outputEl.style.display = 'block';
  outputEl.textContent += `\n‚è≥ Applying: "${prompt}"\n`;

  try {
    const res = await fetch(FILE_CHAT_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-CSRFToken": getCsrfToken()
      },
      credentials: "same-origin",
      body: JSON.stringify({
        prompt: prompt,
        apply: true
      })
    });

    const contentType = res.headers.get("content-type") || "";

    if (!contentType.includes("application/json")) {
      throw new Error("Server returned HTML instead of JSON");
    }

    const data = await res.json();

    if (data.status === "success" && data.code) {
      if (typeof editor !== "undefined") {
        if (editor.setValue) {
          editor.setValue(data.code);
        } else if (editor.getModel) {
          editor.getModel().setValue(data.code);
        }
      }

      outputEl.textContent += "‚úÖ Changes applied and saved!\n\n";
      promptInput.value = "";
    } else {
      outputEl.textContent += `‚ùå Error: ${data.message || "Unknown error"}\n\n`;
    }

  } catch (err) {
    console.error(err);
    outputEl.textContent += `‚ùå Request failed: ${err.message}\n\n`;
  } finally {
    applyBtn.disabled = false;
    applyBtn.textContent = 'Apply Changes';
  }
}

document.getElementById('applyBtn').onclick = applyChanges;

document.getElementById('fileChatPrompt').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    applyChanges();
  }
});
</script>



  <!-- Output panel -->
  <div id="outputPanel" style="height: 100px; background: #1e1e1e; color: #dcdcdc; padding: 2px; overflow-y: auto; font-family: monospace; font-size: 0.9em; border-top: 1px solid #444;">
    <strong>üîΩ Output:</strong>
    <pre id="outputText" style="white-space: pre-wrap;"></pre>
    <div id="tablePreview" style="margin-top: 1px;display: none;"></div>
    <div id="plotPreview" style="display: none;"></div>
  </div>
</div>



    <!-- AI Suggestion Preview Modal -->
<div id="aiModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
  background:#2d2d2d; color:#fff; padding:20px; border-radius:8px; z-index:1000; max-width:80%; box-shadow:0 0 10px #000;">
  <h3>üí° AI Suggestion Preview</h3>
  <pre id="aiModalContent" style="max-height:400px; overflow-y:auto; white-space:pre-wrap; background:#1e1e1e; padding:10px; border:1px solid #444;"></pre>
  <div style="text-align:right; margin-top:10px;">
    <button onclick="insertSuggestionFromModal()" style="background:#2ecc71; color:white; padding:6px 12px; border:none; border-radius:4px;">Insert</button>
    <button onclick="closeAIModal()" style="background:#e74c3c; color:white; padding:6px 12px; border:none; border-radius:4px; margin-left:8px;">Cancel</button>
  </div>
</div>

  </div>
</div>

<div id="toastMessage" style="
  display: none;
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #222;
  color: #fff;
  padding: 10px 18px;
  border-radius: 6px;
  z-index: 9999;
  font-size: 0.9em;
  max-width: 90%;
  text-align: left;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
"></div>


<!-- js section -->

<!-- prompts js -->
<script>
// ============= FILE SWITCHING WITHOUT RELOAD =============
let currentFileId = {{ file.id }};
let currentProjectId = {{ file.project.id }};

async function loadFile(projectId, fileId, fileName) {
  if (fileId === currentFileId) return;
  
  // Add loading indicator
  const link = document.querySelector(`[data-file-id="${fileId}"]`);
  if (link) link.classList.add('loading');
  
  showToast('‚è≥ Loading ' + fileName + '...');
  
  // Save current file before switching
  if (editor && lastSavedContent !== editor.getValue()) {
    await performAutoSave();
  }
  
  try {
    const response = await fetch(`/webprojects/project/${projectId}/file/${fileId}/content/`);
    const data = await response.json();
    
    if (data.status === 'success') {
      const fileData = data.file;
      
      if (editor) {
        editor.setValue(fileData.content);
        const model = editor.getModel();
        monaco.editor.setModelLanguage(model, fileData.language);
        lastSavedContent = fileData.content;
      }
      
      currentFileId = fileData.id;
      currentProjectId = projectId;
      
      updateActiveFileUI(fileId, fileName);
      updateURL(projectId, fileId);
      clearOutput();
      
      showToast('‚úÖ Loaded ' + fileName);
    } else {
      showToast('‚ùå Failed to load file: ' + data.message);
    }
  } catch (error) {
    console.error('Error loading file:', error);
    showToast('‚ùå Error loading file');
  } finally {
    // Remove loading indicator
    if (link) link.classList.remove('loading');
  }
}

function updateActiveFileUI(fileId, fileName) {
  // Remove highlight from all files
  document.querySelectorAll('.file-link').forEach(link => {
    link.style.fontWeight = 'normal';
    link.style.color = '';
  });
  
  // Highlight active file
  const activeLink = document.querySelector(`[data-file-id="${fileId}"]`);
  if (activeLink) {
    activeLink.style.fontWeight = 'bold';
    activeLink.style.color = '#3498db';
  }
  
  // Update page title
  document.title = fileName + ' | Code Editor';
  
  // Update file name display in navbar
  const fileNameDisplay = document.querySelector('.project-info span:last-child');
  if (fileNameDisplay) {
    fileNameDisplay.textContent = 'üìù ' + fileName;
  }
}

function updateURL(projectId, fileId) {
  // Update browser URL without reload (allows bookmarking/back button)
  const newUrl = `/webprojects/${projectId}/file/${fileId}/`;
  window.history.pushState(
    { projectId, fileId }, 
    '', 
    newUrl
  );
}

function clearOutput() {
  // Clear output panel when switching files
  const outputText = document.getElementById('outputText');
  const plotPreview = document.getElementById('plotPreview');
  const tablePreview = document.getElementById('tablePreview');
  
  if (outputText) outputText.textContent = '';
  if (plotPreview) plotPreview.innerHTML = '';
  if (tablePreview) {
    tablePreview.innerHTML = '';
    tablePreview.style.display = 'none';
  }
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
  if (event.state && event.state.fileId) {
    // User clicked back/forward - load that file
    const link = document.querySelector(`[data-file-id="${event.state.fileId}"]`);
    if (link) {
      const fileName = link.textContent.trim().replace('üìù ', '');
      loadFile(event.state.projectId, event.state.fileId, fileName);
    }
  }
});

// Initialize history state
window.history.replaceState(
  { projectId: currentProjectId, fileId: currentFileId },
  '',
  window.location.pathname
);

console.log('‚úÖ File switching initialized');
</script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const runButton = document.getElementById("runAIPrompt");
    const aiPrompt = document.getElementById("aiPrompt");
    const preview = document.getElementById("preview");

    const FILE_ID = {{ file.id }};
    const PROJECT_ID = {{ project.id }};
    const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // ‚úÖ Helper: Render into iframe
    function renderPreview(html, css, js) {
      preview.srcdoc = `
        <html>
          <head>
            <style>${css || ""}</style>
          </head>
          <body>
            ${html || ""}
            <script>${js || ""}<\/script>
          </body>
        </html>`;
    }

    // ‚úÖ Load saved project files on page load
    async function loadSavedProject() {
      try {
        const res = await fetch(`/webprojects/${PROJECT_ID}/load-files/`);
        const data = await res.json();
        if (data.status === "success") {
          renderPreview(data.html, data.css, data.js);
        } else {
          console.warn("No saved project files found");
        }
      } catch (err) {
        console.error("Error loading saved project:", err);
      }
    }

    // ‚úÖ Run AI and update project
    runButton.addEventListener("click", async () => {
      const promptText = aiPrompt.value.trim();
      if (!promptText) return alert("Enter a prompt");

      runButton.disabled = true;
      runButton.textContent = "Generating...";

      try {
        const res = await fetch(`/webprojects/${PROJECT_ID}/file/${FILE_ID}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ file_id: FILE_ID, prompt: promptText })
        });

        const data = await res.json();
        console.log("AI Response:", data);

        if (data.status === "success" && data.ai_content) {
          // ‚úÖ Render new AI output immediately
          renderPreview(
            data.ai_content.html,
            data.ai_content.css,
            data.ai_content.js
          );
        } else {
          alert("AI generation failed: " + (data.message || JSON.stringify(data)));
        }

      } catch (err) {
        console.error(err);
        alert("Error contacting AI backend: " + err.message);
      } finally {
        runButton.disabled = false;
        runButton.textContent = "‚ú® Generate";
      }
    });

    // ‚úÖ Initial load
    loadSavedProject();
  });
</script>

<!-- side content js -->

<script>
  function toggleDesc(id, el, lang) {
    const desc = document.getElementById(id);
    if(desc.style.display === "none") {
      desc.style.display = "block";
      el.querySelector(".toggle-icon").textContent = "‚ûñ";

      // Apply Prism highlighting
      const codeEl = desc.querySelector('code');
      codeEl.className = 'language-' + lang;
      Prism.highlightElement(codeEl);
    } else {
      desc.style.display = "none";
      el.querySelector(".toggle-icon").textContent = "‚ûï";
    }
  }
</script>

<!-- your sidebar content below... -->
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const editorLayout = document.getElementById('editorLayout');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    const sidebar = document.querySelector('.sidebar'); // Add your sidebar selector
    const resizeHandle = document.createElement('div');
    
    // Create resize handle
    resizeHandle.className = 'resize-handle';
    resizeHandle.style.cssText = `
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: transparent;
      z-index: 10;
    `;
    resizeHandle.onmouseenter = () => resizeHandle.style.background = '#4fa';
    resizeHandle.onmouseleave = () => resizeHandle.style.background = 'transparent';
    
    sidebar.style.position = 'relative';
    sidebar.appendChild(resizeHandle);

    // Resize functionality
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      startX = e.clientX;
      startWidth = sidebar.offsetWidth;
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      
      const width = startWidth + (e.clientX - startX);
      const minWidth = 200; // Minimum sidebar width
      const maxWidth = 950; // Maximum sidebar width
      
      if (width >= minWidth && width <= maxWidth) {
        sidebar.style.width = width + 'px';
        sidebar.style.flexBasis = width + 'px';
        sidebar.style.minWidth = width + 'px';
        
        // Relayout Monaco Editor during resize
        if (window.editor?.layout) {
          window.editor.layout();
        }
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        
        // Save width to localStorage
        localStorage.setItem('sidebarWidth', sidebar.offsetWidth);
      }
    });

    // Restore saved width
    const savedWidth = localStorage.getItem('sidebarWidth');
    if (savedWidth) {
      sidebar.style.width = savedWidth + 'px';
      sidebar.style.flexBasis = savedWidth + 'px';
      sidebar.style.minWidth = savedWidth + 'px';
    }

    // Toggle sidebar
    const updateToggleIcon = (isCollapsed) => {
      toggleBtn.innerHTML = isCollapsed 
        ? '<span title="Open Sidebar">‚ò∞</span>' 
        : '<span title="Close Sidebar">‚úñ</span>';
    };

    toggleBtn.addEventListener('click', () => {
      const isCollapsed = editorLayout.classList.toggle('collapsed');
      updateToggleIcon(isCollapsed);

      // Relayout Monaco Editor
      setTimeout(() => {
        if (window.editor?.layout) {
          window.editor.layout();
        }
      }, 100);
    });

    // Initial state
    updateToggleIcon(editorLayout.classList.contains('collapsed'));
  });
</script>

<script>
  function showImageModal(imgUrl) {
    document.getElementById('popupImage').src = imgUrl;
    document.getElementById('imagePopupModal').style.display = 'block';
  }

  function closeImageModal() {
    document.getElementById('imagePopupModal').style.display = 'none';
    document.getElementById('popupImage').src = "";
  }
</script>

<script>
// function getAISuggestion() {
//   alert("AI Suggestion not implemented yet.");
// }
// function explainCode() {
//   alert("Explain Code not implemented yet.");
// }
function runAIAction() {
  const action = document.getElementById("aiAction").value;
  alert("Run AI Action (" + action + ") not implemented yet.");
}


// Helper: Find which line has the syntax error
function findErrorLine(code) {
  const lines = code.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // Skip empty lines and comments
    if (!line || line.startsWith('#')) continue;
    
    // Check for unclosed parentheses
    const openParens = (line.match(/\(/g) || []).length;
    const closeParens = (line.match(/\)/g) || []).length;
    if (openParens !== closeParens) return i + 1;
    
    // Check for unclosed quotes (simple check)
    let inString = false;
    let quoteChar = null;
    for (let j = 0; j < line.length; j++) {
      const char = line[j];
      const prevChar = j > 0 ? line[j - 1] : null;
      
      if ((char === '"' || char === "'") && prevChar !== '\\') {
        if (!inString) {
          inString = true;
          quoteChar = char;
        } else if (char === quoteChar) {
          inString = false;
          quoteChar = null;
        }
      }
    }
    if (inString) return i + 1; // Unclosed string
    
    // Check for unclosed brackets
    const openBrackets = (line.match(/\[/g) || []).length;
    const closeBrackets = (line.match(/\]/g) || []).length;
    if (openBrackets !== closeBrackets) return i + 1;
    
    // Check for unclosed braces
    const openBraces = (line.match(/\{/g) || []).length;
    const closeBraces = (line.match(/\}/g) || []).length;
    if (openBraces !== closeBraces) return i + 1;
  }
  
  return -1; // No error found
}

// Helper function to detect common syntax errors
function checkForSyntaxErrors(code) {
  return findErrorLine(code) > 0;
}

// Helper: Append code to the end with proper spacing
function appendToEnd(code) {
  const lastLine = editor.getModel().getLineCount();
  const lastLineContent = editor.getModel().getLineContent(lastLine);
  const needsNewline = lastLineContent.trim() !== '';
  
  editor.executeEdits('hint-suggestion', [{
    range: new monaco.Range(lastLine + 1, 1, lastLine + 1, 1),
    text: (needsNewline ? '\n' : '') + code,
    forceMoveMarkers: true
  }]);
  
  // Scroll to the new code
  setTimeout(() => {
    const newLastLine = editor.getModel().getLineCount();
    editor.revealLineInCenter(newLastLine);
  }, 100);
}

// Helper: Find which line has the syntax error
function findErrorLine(code) {
  const lines = code.split('\n');
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    // Check for unclosed parentheses
    const openParens = (line.match(/\(/g) || []).length;
    const closeParens = (line.match(/\)/g) || []).length;
    if (openParens !== closeParens) return i + 1;
    
    // Check for unclosed quotes
    const singleQuotes = (line.match(/(?<!\\)'/g) || []).length;
    const doubleQuotes = (line.match(/(?<!\\)"/g) || []).length;
    if (singleQuotes % 2 !== 0 || doubleQuotes % 2 !== 0) return i + 1;
    
    // Check for unclosed brackets
    const openBrackets = (line.match(/\[/g) || []).length;
    const closeBrackets = (line.match(/\]/g) || []).length;
    if (openBrackets !== closeBrackets) return i + 1;
  }
  
  return -1; // No error found
}

// Helper: Parse AI suggestion into fixed code vs new code
function parseSuggestion(suggestion, currentCode) {
  const suggestionLines = suggestion.split('\n');
  const currentLines = currentCode.split('\n');
  
  let fixedCode = '';
  let newCode = '';
  let foundDifference = false;
  
  // Try to identify which part is "fixing" existing code vs adding new code
  for (let i = 0; i < suggestionLines.length; i++) {
    const sugLine = suggestionLines[i].trim();
    
    // Check if this line looks like a fix of an existing line
    if (!foundDifference && i < currentLines.length) {
      const currLine = currentLines[i].trim();
      
      // If lines are similar (fixing syntax), this is the fixed code
      if (areSimilarLines(currLine, sugLine) && currLine !== sugLine) {
        fixedCode = suggestionLines[i];
        foundDifference = true;
        continue;
      }
    }
    
    // Everything else is new code
    if (foundDifference || i >= currentLines.length) {
      newCode += (newCode ? '\n' : '') + suggestionLines[i];
    }
  }
  
  return { fixedCode, newCode };
}

// Helper: Check if two lines are similar (same variable names, structure)
function areSimilarLines(line1, line2) {
  // Remove whitespace and compare structure
  const normalized1 = line1.replace(/\s+/g, '').toLowerCase();
  const normalized2 = line2.replace(/\s+/g, '').toLowerCase();
  
  // Check if they share significant portions
  const shorter = normalized1.length < normalized2.length ? normalized1 : normalized2;
  const longer = normalized1.length >= normalized2.length ? normalized1 : normalized2;
  
  // If 70% of the shorter string is in the longer string, they're similar
  let matchCount = 0;
  for (let i = 0; i < shorter.length; i++) {
    if (longer.includes(shorter[i])) matchCount++;
  }
  
  return (matchCount / shorter.length) > 0.7;
}

// Helper function to detect common syntax errors (keep existing)
function checkForSyntaxErrors(code) {
  const lines = code.split('\n');
  
  for (let line of lines) {
    const trimmed = line.trim();
    
    // Check for unclosed parentheses
    const openParens = (trimmed.match(/\(/g) || []).length;
    const closeParens = (trimmed.match(/\)/g) || []).length;
    if (openParens !== closeParens) return true;
    
    // Check for unclosed quotes
    const singleQuotes = (trimmed.match(/(?<!\\)'/g) || []).length;
    const doubleQuotes = (trimmed.match(/(?<!\\)"/g) || []).length;
    if (singleQuotes % 2 !== 0 || doubleQuotes % 2 !== 0) return true;
    
    // Check for unclosed brackets
    const openBrackets = (trimmed.match(/\[/g) || []).length;
    const closeBrackets = (trimmed.match(/\]/g) || []).length;
    if (openBrackets !== closeBrackets) return true;
    
    // Check for unclosed braces
    const openBraces = (trimmed.match(/\{/g) || []).length;
    const closeBraces = (trimmed.match(/\}/g) || []).length;
    if (openBraces !== closeBraces) return true;
  }
  
  return false;
}


function showMoreHints() {
  // Request a different type of hint
  getSmartHint();
}

function closeHintPanel() {
  document.getElementById('hintPanel').style.display = 'none';
  document.getElementById('hintOverlay').style.display = 'none';
  currentHintSuggestion = null;

  
}
// ============= HINT PANEL DRAG & RESIZE =============
let isDraggingHint = false;
let isResizingHint = false;
let hintDragOffsetX = 0;
let hintDragOffsetY = 0;
let hintStartWidth = 0;
let hintStartHeight = 0;
let hintStartX = 0;
let hintStartY = 0;

// Initialize drag and resize handlers
document.addEventListener('DOMContentLoaded', function() {
  const hintPanel = document.getElementById('hintPanel');
  const dragHandle = document.getElementById('hintDragHandle');
  const resizeHandle = document.getElementById('hintResizeHandle');
  
  if (!hintPanel || !dragHandle) return;
  
  // ========== DRAG FUNCTIONALITY (Desktop + Mobile) ==========
  
  // Mouse events (Desktop)
  dragHandle.addEventListener('mousedown', startDragging);
  
  // Touch events (Mobile)
  dragHandle.addEventListener('touchstart', startDraggingTouch);
  
  function startDragging(e) {
    // Don't drag if clicking the close button
    if (e.target.tagName === 'BUTTON') return;
    
    isDraggingHint = true;
    hintPanel.classList.add('dragging');
    
    hintDragOffsetX = e.clientX - hintPanel.offsetLeft;
    hintDragOffsetY = e.clientY - hintPanel.offsetTop;
    
    e.preventDefault();
  }
  
  function startDraggingTouch(e) {
    if (e.target.tagName === 'BUTTON') return;
    
    isDraggingHint = true;
    hintPanel.classList.add('dragging');
    
    const touch = e.touches[0];
    hintDragOffsetX = touch.clientX - hintPanel.offsetLeft;
    hintDragOffsetY = touch.clientY - hintPanel.offsetTop;
    
    e.preventDefault();
  }
  
  // Mouse move
  document.addEventListener('mousemove', function(e) {
    if (!isDraggingHint) return;
    
    let newLeft = e.clientX - hintDragOffsetX;
    let newTop = e.clientY - hintDragOffsetY;
    
    // Keep within viewport bounds
    const maxLeft = window.innerWidth - hintPanel.offsetWidth;
    const maxTop = window.innerHeight - hintPanel.offsetHeight;
    
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop = Math.max(0, Math.min(newTop, maxTop));
    
    hintPanel.style.left = newLeft + 'px';
    hintPanel.style.top = newTop + 'px';
    hintPanel.style.right = 'auto'; // Remove right positioning
  });
  
  // Touch move
  document.addEventListener('touchmove', function(e) {
    if (!isDraggingHint) return;
    
    const touch = e.touches[0];
    let newLeft = touch.clientX - hintDragOffsetX;
    let newTop = touch.clientY - hintDragOffsetY;
    
    const maxLeft = window.innerWidth - hintPanel.offsetWidth;
    const maxTop = window.innerHeight - hintPanel.offsetHeight;
    
    newLeft = Math.max(0, Math.min(newLeft, maxLeft));
    newTop = Math.max(0, Math.min(newTop, maxTop));
    
    hintPanel.style.left = newLeft + 'px';
    hintPanel.style.top = newTop + 'px';
    hintPanel.style.right = 'auto';
    
    e.preventDefault();
  });
  
  // Mouse up
  document.addEventListener('mouseup', function() {
    if (isDraggingHint) {
      isDraggingHint = false;
      hintPanel.classList.remove('dragging');
    }
    if (isResizingHint) {
      isResizingHint = false;
    }
  });
  
  // Touch end
  document.addEventListener('touchend', function() {
    if (isDraggingHint) {
      isDraggingHint = false;
      hintPanel.classList.remove('dragging');
    }
    if (isResizingHint) {
      isResizingHint = false;
    }
  });
  
  // ========== RESIZE FUNCTIONALITY ==========
  
  if (resizeHandle) {
    // Mouse events
    resizeHandle.addEventListener('mousedown', function(e) {
      isResizingHint = true;
      hintStartWidth = hintPanel.offsetWidth;
      hintStartHeight = hintPanel.offsetHeight;
      hintStartX = e.clientX;
      hintStartY = e.clientY;
      e.preventDefault();
      e.stopPropagation();
    });
    
    // Touch events
    resizeHandle.addEventListener('touchstart', function(e) {
      isResizingHint = true;
      hintStartWidth = hintPanel.offsetWidth;
      hintStartHeight = hintPanel.offsetHeight;
      const touch = e.touches[0];
      hintStartX = touch.clientX;
      hintStartY = touch.clientY;
      e.preventDefault();
      e.stopPropagation();
    });
    
    // Mouse move for resize
    document.addEventListener('mousemove', function(e) {
      if (!isResizingHint) return;
      
      const deltaX = e.clientX - hintStartX;
      const deltaY = e.clientY - hintStartY;
      
      let newWidth = hintStartWidth + deltaX;
      let newHeight = hintStartHeight + deltaY;
      
      // Min and max constraints
      newWidth = Math.max(300, Math.min(newWidth, 800));
      newHeight = Math.max(300, Math.min(newHeight, window.innerHeight - 100));
      
      hintPanel.style.width = newWidth + 'px';
      hintPanel.style.maxHeight = newHeight + 'px';
      
      // Adjust content height
      const contentHeight = newHeight - 180; // Account for header and actions
      document.getElementById('hintContent').style.maxHeight = contentHeight + 'px';
    });
    
    // Touch move for resize
    document.addEventListener('touchmove', function(e) {
      if (!isResizingHint) return;
      
      const touch = e.touches[0];
      const deltaX = touch.clientX - hintStartX;
      const deltaY = touch.clientY - hintStartY;
      
      let newWidth = hintStartWidth + deltaX;
      let newHeight = hintStartHeight + deltaY;
      
      newWidth = Math.max(300, Math.min(newWidth, 800));
      newHeight = Math.max(300, Math.min(newHeight, window.innerHeight - 100));
      
      hintPanel.style.width = newWidth + 'px';
      hintPanel.style.maxHeight = newHeight + 'px';
      
      const contentHeight = newHeight - 180;
      document.getElementById('hintContent').style.maxHeight = contentHeight + 'px';
      
      e.preventDefault();
    });
  }
});

// Update closeHintPanel to show overlay
function closeHintPanel() {
  document.getElementById('hintPanel').style.display = 'none';
  const overlay = document.getElementById('hintOverlay');
  if (overlay) overlay.style.display = 'none';
  currentHintSuggestion = null;
}
</script>

<script>
// ============= GLOBAL VARIABLES =============
let editor;
let currentTheme = localStorage.getItem('editorTheme') || 'vs-dark';
let autoSaveInterval;
let lastSavedContent = '';
let saveIndicator = null;

// ============= UTILITY FUNCTIONS (Define First) =============
function getLanguage(fileName) {
  const ext = fileName.split('.').pop().toLowerCase();
  switch (ext) {
    case "py": return "python";
    case "js": return "javascript";
    case "html": return "html";
    case "css": return "css";
    case "json": return "json";
    default: return "plaintext";
  }
}

function updateThemeButton(theme) {
  const themeText = document.getElementById('themeToggleText');
  const isDark = theme === 'vs-dark';
  
  if (themeText) {
    themeText.textContent = isDark ? 'Light Mode' : 'Dark Mode';
  }
}

function escapeHTML(str) {
  return String(str).replace(/[&<>"']/g, tag => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[tag]));
}

// ============= AUTO-SAVE FUNCTIONS =============
function createSaveIndicator() {
  if (!saveIndicator) {
    saveIndicator = document.createElement('div');
    saveIndicator.id = 'saveIndicator';
    saveIndicator.style.cssText = `
      position: fixed;
      top: 60px;
      right: 20px;
      padding: 8px 15px;
      background: rgba(46, 204, 113, 0.9);
      color: white;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(saveIndicator);
  }
  return saveIndicator;
}

function showSaveStatus(message, isError = false) {
  const indicator = createSaveIndicator();
  indicator.textContent = message;
  indicator.style.background = isError 
    ? 'rgba(231, 76, 60, 0.9)' 
    : 'rgba(46, 204, 113, 0.9)';
  indicator.style.opacity = '1';
  
  setTimeout(() => {
    indicator.style.opacity = '0';
  }, 2000);
}


function performAutoSave() {
  if (!editor) {
    console.log("‚è≠Ô∏è Editor not ready yet");
    return;
  }

  const currentContent = editor.getValue();
  
  console.log("=== AUTO-SAVE DEBUG ===");
  console.log("File ID:", currentFileId);  // ‚Üê Use currentFileId instead of hardcoded
  console.log("Content length:", currentContent.length);
  console.log("Last saved length:", lastSavedContent.length);
  console.log("Content changed:", currentContent !== lastSavedContent);
  
  if (currentContent === lastSavedContent) {
    console.log("‚è≠Ô∏è Skipped - No changes");
    return;
  }
  
  console.log("üíæ Attempting auto-save...");
  showSaveStatus('Saving...', false);
  
  const saveData = {
    file_id: currentFileId,  // ‚Üê Use currentFileId
    content: currentContent
  };
  
  fetch("{% url 'webprojects:file_autosave' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify(saveData)
  })
  .then(response => {
    console.log("Response status:", response.status);
    return response.json();
  })
  .then(data => {
    console.log("Response data:", data);
    
    if (data.status === "success") {
      lastSavedContent = currentContent;
      const time = new Date().toLocaleTimeString();
      console.log(`‚úÖ Auto-saved successfully at ${time}`);
      showSaveStatus(`‚úì Saved ${time}`);
    } else {
      console.error("‚ùå Save failed:", data.message);
      showSaveStatus('‚úó Failed', true);
    }
  })
  .catch(err => {
    console.error("‚ùå Auto-save error:", err);
    showSaveStatus('‚úó Error', true);
  });
}
// ============= MONACO EDITOR INITIALIZATION =============
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });

require(['vs/editor/editor.main'], function () {
  console.log("‚úÖ Monaco Editor loaded");
  
  editor = monaco.editor.create(document.getElementById('container'), {
    value: `{{ file.content|escapejs }}`,
    language: getLanguage("{{ file.name }}"),
    theme: currentTheme,
    automaticLayout: true,
    readOnly: false
  });

  console.log("‚úÖ Editor created");

  // Apply theme to page
  applyPageTheme(currentTheme);
  updateThemeButton(currentTheme);

  // Initialize autosave after editor is ready
  setTimeout(() => {
    lastSavedContent = editor.getValue();
    console.log("‚úÖ Initial content loaded, length:", lastSavedContent.length);
    
    // Start autosave interval (every 5 seconds)
    autoSaveInterval = setInterval(performAutoSave, 5000);
    console.log("‚úÖ Auto-save interval started");
    
    // Debounced save on typing
    let typingTimer;
    editor.onDidChangeModelContent(() => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        console.log("User stopped typing, triggering save...");
        performAutoSave();
      }, 2000);
    });
    
    // Save before leaving page
    window.addEventListener('beforeunload', (e) => {
      if (editor.getValue() !== lastSavedContent) {
        console.log("Saving before page unload...");
        performAutoSave();
      }
    });
    
  }, 500);

  // === HTML COMPLETIONS ===
  monaco.languages.registerCompletionItemProvider('html', {
    triggerCharacters: ['<', '"', "'", ' ', ':', '.', '{'],
    provideCompletionItems: function (model, position) {
      const textUntilPosition = model.getValueInRange({
        startLineNumber: 1,
        startColumn: 1,
        endLineNumber: position.lineNumber,
        endColumn: position.column
      });

      const htmlTags = [
        'html', 'head', 'body', 'title', 'meta', 'link', 'style', 'script',
        'header', 'nav', 'main', 'footer', 'section', 'article', 'aside',
        'div', 'span', 'p', 'a', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
        'ul', 'ol', 'li', 'strong', 'em', 'br', 'hr',
        'form', 'input', 'textarea', 'label', 'button', 'select', 'option',
        'img', 'video', 'audio', 'canvas', 'iframe',
        'table', 'thead', 'tbody', 'tr', 'th', 'td'
      ];

      const voidTags = ['meta', 'link', 'br', 'hr', 'img', 'input'];

      const tagSuggestions = htmlTags.map(tag => {
        const isVoid = voidTags.includes(tag);
        return {
          label: tag,
          kind: monaco.languages.CompletionItemKind.Snippet,
          insertText: isVoid ? `<${tag} $1>` : `<${tag}>$1</${tag}>`,
          insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
          documentation: `Insert <${tag}> tag`
        };
      });

      return { suggestions: tagSuggestions };
    }
  });

  // === JAVASCRIPT COMPLETIONS ===
  monaco.languages.registerCompletionItemProvider('javascript', {
    triggerCharacters: ['.', '(', ' '],
    provideCompletionItems: () => ({
      suggestions: [
        {
          label: 'console.log',
          kind: monaco.languages.CompletionItemKind.Function,
          insertText: 'console.log(${1:message});',
          insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
          documentation: 'Log to console'
        },
        {
          label: 'for loop',
          kind: monaco.languages.CompletionItemKind.Snippet,
          insertText: 'for (let ${1:i} = 0; ${1:i} < ${2:array}.length; ${1:i}++) {\n\t${3:// code}\n}',
          insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
          documentation: 'For loop'
        }
      ]
    })
  });

  // === PYTHON COMPLETIONS ===
  const pythonKeywords = ["False", "None", "True", "and", "as", "assert", "break", "class",
    "continue", "def", "del", "elif", "else", "except", "finally", "for", "from", "global",
    "if", "import", "in", "is", "lambda", "not", "or", "pass", "raise",
    "return", "try", "while", "with", "yield"];

  const pythonFunctions = ["abs", "all", "any", "bin", "bool", "chr", "dict", "dir", "enumerate",
    "filter", "float", "input", "int", "len", "list", "map", "max", "min", "open", "ord",
    "pow", "print", "range", "repr", "reversed", "round", "set", "sorted", "str", "sum",
    "tuple", "type", "zip"];

  monaco.languages.registerCompletionItemProvider('python', {
    triggerCharacters: ['.',...'abcdefghijklmnopqrstuvwxyz'],
    provideCompletionItems: (model, position) => {
      const lineUntilCursor = model.getValueInRange({
        startLineNumber: position.lineNumber,
        startColumn: 1,
        endLineNumber: position.lineNumber,
        endColumn: position.column
      });

      const wordMatch = lineUntilCursor.match(/(\w+)$/);
      if (wordMatch) {
        const prefix = wordMatch[1].toLowerCase();
        
        const suggestions = [
          ...pythonKeywords.filter(k => k.toLowerCase().startsWith(prefix)).map(k => ({
            label: k,
            kind: monaco.languages.CompletionItemKind.Keyword,
            insertText: k,
            documentation: `Python keyword: ${k}`
          })),
          ...pythonFunctions.filter(f => f.startsWith(prefix)).map(f => ({
            label: f,
            kind: monaco.languages.CompletionItemKind.Function,
            insertText: f,
            documentation: `Built-in function: ${f}`
          }))
        ];

        return { suggestions };
      }

      return { suggestions: [] };
    }
  });

}); // End of Monaco require block

// ============= THEME TOGGLE (Outside Monaco) =============
function toggleTheme() {
  currentTheme = currentTheme === 'vs-dark' ? 'vs-light' : 'vs-dark';
  
  if (typeof monaco !== 'undefined' && editor) {
    monaco.editor.setTheme(currentTheme);
  }
  
  localStorage.setItem('editorTheme', currentTheme);
  applyPageTheme(currentTheme);
  updateThemeButton(currentTheme);
  
  showToast(`‚úÖ Switched to ${currentTheme === 'vs-dark' ? 'Dark' : 'Light'} Mode`);
}

function applyPageTheme(theme) {
  const body = document.body;
  const isDark = theme === 'vs-dark';
  
  body.style.backgroundColor = isDark ? '#1e1e1e' : '#ffffff';
  body.style.color = isDark ? '#ccc' : '#1a1a1a';
  
  const sidebar = document.querySelector('.sidebar');
  if (sidebar) {
    sidebar.style.backgroundColor = isDark ? '#252526' : '#f8f9fa';
    sidebar.style.borderRight = isDark ? '1px solid #444' : '1px solid #d0d0d0';
    sidebar.style.color = isDark ? '#ccc' : '#1a1a1a';
  }
  
  const toolbar = document.querySelector('.toolbar');
  if (toolbar) {
    toolbar.style.backgroundColor = isDark ? '#1e1e1e' : '#ffffff';
    toolbar.style.borderBottom = isDark ? '1px solid #444' : '1px solid #d0d0d0';
  }
  
  const toolbarButtons = document.querySelectorAll('.toolbar button, .toolbar select');
  toolbarButtons.forEach(btn => {
    btn.style.backgroundColor = isDark ? '#333' : '#007bff';
    btn.style.color = isDark ? '#eee' : '#ffffff';
  });
  
  const runBtn = document.getElementById('runBtnCode');
  if (runBtn) {
    runBtn.style.backgroundColor = isDark ? '#2ecc71' : '#28a745';
    runBtn.style.color = '#ffffff';
  }
  
  const outputPanel = document.getElementById('outputPanel');
  if (outputPanel) {
    outputPanel.style.backgroundColor = isDark ? '#1e1e1e' : '#f8f9fa';
    outputPanel.style.color = isDark ? '#dcdcdc' : '#1a1a1a';
  }
}

// ============= CODE EXECUTION =============
function runCode() {
  const code = editor.getValue();
  const output = document.getElementById("outputText");
  const plotPreview = document.getElementById("plotPreview");

  const inputMatches = code.match(/input\s*\(\s*["']([^"']*)["']\s*\)/g);
  
  if (inputMatches && inputMatches.length > 0) {
    const inputs = [];
    
    for (let i = 0; i < inputMatches.length; i++) {
      const promptMatch = inputMatches[i].match(/input\s*\(\s*["']([^"']*)["']\s*\)/);
      const promptText = promptMatch && promptMatch[1] ? promptMatch[1] : `Input #${i + 1}`;
      
      const userInput = prompt(promptText);
      if (userInput === null) return;
      inputs.push(userInput);
    }
    
    executeCode(code, inputs);
  } else {
    const emptyInputCount = (code.match(/input\s*\(\s*\)/g) || []).length;
    if (emptyInputCount > 0) {
      const inputs = [];
      for (let i = 0; i < emptyInputCount; i++) {
        const userInput = prompt(`Input #${i + 1}: Enter value`);
        if (userInput === null) return;
        inputs.push(userInput);
      }
      executeCode(code, inputs);
    } else {
      executeCode(code, []);
    }
  }
}

function executeCode(code, inputs) {
  const output = document.getElementById("outputText");
  const plotPreview = document.getElementById("plotPreview");
  
  output.innerHTML = `‚è≥ Running... <span class="spinner"></span>`;
  plotPreview.innerHTML = "";

  fetch("{% url 'webprojects:run_python_code' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ 
      code: code,
      inputs: inputs
    })
  })
  .then(res => {
    if (!res.ok) {
      return res.text().then(text => { throw new Error(text); });
    }
    return res.json();
  })
  .then(data => {
    if (data.status === "error") {
      output.innerHTML = `<span style="color:red;">‚ùå ${escapeHTML(data.error || data.message)}</span>`;
      return;
    }

    output.textContent = data.output || "[No output]";

    plotPreview.innerHTML = "";
    if (Array.isArray(data.images) && data.images.length > 0) {
      data.images.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.style.maxWidth = "100%";
        img.style.marginBottom = "10px";
        plotPreview.appendChild(img);
      });
    }
  })
  .catch(err => {
    output.innerHTML = `<span style="color:red;">‚ùå Request Failed: ${escapeHTML(err.message)}</span>`;
  });
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggles = document.querySelectorAll('.folder-toggle');

  toggles.forEach(toggle => {
    const ext = toggle.dataset.ext;
    const storedState = localStorage.getItem('folder_' + ext);

    if (storedState === 'open') {
      toggle.classList.add('open');
      toggle.nextElementSibling.style.display = 'block';
    }

    toggle.addEventListener('click', () => {
      const group = toggle.nextElementSibling;
      const isOpen = toggle.classList.toggle('open');
      group.style.display = isOpen ? 'block' : 'none';
      localStorage.setItem('folder_' + ext, isOpen ? 'open' : 'closed');
    });
  });
});

function getSelectedText() {
  return editor.getModel().getValueInRange(editor.getSelection());
}

function insertAfterSelection(original, insertion) {
  const range = editor.getSelection();
  editor.executeEdits(null, [{
    range: range,
    text: original + "\n\n" + insertion,
    forceMoveMarkers: true
  }]);
}

function cleanAIResponse(text) {
  if (text.includes("```")) {
    const parts = text.split("```");
    if (parts.length >= 2) {
      return parts[1].replace(/^(\w+\n)?/, "").trim();
    }
  }
  return text.trim();
}





function showToast(message) {
  const toast = document.getElementById("toastMessage");
  toast.innerHTML = `
    <span>${message}</span>
    <button onclick="hideToast()" style="
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      position: absolute;
      right: 12px;
      top: 8px;
      cursor: pointer;
    ">&times;</button>
  `;
  toast.style.display = "block";
  toast.style.opacity = "1";
}

function hideToast() {
  const toast = document.getElementById("toastMessage");
  toast.style.opacity = "0";
  setTimeout(() => (toast.style.display = "none"), 500);
}


function runAIAction() {
  const selectedText = getSelectedText();
  const action = document.getElementById("aiAction").value;
  const loadingIndicator = document.getElementById("aiLoading");
  const runBtn = document.getElementById("runBtn");

  if (!selectedText.trim()) {
    return alert("‚ö†Ô∏è Please select code first.");
  }

  const instructions = {
    // complete: "Complete the following code:",
    explain: "Explain what this code does:",
    optimize: "Optimize this code for performance or readability:",
    comment: "Add detailed comments to the following code:",
    fix: "Fix any bugs or issues in this code:"
  };

  const prompt = instructions[action] + "\n\n" + selectedText;

  // Show loading
  loadingIndicator.style.display = "inline";
  runBtn.disabled = true;
  runBtn.textContent = "‚è≥ Running...";

  fetch("{% url 'webprojects:ai_suggest_code' %}", {
    method: "POST",
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ prompt: prompt })
  })
  .then(res => res.json())
  .then(data => {
    const output = cleanAIResponse(data.suggestion || "");
    insertAfterSelection(selectedText, output);
  })
  .catch(err => {
    alert("AI Action Failed: " + err);
  })
  .finally(() => {
    // Hide loading
    loadingIndicator.style.display = "none";
    runBtn.disabled = false;
    runBtn.textContent = "üöÄ Run AI Action";
  });
}


function createNewFolder() {
  const name = document.getElementById("newFolderName").value.trim();
  const projectId = {{ file.project.id }};

  if (!name) return alert("‚ö†Ô∏è Please enter a folder name");

  fetch(`/webprojects/${projectId}/create-folder/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      alert("‚úÖ Folder created!");
      location.reload(); // refresh to show the new folder
    } else {
      alert("‚ùå " + data.message);
    }
  })
  .catch(err => alert("‚ùå Request failed: " + err));
}

function createNewFile() {
  const name = document.getElementById("newFileName").value.trim();
  const projectId = {{ file.project.id }};

  if (!name) return alert("‚ö†Ô∏è Please enter a file name");

  fetch(`/webprojects/${projectId}/create-file/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      showToast(`‚úÖ File "${name}" created successfully!`);
      
      // Clear input
      document.getElementById("newFileName").value = "";
      
      // Add file to sidebar dynamically
      addNewFileToSidebar(data.file_id, name, projectId);
      
      // ‚úÖ REMOVED: No navigation, no reload
      // User can click the new file in the sidebar when they want to open it
      
    } else {
      alert("‚ùå " + data.message);
    }
  })
  .catch(err => alert("‚ùå Request failed: " + err));
}

function addNewFileToSidebar(fileId, fileName, projectId) {
  // Get file extension
  const ext = fileName.split('.').pop().toLowerCase();
  
  // Find the appropriate file group
  const folderToggles = document.querySelectorAll('.folder-toggle');
  let targetGroup = null;
  
  folderToggles.forEach(toggle => {
    if (toggle.dataset.ext === ext) {
      targetGroup = toggle.nextElementSibling;
      // Make sure the folder is open
      if (!toggle.classList.contains('open')) {
        toggle.classList.add('open');
        targetGroup.style.display = 'block';
        localStorage.setItem('folder_' + ext, 'open');
      }
    }
  });
  
  // If no group exists for this extension, create one
  if (!targetGroup) {
    const sidebar = document.querySelector('.sidebar');
    const modulesContainer = document.querySelector('.topics-container');
    
    // Create new folder toggle
    const newToggle = document.createElement('div');
    newToggle.className = 'folder-toggle open';
    newToggle.dataset.ext = ext;
    newToggle.innerHTML = `üìÅ ${ext.toUpperCase()} Files <span>‚Æü</span>`;
    
    // Create new file group
    const newGroup = document.createElement('div');
    newGroup.className = 'file-group';
    newGroup.style.display = 'block';
    
    // Insert before modules section
    if (modulesContainer) {
      const modulesParent = modulesContainer.parentElement;
      const h2 = modulesParent.querySelector('h2');
      if (h2) {
        modulesParent.insertBefore(newToggle, h2);
        modulesParent.insertBefore(newGroup, h2);
      }
    } else {
      sidebar.appendChild(newToggle);
      sidebar.appendChild(newGroup);
    }
    
    // Add click handler for toggle
    newToggle.addEventListener('click', () => {
      const group = newToggle.nextElementSibling;
      const isOpen = newToggle.classList.toggle('open');
      group.style.display = isOpen ? 'block' : 'none';
      localStorage.setItem('folder_' + ext, isOpen ? 'open' : 'closed');
    });
    
    targetGroup = newGroup;
  }
  
  // Create the file item
  const fileItem = document.createElement('div');
  fileItem.className = 'file-item';
  
  // Determine file type and create appropriate link
  // UPDATE THIS PART - use AJAX click handler
  const isImage = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext);
  const isExcel = ['xls', 'xlsx', 'csv'].includes(ext);
  
  if (isImage) {
    fileItem.innerHTML = `
      <a href="javascript:void(0);" style="color:#4fa;">üñºÔ∏è ${fileName}</a>
      <form method="POST" action="/webprojects/${projectId}/file/${fileId}/delete/" class="delete-file-form d-inline">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
      </form>
    `;
  } else {
    fileItem.innerHTML = `
      <a href="javascript:void(0);" 
         onclick="loadFile(${projectId}, ${fileId}, '${fileName}')"
         class="file-link"
         data-file-id="${fileId}">üìù ${fileName}</a>
      ${ext === 'html' ? `<a href="/webprojects/${projectId}/file/${fileId}/preview/" target="_blank" style="color: green;">publish</a>` : ''}
      ${isExcel ? `<a href="/webprojects/${projectId}/file/${fileId}/preview/" class="btn btn-sm">View</a>` : ''}
      <form method="POST" action="/webprojects/${projectId}/file/${fileId}/delete/" class="delete-file-form d-inline">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
      </form>
    `;
  }
  // Add to group
  targetGroup.appendChild(fileItem);
  
  // Attach delete handler
  const deleteForm = fileItem.querySelector('.delete-file-form');
  if (deleteForm) {
    deleteForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!confirm("Are you sure you want to delete this file?")) return;
      
      const url = deleteForm.getAttribute('action');
      const csrfToken = deleteForm.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          fileItem.remove();
          showToast('‚úÖ File deleted');
        } else {
          alert(data.message || 'Failed to delete file.');
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error deleting file.');
      });
    });
  }
  
  // Scroll to the new file
  fileItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  
  // Highlight the new file briefly
  fileItem.style.background = 'rgba(52, 152, 219, 0.3)';
  setTimeout(() => {
    fileItem.style.background = '';
  }, 2000);
}


</script>

<!-- uppload file js  -->
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '#333';
});

dropZone.addEventListener('dragleave', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '';
});

dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.style.backgroundColor = '';
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
});

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (file) uploadFile(file);
});

function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('name', file.name);

  const loader = document.getElementById("upload-loader");
  loader.style.display = "flex"; // show loader

  fetch("{% url 'webprojects:upload_file_ajax' project.id %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showToast(`‚úÖ Uploaded: ${file.name}`);
      addFileToList(data.file_id, file.name, data.file_url || "");

      // ‚úÖ reload after 1.5 seconds
      setTimeout(() => {
        location.reload();
      }, 1500);
    } else {
      showToast(`‚ùå Upload failed: ${data.error || ''}`);
    }
  })
  .catch(() => showToast("‚ö†Ô∏è Upload error"))
  .finally(() => {
    loader.style.display = "none"; // hide loader
  });
}


function addFileToList(fileId, fileName, fileUrl) {
  const ext = fileName.split('.').pop().toLowerCase();
  const groups = document.querySelectorAll('.file-group');

  groups.forEach(group => {
    if (group.previousElementSibling.dataset.ext === ext) {
      const div = document.createElement('div');
      div.classList.add('file-item');

      if (["png", "jpg", "jpeg", "gif", "svg", "webp"].includes(ext)) {
        div.innerHTML = `<a href="javascript:void(0);" onclick="showImageModal('${fileUrl}')" style="color:#4fa;">üñºÔ∏è ${fileName}</a>`;
      } 
      else if (["xls", "xlsx", "csv"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#f1c40f;">üìä ${fileName}</a>`;
      } 
      else if (["pdf"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#e74c3c;">üìÑ ${fileName}</a>`;
      } 
      else if (["doc", "docx"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#3498db;">üìë ${fileName}</a>`;
      } 
      else if (["txt", "md"].includes(ext)) {
        div.innerHTML = `<a href="${fileUrl}" target="_blank" style="color:#9b59b6;">üìù ${fileName}</a>`;
      } 
      else {
        div.innerHTML = `<a href="/file/${fileId}/" style="color:#fff;">üì¶ ${fileName}</a>`;
      }

      group.appendChild(div);
    }
  });
}

function showToast(message) {
  const toast = document.getElementById("toastMessage");
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 2500);
}
</script>


<!-- dragging output area js -->
 <script>
  const container = document.getElementById("container");
  const outputPanel = document.getElementById("outputPanel");
  const resizeHandle = document.getElementById("resizeHandle");

  let isDragging = false;
  let startY = 0;
  let startHeight = 0;

  resizeHandle.addEventListener("mousedown", (e) => {
    isDragging = true;
    startY = e.clientY;
    startHeight = outputPanel.offsetHeight;
    document.body.style.userSelect = "none"; // Prevent text selection
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    const dy = e.clientY - startY;
    const newHeight = Math.max(startHeight - dy, 100); // Minimum height
    outputPanel.style.height = `${newHeight}px`;
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
    document.body.style.userSelect = "";
  });

  // Touch support for mobile
  resizeHandle.addEventListener("touchstart", (e) => {
    isDragging = true;
    startY = e.touches[0].clientY;
    startHeight = outputPanel.offsetHeight;
  });

  document.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    const dy = e.touches[0].clientY - startY;
    const newHeight = Math.max(startHeight - dy, 100);
    outputPanel.style.height = `${newHeight}px`;
  });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });
</script>


{% endblock %}