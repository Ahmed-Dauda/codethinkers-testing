{% load static %}
{% block content %}

<style>
.dashboard-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.dashboard-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    background-color: #0056b3;
    color: #fff;
}

.dashboard-btn i { font-size: 1.1rem; }

body { background-color: #f4f6f8; font-family: "Segoe UI", Arial, sans-serif; margin: 0; padding: 0; }
.container-fluid { max-width: 1200px; margin: auto; padding: 20px; }
.card { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s ease-in-out; }
.card:hover { transform: translateY(-3px); }
.card-header { background-color: #007bff; color: #fff; font-weight: 600; padding: 12px 15px; border-radius: 8px 8px 0 0; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
thead { background-color: #f0f2f5; }
tr:hover { background-color: #fafafa; }
.badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; }
.bg-success { background-color: #28a745; color: #fff; }
.text-primary { color: #007bff; }
.text-muted { color: #6c757d; }
.fw-bold { font-weight: bold; }
.row { display: flex; flex-wrap: wrap; gap: 20px; }
.col-md-4, .col-md-6 { flex: 1; min-width: 250px; }
.online-dot { height: 10px; width: 10px; background: #4CAF50; border-radius: 50%; display: inline-block; margin-left: 8px; }
canvas { width: 100% !important; height: 300px !important; }
</style>

<div class="container-fluid mt-4">

    <!-- Quick Link -->
    <div class="mb-4">
        <a href="{% url 'quiz:ai_assessment_selector' %}" class="btn btn-primary dashboard-btn">
            <i class="fas fa-robot me-2"></i> Go to AI Assessment Selector
        </a>
    </div>

    <!-- Payment Stats -->
    <div class="card mb-4">
        <div class="card-header">Payment Statistics</div>
        <div class="table-responsive p-2">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Total Amount (₦)</th>
                        <th>Transactions</th>
                        <th>Month Total (₦)</th>
                        <th>Year Total (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>General Course Payments</td>
                        <td>{{ payment_stats.general.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.general.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.general.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.general.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Ebooks Payments</td>
                        <td>{{ payment_stats.ebooks.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.ebooks.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.ebooks.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.ebooks.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Certificate Payments</td>
                        <td>{{ payment_stats.certificates.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.certificates.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.certificates.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.certificates.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Document Payments</td>
                        <td>{{ payment_stats.documents.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.documents.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.documents.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.documents.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr class="table-info fw-bold">
                        <td>Total Earnings This Month</td>
                        <td colspan="4">₦{{ total_month|floatformat:2 }}</td>
                    </tr>
                    <tr class="table-warning fw-bold">
                        <td>Total Earnings This Year</td>
                        <td colspan="4">₦{{ total_year|floatformat:2 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Online Users -->
    <div class="card mb-4">
        <div class="card-header">Currently Online</div>
        <ul id="online-users-list" class="list-group list-group-flush">
            {% for user in online_users %}
                <li class="list-group-item">
                    {{ user.username|default:user.email }}
                    <span class="online-dot"></span>
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No users online</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Quick Stats Cards -->
    <h2 class="mb-3 fw-bold text-primary">Quick Dashboard</h2>
    <div class="row">
        <div class="col-md-4">
            <div class="card text-center">
                <h6 class="text-muted">Total Students</h6>
                <h3 class="fw-bold text-primary">{{ total_students }}</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <h6 class="text-muted">Total Courses</h6>
                <h3 class="fw-bold text-primary">{{ total_courses }}</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <h6 class="text-muted">Active Schools</h6>
                <h3 class="fw-bold text-primary">{{ active_schools }}</h3>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card text-center">
                <h6 class="text-muted">Quizzes Today</h6>
                <h3 class="fw-bold text-primary">{{ quizzes_today }}</h3>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card text-center">
                <h6 class="text-muted">Average Score</h6>
                <h3 class="fw-bold text-primary">{{ avg_score|default:"0"|floatformat:2 }}</h3>
            </div>
        </div>
    </div>

    <!-- Top Certificate Downloads -->
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">Top Certificate Downloads</div>
        <div class="card-body">
            {% if course_downloads %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Downloads</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in course_downloads %}
                                <tr>
                                    <td>{{ c.certificate__title }}</td>
                                    <td><span class="badge bg-success">{{ c.total_downloads }}</span></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-0">No downloads yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Top Badge Downloads -->
    <div class="card mt-4">
        <div class="card-header bg-success text-white">Top Badge Downloads</div>
        <div class="card-body">
            {% if badge_downloads %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Total Downloads</th>
                                <th>Gold</th>
                                <th>Silver</th>
                                <th>Bronze</th>
                                <th>Participant</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in badge_downloads %}
                                <tr>
                                    <td>{{ b.course_name }}</td>
                                    <td><span class="badge bg-success">{{ b.total_downloads }}</span></td>
                                    <td><span class="badge bg-warning text-dark">{{ b.gold_downloads }}</span></td>
                                    <td><span class="badge bg-secondary text-white">{{ b.silver_downloads }}</span></td>
                                    <td><span class="badge bg-danger">{{ b.bronze_downloads }}</span></td>
                                    <td><span class="badge bg-primary">{{ b.participant_downloads }}</span></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-0">No badge downloads yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Top Students -->
    <div class="card mt-4">
        <div class="card-header">Top Students</div>
        <div class="card-body table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Average Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in top_students %}
                        <tr>
                            <td>{{ student.student__username }}</td>
                            <td>{{ student.avg_score|floatformat:2 }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="2" class="text-center text-muted">No data available</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
function fetchOnlineUsers() {
    fetch("{% url 'users:online_users_api' %}")
        .then(response => response.json())
        .then(data => {
            let list = document.getElementById('online-users-list');
            list.innerHTML = '';
            if (data.users.length > 0) {
                data.users.forEach(user => {
                    let li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `${user.username || user.email} <span class="online-dot"></span>`;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<li class="list-group-item text-muted">No users online</li>';
            }
        });
}

setInterval(fetchOnlineUsers, 5000);
</script>

{% endblock %}
