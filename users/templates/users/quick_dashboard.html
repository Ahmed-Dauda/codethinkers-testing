{% load static %}

{% block content %}

<style>
    body {
        background-color: #f4f6f8;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    h2, h5, h6 {
        margin: 0;
    }

    .container-fluid {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
    }

    /* Card Styles */
    .card {
        background: #fff;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.06);
        transition: transform 0.2s ease-in-out;
    }
    .card:hover {
        transform: translateY(-2px);
    }

    .card-header {
        background: #007bff;
        color: #fff;
        padding: 12px 15px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
    }

    /* Table Styling */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    thead {
        background-color: #f0f2f5;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    tr:hover {
        background-color: #fafafa;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    .bg-success {
        background-color: #28a745;
        color: #fff;
    }

    /* Grid Layout */
    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }
    .col-md-4, .col-md-6 {
        flex: 1;
        min-width: 250px;
    }

    /* Text Colors */
    .text-primary {
        color: #007bff;
    }
    .text-muted {
        color: #6c757d;
    }

    /* Chart Container */
    canvas {
        width: 100% !important;
        height: 300px !important;
    }
</style>

<div class="container-fluid mt-4">
<a href="{% url 'quiz:ai_assessment_selector' %}">Go to AI Assessment Selector</a>

    <!-- Payment Stats Table -->
    <div class="card shadow-sm p-3 border-0">
        <div class="table-responsive">
            <table id="payment-stats-table" class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Type</th>
                        <th>Total Amount (₦)</th>
                        <th>Transactions</th>
                        <th>Month Total (₦)</th>
                        <th>Year Total (₦)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>General Course Payments</td>
                        <td>{{ payment_stats.general.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.general.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.general.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.general.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Ebooks Payments</td>
                        <td>{{ payment_stats.ebooks.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.ebooks.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.ebooks.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.ebooks.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Certificate Payments</td>
                        <td>{{ payment_stats.certificates.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.certificates.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.certificates.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.certificates.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Document Payments</td>
                        <td>{{ payment_stats.documents.all_time_amount|default:0|floatformat:2 }}</td>
                        <td>{{ payment_stats.documents.all_time_count|default:0 }}</td>
                        <td>{{ payment_stats.documents.month_total|floatformat:2 }}</td>
                        <td>{{ payment_stats.documents.year_total|floatformat:2 }}</td>
                    </tr>
                    <tr class="table-info fw-bold">
                        <td>Total Earnings This Month</td>
                        <td colspan="4">₦{{ total_month|floatformat:2 }}</td>
                    </tr>
                    <tr class="table-warning fw-bold">
                        <td>Total Earnings This Year</td>
                        <td colspan="4">₦{{ total_year|floatformat:2 }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>



    <!-- Online Users -->
    <div class="card shadow-sm p-3 mt-4">
        <h5 class="fw-bold">Currently Online</h5>
        <ul id="online-users-list" class="list-group list-group-flush">
            {% for user in online_users %}
                <li class="list-group-item">
                    {{ user.username|default:user.email }}
                    <span style="height:10px;width:10px;background:#4CAF50;border-radius:50%;display:inline-block;margin-left:5px;"></span>
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No users online</li>
            {% endfor %}
        </ul>
    </div>

    <h2 class="mb-4 fw-bold text-primary">Quick Dashboard</h2>

    <!-- Top Certificate Downloads -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Top Certificate Downloads</h5>
        </div>
        <div class="card-body">
            {% if course_downloads %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Course</th>
                                <th>Downloads</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in course_downloads %}
                                <tr>
                                    <td>{{ c.certificate__title }}</td>
                                    <td><span class="badge bg-success">{{ c.total_downloads }}</span></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted mb-0">No downloads yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card shadow-sm text-center p-3 border-0">
                <h6 class="text-muted">Total Students</h6>
                <h3 class="fw-bold text-primary">{{ total_students }}</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm text-center p-3 border-0">
                <h6 class="text-muted">Total Courses</h6>
                <h3 class="fw-bold text-primary">{{ total_courses }}</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm text-center p-3 border-0">
                <h6 class="text-muted">Active Schools</h6>
                <h3 class="fw-bold text-primary">{{ active_schools }}</h3>
            </div>
        </div>
    </div>

    <!-- More Stats -->
    <div class="row g-3 mt-1">
        <div class="col-md-6">
            <div class="card shadow-sm text-center p-3 border-0">
                <h6 class="text-muted">Quizzes Today</h6>
                <h3 class="fw-bold text-primary">{{ quizzes_today }}</h3>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm text-center p-3 border-0">
                <h6 class="text-muted">Average Score</h6>
                <h3 class="fw-bold text-primary">
                    {% if avg_score %}{{ avg_score|floatformat:2 }}{% else %}0{% endif %}
                </h3>
            </div>
        </div>
    </div>

    <!-- Top Students -->
    <div class="card shadow-sm p-3 mt-4">
        <h5 class="fw-bold">Top Students</h5>
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Username</th>
                        <th>Average Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in top_students %}
                        <tr>
                            <td>{{ student.student__username }}</td>
                            <td>{{ student.avg_score|floatformat:2 }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="2" class="text-center text-muted">No data available</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- AJAX script to refresh online users -->
<script>
    function fetchOnlineUsers() {
        fetch("{% url 'users:online_users_api' %}")  // This should be your API endpoint
            .then(response => response.json())
            .then(data => {
                let list = document.getElementById('online-users-list');
                list.innerHTML = '';
                if (data.users.length > 0) {
                    data.users.forEach(user => {
                        let li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `${user.username || user.email} 
                            <span style="height:10px;width:10px;background:#4CAF50;border-radius:50%;display:inline-block;margin-left:5px;"></span>`;
                        list.appendChild(li);
                    });
                } else {
                    list.innerHTML = '<li class="list-group-item text-muted">No users online</li>';
                }
            });
    }

    // Refresh every 5 seconds
    setInterval(fetchOnlineUsers, 5000);
</script>

{% endblock %}
